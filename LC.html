<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprensi√≥n Literal - Sk√≥pia</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Roboto:wght@400;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBGEwwuGLP0ULmsJkAhwwmNSlWAotGu_wY",
            projectId: "skopia-aa786",
            storageBucket: "skopia-aa786.firebasestorage.app",
            messagingSenderId: "719823055099",
            appId: "1:719823055099:web:7d91ea29e4b2dcbb9b685e"
        };

        if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
            firebaseConfig.authDomain = "localhost";
        } else {
            firebaseConfig.authDomain = "skopia-aa786.firebaseapp.com";
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.auth = auth; // Exponer globalmente

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            console.log("Usuario autenticado:", user.email, "DisplayName:", user.displayName);
            window.dispatchEvent(new CustomEvent('userReady', { detail: { user } }));
        });
    </script>

    <style>
        :root {
            --color-crema: #fdfbf5;
            --color-oliva-claro: #bec092;
            --color-oliva-medio: #5a6133;
            --color-oliva-oscuro: #272b00;
            --color-sombra: rgba(39, 43, 0, 0.1);
            --float-color: var(--color-oliva-oscuro);
            --float-color-hover: var(--color-oliva-medio);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: linear-gradient(135deg, var(--color-crema) 0%, #f5efe5 100%); color: var(--color-oliva-oscuro); min-height: 100vh; display: flex; flex-direction: column; }
        
        /* Navbar, Hero, Main Content, etc. (sin cambios) */
        .navbar { display: flex; justify-content: flex-end; align-items: center; padding: 15px 40px; background-color: white; box-shadow: 0 2px 10px var(--color-sombra); }
        .hamburger { width: 30px; height: 25px; position: relative; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; }
        .hamburger span { display: block; height: 4px; width: 100%; background-color: var(--color-oliva-oscuro); border-radius: 2px; transition: all 0.3s ease-in-out; }
        .user-dropdown { position: absolute; top: 70px; right: 40px; background-color: white; border-radius: 8px; box-shadow: 0 4px 20px var(--color-sombra); overflow: hidden; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: opacity 0.3s, transform 0.3s, visibility 0.3s; z-index: 1000; }
        .user-dropdown.active { opacity: 1; visibility: visible; transform: translateY(0); }
        .user-dropdown a { display: block; padding: 15px 25px; text-decoration: none; color: var(--color-oliva-oscuro); font-weight: 500; transition: background-color 0.2s; }
        .user-dropdown a:hover { background-color: var(--color-crema); }
        .user-dropdown hr { border: none; border-top: 1px solid #eee; margin: 0; }

        .hero-section { text-align: center; padding: 40px 20px; }
        .logo-centro { display: block; margin: 0 auto 20px auto; height: 150px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .digital-clock { font-family: 'Orbitron', sans-serif; font-size: 5rem; font-weight: 700; color: black; letter-spacing: 5px; text-shadow: 0 0 10px rgba(0,0,0,0.1); transition: color 0.3s ease; }
        .digital-clock.hour-change { color: var(--color-oliva-medio); }
        .motivational-quote { font-family: 'Patrick Hand', cursive; font-size: 1.8rem; color: var(--color-oliva-medio); margin-top: 20px; max-width: 800px; margin-left: auto; margin-right: auto; min-height: 50px; opacity: 0; animation: fadeIn 1s forwards; }
        .bienvenida { font-family: 'Patrick Hand', cursive; font-size: 2.2rem; color: var(--color-oliva-oscuro); margin-top: 25px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        @keyframes fadeIn { to { opacity: 1; } }

        .main-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px 40px 40px; position: relative; }
        .close-btn { position: absolute; top: 20px; left: 20px; background: var(--color-oliva-oscuro); color: white; width: 40px; height: 40px; border-radius: 50%; border: none; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s, background-color 0.2s; z-index: 100; }
        .close-btn:hover { transform: scale(1.1); background-color: var(--color-oliva-medio); }

        .video-container { width: 100%; max-width: 800px; background: white; border-radius: 16px; padding: 30px; box-shadow: 0 8px 25px var(--color-sombra); margin-bottom: 30px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .video-container h2 { font-family: 'Patrick Hand', cursive; font-size: 2.2rem; color: var(--color-oliva-oscuro); margin-bottom: 20px; }
        .video-wrapper { width: 100%; position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; background-color: #000; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 12px; }
        .skip-video-btn { margin-top: 20px; background-color: var(--color-oliva-oscuro); color: var(--color-crema); border: none; padding: 12px 25px; border-radius: 30px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        .skip-video-btn:hover { background-color: var(--color-oliva-medio); transform: scale(1.05); }

        .lesson-container { width: 100%; max-width: 800px; background: white; border-radius: 16px; padding: 40px; box-shadow: 0 8px 25px var(--color-sombra); display: none; }
        .lesson-container.active { display: block; }
        .lesson-header { text-align: center; margin-bottom: 30px; }
        .lesson-header h2 { font-family: 'Patrick Hand', cursive; font-size: 2.5rem; color: var(--color-oliva-oscuro); margin-bottom: 10px; }
        .lesson-content { margin-bottom: 30px; }
        .lesson-section { margin-bottom: 30px; }
        .lesson-section h3 { font-family: 'Patrick Hand', cursive; font-size: 1.8rem; color: var(--color-oliva-medio); margin-bottom: 15px; }
        .lesson-section p { font-size: 1.1rem; line-height: 1.6; color: var(--color-oliva-oscuro); margin-bottom: 15px; }
        .example-box { background-color: var(--color-crema); border-left: 5px solid var(--color-oliva-medio); padding: 20px; border-radius: 8px; margin: 20px 0; }
        .example-box h4 { font-family: 'Patrick Hand', cursive; font-size: 1.5rem; color: var(--color-oliva-oscuro); margin-bottom: 10px; }
        .play-btn { display: block; margin: 30px auto 0; background-color: var(--color-oliva-oscuro); color: var(--color-crema); border: none; padding: 15px 40px; border-radius: 30px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        .play-btn:hover { background-color: var(--color-oliva-medio); transform: scale(1.05); }

        .mascota-container { display: flex; align-items: center; justify-content: center; gap: 15px; position: relative; width: 300px; margin-top: 30px; }
        .mascota-img { width: 100%; max-width: 220px; height: auto; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2)); }
        .speech-bubble { position: static; border: 2px solid var(--color-oliva-claro); border-radius: 20px; padding: 15px 20px; background: white; box-shadow: 0 5px 15px var(--color-sombra); }
        .speech-bubble p { font-family: 'Patrick Hand', cursive; font-size: 1.1rem; margin: 0; }

        .floating-icons { position: fixed; right: 20px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 12px; z-index: 2000; }
        .floating-icons button { background: var(--float-color); color: white; width: 54px; height: 54px; border-radius: 50%; border: none; font-size: 20px; display: grid; place-items: center; box-shadow: 0 6px 18px rgba(0,0,0,0.12); cursor: pointer; transition: transform .15s ease, background .15s ease; }
        .floating-icons button:hover { transform: scale(1.08); background: var(--float-color-hover); }

        .panel-box { position: fixed; right: 90px; top: 50%; transform: translateY(-50%); width: 420px; max-height: 75vh; background: white; border-radius: 12px; box-shadow: 0 12px 40px rgba(0,0,0,0.12); overflow: auto; padding: 24px; z-index: 2100; display: none; font-family: 'Patrick Hand', cursive; font-size: 1.2rem; }
        .panel-box.active { display: block; }
        .panel-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .panel-header h3 { margin:0; font-size:1.6rem; color:var(--color-oliva-oscuro); }
        .close-panel { background:none; border:none; font-size:1.4rem; cursor:pointer; color:var(--color-oliva-medio); }

        .mission-row { padding:12px; border-radius:8px; margin-bottom:10px; background:#fffaf0; box-shadow: 0 2px 6px rgba(0,0,0,0.04); display:flex; justify-content:space-between; align-items:center; }
        .mission-row.completed { opacity:0.6; text-decoration:line-through; background:#f0fff4; }

        .toast { position: fixed; right: 20px; bottom: 20px; background: #fff7e6; border-left: 6px solid var(--color-oliva-medio); padding: 16px 20px; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); z-index: 3000; display: none; font-size: 1.1rem; max-width: 400px; }
        .toast.show { display: block; }
        .info { font-family: 'Roboto', sans-serif; color:var(--color-oliva-oscuro); font-size:1.1rem; margin-bottom:12px; }

        @media (max-width: 1024px) { .main-content { padding: 20px; } .video-container, .lesson-container { padding: 20px; } .panel-box { right: 10px; width: 92%; top: 55%; transform: translateY(-55%); } .floating-icons { right: 10px; } }
    </style>
     <script type="module" src="./global-settings.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="hamburger" id="hamburger-menu"><span></span><span></span><span></span></div>
        <div class="user-dropdown" id="user-dropdown">
            <a href="cuenta.html">Mi Cuenta</a>
            <a href="configuracion.html">Configuraci√≥n</a>
            <a href="notificaciones.html">Notificaciones</a>
            <hr>
            <a href="index.html" id="logout-btn">Cerrar Sesi√≥n</a>
        </div>
    </nav>

    <section class="hero-section">
        <div id="digital-clock" class="digital-clock">00:00:00</div>
        <p id="motivational-quote" class="motivational-quote"></p>
        <h2 class="bienvenida">Bienvenido a tu ruta de Lectura Cr√≠tica!</h2>
    </section>

    <main class="main-content">
        <button class="close-btn" id="close-btn" title="Volver a m√≥dulos">&times;</button>
        
        <div class="video-container" id="video-container">
            <h2>Tutorial de Uso</h2>
            <div class="video-wrapper">
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: white; font-size: 1.2rem;">
                    <p>Aqu√≠ se mostrar√° el video tutorial<br>(Inserta el iframe del video en el c√≥digo)</p>
                </div>
            </div>
            <button class="skip-video-btn" id="skip-video-btn">Saltar Video</button>
        </div>
        
        <div class="lesson-container" id="lesson-container">
            <div class="lesson-header"><h2>Comprensi√≥n Literal</h2></div>
            <div class="lesson-content">
                <div class="lesson-section">
                    <h3>¬øQu√© es la Comprensi√≥n Literal?</h3>
                    <p>La comprensi√≥n literal es el nivel m√°s b√°sico de lectura y se enfoca en entender lo que el texto dice directamente. Es la capacidad de identificar y recordar la informaci√≥n expl√≠cita presentada por el autor.</p>
                    <p>En un examen, esto significa que la respuesta a la pregunta est√° tal cual o parafraseada de forma sencilla en el texto. Buscas datos, hechos, secuencias de eventos, definiciones o ideas principales que no requieren inferencia ni interpretaci√≥n profunda. Simplemente, es reconocer el mensaje manifiesto del escrito.</p>
                </div>
                <div class="lesson-section">
                    <h3>Ejemplo Pr√°ctico</h3>
                    <div class="example-box">
                        <h4>Ejemplo:</h4>
                        <p>"El proceso de fotos√≠ntesis, esencial para la vida vegetal, requiere de tres elementos fundamentales: agua, di√≥xido de carbono y luz solar. Durante esta reacci√≥n qu√≠mica, las plantas absorben el di√≥xido de carbono del aire y el agua a trav√©s de sus ra√≠ces para transformarlos, utilizando la energ√≠a de la luz, en glucosa (su alimento) y ox√≠geno, el cual es liberado al ambiente."</p>
                        <p>Pregunta literal: Seg√∫n el texto, ¬øcu√°les son los tres elementos fundamentales que requiere el proceso de fotos√≠ntesis?</p>
                        <p>Respuesta: El agua, el di√≥xido de carbono y la luz solar.</p>
                         <p>An√°lisis: Esta es una pregunta de comprensi√≥n literal pura porque la respuesta se encuentra exactamente en la primera frase del texto. No necesitas inferir, interpretar o analizar una met√°fora; solo debes identificar y extraer la informaci√≥n tal como la presenta el autor.</p>
                    </div>
                </div>
            </div>
            <button class="play-btn" id="play-btn">Jugar</button>
        </div>

        <aside class="mascota-container">
            <div class="speech-bubble"><p>Aprende sobre la comprensi√≥n literal</p></div>
        </aside>
    </main>

    <div class="floating-icons" aria-hidden="false">
        <button id="btn-misiones" title="Misiones">üéØ</button>
        <button id="btn-nivel" title="Nivel actual">‚≠ê</button>
        <button id="btn-progreso" title="Progreso">üìä</button>
        <button id="btn-analisis" title="An√°lisis">üìà</button>
    </div>

    <div class="panel-box" id="panel-misiones" aria-hidden="true">
        <div class="panel-header"><h3>Misiones</h3><button class="close-panel" data-close="misiones">&times;</button></div>
        <div id="misiones-content"></div>
    </div>
    <div class="panel-box" id="panel-nivel" aria-hidden="true">
        <div class="panel-header"><h3>Tu nivel</h3><button class="close-panel" data-close="nivel">&times;</button></div>
        <div id="nivel-content"></div>
    </div>
    <div class="panel-box" id="panel-progreso" aria-hidden="true">
        <div class="panel-header"><h3>Progreso</h3><button class="close-panel" data-close="progreso">&times;</button></div>
        <div id="progreso-content"></div>
    </div>
    <div class="panel-box" id="panel-analisis" aria-hidden="true">
        <div class="panel-header"><h3>An√°lisis (promedio 0‚Äì300)</h3><button class="close-panel" data-close="analisis">&times;</button></div>
        <div id="analisis-content"><div id="analisis-stats" style="margin-top:12px;"></div></div>
    </div>

    <div class="toast" id="mission-toast" role="status" aria-live="polite"></div>
    <audio id="mission-sound" src="mission.mp3" preload="auto"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Cargado. Inicializando Sk√≥pia...");

            // --- CONSTANTES Y VARIABLES ---
            const MISSIONS_KEY = 'skopia_missions_v1';
            const USER_PROFILE_KEY = 'skopia_user_profile_v1';
            let toastTimer = null;
            
            // Variables para el temporizador de la misi√≥n 3
            let missionTimerInterval = null;
            let totalActiveTime = 0;
            const MISSION_3_DURATION = 120000; // 2 minutos en milisegundos

            const missionsTemplate = [
                { id: 1, title: "Completa tu primer examen", points: 50 },
                { id: 2, title: "Logra al menos 180/300 en un examen", points: 80 },
                { id: 3, title: "Lee toda la teor√≠a de una lecci√≥n", points: 40 },
                { id: 4, title: "Termina una sesi√≥n de estudio sin salir", points: 50 },
                { id: 5, title: "Gana tu primer juego", points: 50 },
                { id: 6, title: "Usa una pista o ayuda en un juego", points: 30 },
                { id: 7, title: "Repite un examen para mejorar tu nota", points: 50 },
                { id: 8, title: "Cambia tu nombre de usuario", points: 40 },
                { id: 9, title: "Acumula tus primeras 200 estrellas", points: 30 },
                { id: 10, title: "Completa 3 misiones seguidas", points: 50 },
                { id: 11, title: "Logra 240/300 en un examen", points: 150 },
                { id: 12, title: "Completa un examen sin errores (300/300)", points: 200 },
                { id: 100, title: "üèÜ Maestro del Saber Pro: completa todo el sistema", points: 200 }
            ];

            const LEVELS = [
                { idx: 1, name: "Novato/a", min: 0, max: 299 }, { idx: 2, name: "Aprendiz/a", min: 300, max: 799 },
                { idx: 3, name: "Explorador/a", min: 800, max: 1499 }, { idx: 4, name: "Analista", min: 1500, max: 2499 },
                { idx: 5, name: "Estratega", min: 2500, max: 3699 }, { idx: 6, name: "Sabio/a", min: 3700, max: 4999 },
                { idx: 7, name: "Maestro/a", min: 5000, max: 6499 }, { idx: 8, name: "√âlite", min: 6500, max: 7999 },
                { idx: 9, name: "Leyenda", min: 8000, max: 9499 }, { idx: 10, name: "Rey/Reina Sk√≥pia", min: 9500, max: Infinity }
            ];

            // --- FUNCIONES PRINCIPALES ---

            function initMissions() {
                if (!localStorage.getItem(MISSIONS_KEY)) {
                    const initial = missionsTemplate.map(m => ({ ...m, completed: false }));
                    localStorage.setItem(MISSIONS_KEY, JSON.stringify(initial));
                    console.log("Misiones inicializadas.");
                }
            }
            function initUserProfile() {
                if (!localStorage.getItem(USER_PROFILE_KEY)) {
                    const initial = { originalEmail: "", nameChangeMissionCompleted: false };
                    localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(initial));
                }
            }

            function completeMission(id) {
                console.log(`>>> Llamada a completeMission con ID: ${id}`);
                const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
                const mission = data.find(m => m.id === id);
                if (mission && !mission.completed) {
                    mission.completed = true;
                    localStorage.setItem(MISSIONS_KEY, JSON.stringify(data));
                    console.log(`!!! MISI√ìN COMPLETADA: ID=${id}, Titulo="${mission.title}", Puntos=${mission.points} !!!`);
                    
                    document.getElementById('mission-sound').play().catch(e => console.log("Error al reproducir sonido:", e));
                    showMissionToast(`¬°Misi√≥n completada: ${mission.title} (+${mission.points}‚≠ê)!`, 5000);
                    updateAllDisplays();
                    showNextMissionNotification();
                } else {
                    console.log(`>>> Misi√≥n ${id} ya estaba completada o no existe.`);
                }
            }

            function showNextMissionNotification() {
                const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
                const nextMission = data.find(m => !m.completed);
                if (nextMission) {
                    setTimeout(() => {
                        showMissionToast(`Nueva misi√≥n disponible: ${nextMission.title} (+${nextMission.points}‚≠ê)`, 8000);
                    }, 5500);
                }
            }

            function showMissionToast(text, ms = 60000) {
                const toast = document.getElementById('mission-toast');
                toast.innerHTML = `<strong>${text}</strong>`;
                toast.classList.add('show');
                if (toastTimer) clearTimeout(toastTimer);
                toastTimer = setTimeout(() => toast.classList.remove('show'), ms);
            }

            function getTotalPoints() {
                const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
                return data.reduce((sum, m) => sum + (m.completed ? m.points : 0), 0);
            }
            function getLevelFromPoints(total) {
                for (let i = LEVELS.length - 1; i >= 0; i--) if (total >= LEVELS[i].min) return LEVELS[i];
                return LEVELS[0];
            }
            function getCompletedCount() {
                return JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]").filter(m => m.completed).length;
            }

            // --- RENDER FUNCTIONS ---
            function renderMissions() {
                const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
                const container = document.getElementById('misiones-content');
                container.innerHTML = '';
                const incompleteMissions = data.filter(m => !m.completed).slice(0, 3);
                if (incompleteMissions.length === 0) {
                    container.innerHTML = '<div class="info">¬°Felicidades! Has completado todas las misiones.</div>';
                    return;
                }
                incompleteMissions.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'mission-row';
                    div.innerHTML = `<div style="flex:1"><div style="font-weight:700; color:var(--color-oliva-oscuro)">${m.id}. ${m.title}</div><div style="font-size:1rem; color:#556b2f">${m.points} ‚≠ê</div></div>`;
                    container.appendChild(div);
                });
            }
            function renderLevel() {
                const total = getTotalPoints();
                const level = getLevelFromPoints(total);
                const neededForNext = (level.max === Infinity) ? 0 : (level.max - total + 1);
                const progressPct = (level.max === Infinity) ? 100 : Math.min(100, Math.round(((total - level.min) / (level.max - level.min)) * 100));
                document.getElementById('nivel-content').innerHTML = `
                    <div class="info"><strong>Nivel:</strong> ${level.name} (${level.idx})</div>
                    <div class="info"><strong>Puntos:</strong> ${total} ‚≠ê</div>
                    <div class="info"><strong>Progreso:</strong> ${progressPct}%</div>
                    <div style="background:#f1f1f1;border-radius:10px;padding:8px;margin-top:10px"><div style="height:12px;background:linear-gradient(90deg,var(--color-oliva-medio),#bdbd74);width:${progressPct}%;border-radius:8px"></div></div>
                    ${level.max === Infinity ? '<div class="info" style="margin-top:8px">¬°Nivel m√°ximo!</div>' : `<div class="info" style="margin-top:8px">Para subir: ${neededForNext} ‚≠ê</div>`}
                `;
            }
            function renderProgress() {
                const total = getTotalPoints();
                const topTarget = 9500;
                const pct = Math.min(100, Math.round((total / topTarget) * 100));
                document.getElementById('progreso-content').innerHTML = `
                    <div class="info"><strong>Puntos:</strong> ${total} ‚≠ê</div>
                    <div class="info"><strong>Progreso Global:</strong> ${pct}%</div>
                    <div style="background:#f1f1f1;border-radius:10px;padding:8px;margin-top:10px"><div style="height:12px;background:linear-gradient(90deg,var(--color-oliva-medio),#bdbd74);width:${pct}%;border-radius:8px"></div></div>
                    <div class="info" style="margin-top:10px"><strong>Misiones:</strong> ${getCompletedCount()}/100</div>
                `;
            }
            function renderAnalysis() {
                document.getElementById('analisis-stats').innerHTML = '<div class="info">An√°lisis de ex√°menes (pendiente de implementar).</div>';
            }
            function updateAllDisplays() {
                renderMissions(); renderLevel(); renderProgress(); renderAnalysis();
            }
            function closeAllPanels() {
                document.querySelectorAll('.panel-box').forEach(p => p.classList.remove('active'));
            }

            // --- L√ìGICA DE MISI√ìN 3 (TEMPORIZADOR MEJORADO) ---
            function startMissionTimer() {
                console.log("Iniciando temporizador para la misi√≥n 3...");
                totalActiveTime = 0;
                if (missionTimerInterval) clearInterval(missionTimerInterval);

                missionTimerInterval = setInterval(() => {
                    if (!document.hidden) {
                        totalActiveTime += 1000;
                        console.log(`Tiempo activo en lecci√≥n: ${totalActiveTime / 1000}s / ${MISSION_3_DURATION / 1000}s`);
                        if (totalActiveTime >= MISSION_3_DURATION) {
                            completeMission(3);
                            clearInterval(missionTimerInterval);
                            missionTimerInterval = null;
                        }
                    }
                }, 1000);
            }

            // --- EVENT LISTENERS ---
            window.addEventListener('userReady', (e) => {
                const user = e.detail.user;
                console.log("Evento 'userReady' recibido para:", user.email);
                const userProfile = JSON.parse(localStorage.getItem(USER_PROFILE_KEY) || "{}");

                // Inicializar perfil si es la primera vez que se loguea
                if (!userProfile.originalEmail) {
                    userProfile.originalEmail = user.email;
                    userProfile.nameChangeMissionCompleted = false;
                    localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(userProfile));
                    console.log("Perfil de usuario inicializado por primera vez. Email original guardado:", userProfile.originalEmail);
                }

                // Comprobar la misi√≥n de cambiar nombre SOLO si no se ha completado
                if (!userProfile.nameChangeMissionCompleted) {
                    console.log("Comprobando misi√≥n 8 (cambiar nombre)...");
                    const hasChangedName = user.displayName && user.displayName !== userProfile.originalEmail;
                    if (hasChangedName) {
                        console.log(`¬°Cambio de nombre detectado! Original: "${userProfile.originalEmail}", Nuevo: "${user.displayName}". Completando misi√≥n 8.`);
                        completeMission(8);
                        userProfile.nameChangeMissionCompleted = true;
                        localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(userProfile));
                    } else {
                        console.log("No se detect√≥ cambio de nombre. DisplayName actual:", user.displayName);
                    }
                } else {
                    console.log("Misi√≥n 8 ya fue completada anteriormente.");
                }
            });

            document.getElementById('hamburger-menu').addEventListener('click', () => {
                document.getElementById('user-dropdown').classList.toggle('active');
            });
            document.getElementById('logout-btn').addEventListener('click', () => {
                import("https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js").then(({ signOut }) => {
                    signOut(window.auth).then(() => window.location.href = 'index.html');
                });
            });
            window.addEventListener('click', (event) => {
                if (!event.target.closest('.navbar')) document.getElementById('user-dropdown').classList.remove('active');
                const isIcon = event.target.closest('.floating-icons');
                const isPanel = event.target.closest('.panel-box');
                if (!isIcon && !isPanel) closeAllPanels();
            });
            document.getElementById('close-btn').addEventListener('click', () => window.location.href = 'modulos.html');
            document.getElementById('skip-video-btn').addEventListener('click', () => {
                document.getElementById('video-container').style.display = 'none';
                document.getElementById('lesson-container').classList.add('active');
                startMissionTimer();
            });
            document.getElementById('play-btn').addEventListener('click', () => window.location.href = 'juego1.html');

            // **EVENT LISTENERS DE ICONOS (FUNCIONANDO)**
            document.getElementById('btn-misiones').addEventListener('click', () => { closeAllPanels(); document.getElementById('panel-misiones').classList.add('active'); renderMissions(); });
            document.getElementById('btn-nivel').addEventListener('click', () => { closeAllPanels(); document.getElementById('panel-nivel').classList.add('active'); renderLevel(); });
            document.getElementById('btn-progreso').addEventListener('click', () => { closeAllPanels(); document.getElementById('panel-progreso').classList.add('active'); renderProgress(); });
            document.getElementById('btn-analisis').addEventListener('click', () => { closeAllPanels(); document.getElementById('panel-analisis').classList.add('active'); renderAnalysis(); });
            document.querySelectorAll('.close-panel').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.getElementById('panel-' + e.target.getAttribute('data-close')).classList.remove('active');
                });
            });

            // L√≥gica de reloj y frases (sin cambios)
            const clockElement = document.getElementById('digital-clock'); let lastHour = -1;
            function updateClock() { const now = new Date(); const h = String(now.getHours()).padStart(2, '0'); const m = String(now.getMinutes()).padStart(2, '0'); const s = String(now.getSeconds()).padStart(2, '0'); if (now.getHours() !== lastHour) { clockElement.classList.add('hour-change'); setTimeout(() => { clockElement.textContent = `${h}:${m}:${s}`; clockElement.classList.remove('hour-change'); }, 300); lastHour = now.getHours(); } else { clockElement.textContent = `${h}:${m}:${s}`; } }
            updateClock(); setInterval(updateClock, 1000);
            const quotes = ["El estudio es la llave que abre las puertas del futuro.", "Cada d√≠a es una nueva oportunidad para aprender algo nuevo.", "El conocimiento es poder, pero la curiosidad es la chispa que lo enciende.", "No tengas miedo a cometer errores, ten miedo a no intentar.", "El experto en algo fue una vez un principiante.", "El √©xito es la suma de peque√±os esfuerzos repetidos d√≠a tras d√≠a."];
            let currentQuoteIndex = 0; const quoteElement = document.getElementById('motivational-quote');
            function changeQuote() { quoteElement.style.animation = 'none'; setTimeout(() => { quoteElement.textContent = quotes[currentQuoteIndex]; quoteElement.style.animation = 'fadeIn 1s forwards'; }, 20); currentQuoteIndex = (currentQuoteIndex + 1) % quotes.length; }
            changeQuote(); setInterval(changeQuote, 120000);

            // --- INICIALIZACI√ìN ---
            initMissions(); initUserProfile(); updateAllDisplays();
            initMissionNotifications();
            console.log("Sk√≥pia inicializado.");

            function initMissionNotifications() {
                const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
                const nextMission = data.find(m => !m.completed);
                if (nextMission) {
                    showMissionToast(`¬°Nueva misi√≥n disponible: ${nextMission.title} (+${nextMission.points}‚≠ê)!`, 8000);
                }
            }
        });
    </script>
</body>
</html>
