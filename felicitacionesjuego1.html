<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agente del Conocimiento - Sk√≥pia</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Roboto:wght@400;700&family=Orbitron:wght@700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBGEwwuGLP0ULmsJkAhwwmNSlWAotGu_wY",
            projectId: "skopia-aa786",
            storageBucket: "skopia-aa786.firebasestorage.app",
            messagingSenderId: "719823055099",
            appId: "1:719823055099:web:7d91ea29e4b2dcbb9b685e"
        };

        if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
            firebaseConfig.authDomain = "localhost";
        } else {
            firebaseConfig.authDomain = "skopia-aa786.firebaseapp.com";
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.auth = auth;

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            window.dispatchEvent(new CustomEvent('userReady', { detail: { user } }));
        });
    </script>

    <style>
        :root {
            --color-crema: #fdfbf5;
            --color-oliva-claro: #bec092;
            --color-oliva-medio: #5a6133;
            --color-oliva-oscuro: #272b00;
            --color-sombra: rgba(39, 43, 0, 0.1);
            --float-color: var(--color-oliva-oscuro);
            --float-color-hover: var(--color-oliva-medio);
            --detective-bg: #0a0e1a;
            --detective-accent: #c9a961;
            --detective-text: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--detective-bg);
            color: var(--detective-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- NAVBAR --- */
        .navbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 15px 40px;
            background-color: rgba(10, 14, 26, 0.8);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            position: relative;
            z-index: 1000;
        }
        .hamburger {
            width: 30px;
            height: 25px;
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .hamburger span {
            display: block;
            height: 4px;
            width: 100%;
            background-color: var(--detective-text);
            border-radius: 2px;
            transition: all 0.3s ease-in-out;
        }
        .user-dropdown {
            position: absolute;
            top: 70px;
            right: 40px;
            background-color: rgba(10, 14, 26, 0.9);
            border: 1px solid var(--detective-accent);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.3s, transform 0.3s, visibility 0.3s;
            z-index: 1000;
        }
        .user-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .user-dropdown a {
            display: block;
            padding: 15px 25px;
            text-decoration: none;
            color: var(--detective-text);
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .user-dropdown a:hover {
            background-color: rgba(201, 169, 97, 0.2);
        }
        .user-dropdown hr {
            border: none;
            border-top: 1px solid rgba(201, 169, 97, 0.3);
            margin: 0;
        }

        /* --- GAME INTRO SCREEN --- */
        .game-intro-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            background: linear-gradient(135deg, var(--detective-bg) 0%, #1a2332 100%);
            overflow: hidden;
        }

        /* Detective Background Elements */
        .detective-bg-elements {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .magnifying-glass {
            position: absolute;
            width: 300px;
            height: 300px;
            border: 15px solid rgba(201, 169, 97, 0.2);
            border-radius: 50%;
            top: 10%;
            right: 10%;
            transform: rotate(15deg);
            box-shadow: 0 0 40px rgba(201, 169, 97, 0.1);
        }

        .magnifying-glass::before {
            content: '';
            position: absolute;
            width: 100px;
            height: 20px;
            background-color: rgba(201, 169, 97, 0.2);
            bottom: -60px;
            right: -30px;
            transform: rotate(45deg);
        }

        .fingerprint {
            position: absolute;
            width: 200px;
            height: 200px;
            bottom: 10%;
            left: 10%;
            opacity: 0.1;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23c9a961' d='M50,5 C25.1,5,5,25.1,5,50 C5,74.9,25.1,95,50,95 C74.9,95,95,74.9,95,50 C95,25.1,74.9,5,50,5z M50,10 C72.1,10,90,27.9,90,50 C90,72.1,72.1,90,50,90 C27.9,90,10,72.1,10,50 C10,27.9,27.9,10,50,10z'/%3E%3Cpath fill='%23c9a961' d='M50,15 C30.7,15,15,30.7,15,50 C15,69.3,30.7,85,50,85 C69.3,85,85,69.3,85,50 C85,30.7,69.3,15,50,15z M50,20 C66.6,20,80,33.4,80,50 C80,66.6,66.6,80,50,80 C33.4,80,20,66.6,20,50 C20,33.4,33.4,20,50,20z'/%3E%3Cpath fill='%23c9a961' d='M50,25 C36.2,25,25,36.2,25,50 C25,63.8,36.2,75,50,75 C63.8,75,75,63.8,75,50 C75,36.2,63.8,25,50,25z M50,30 C61,30,70,39,70,50 C70,61,61,70,50,70 C39,70,30,61,30,50 C30,39,39,30,50,30z'/%3E%3Cpath fill='%23c9a961' d='M50,35 C41.7,35,35,41.7,35,50 C35,58.3,41.7,65,50,65 C58.3,65,65,58.3,65,50 C65,41.7,58.3,35,50,35z M50,40 C55.5,40,60,44.5,60,50 C60,55.5,55.5,60,50,60 C44.5,60,40,55.5,40,50 C40,44.5,44.5,40,50,40z'/%3E%3Cpath fill='%23c9a961' d='M50,45 C47.2,45,45,47.2,45,50 C45,52.8,47.2,55,50,55 C52.8,55,55,52.8,55,50 C55,47.2,52.8,45,50,45z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: contain;
        }

        .secret-documents {
            position: absolute;
            width: 150px;
            height: 200px;
            top: 20%;
            left: 15%;
            background-color: rgba(201, 169, 97, 0.1);
            transform: rotate(-10deg);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .secret-documents::before {
            content: '';
            position: absolute;
            width: 150px;
            height: 200px;
            top: 10px;
            left: 10px;
            background-color: rgba(201, 169, 97, 0.1);
            transform: rotate(5deg);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Game Intro Content */
        .game-intro-content {
            position: relative;
            z-index: 2;
            text-align: center;
            max-width: 800px;
            animation: fadeIn 1.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .game-title {
            font-family: 'Cinzel', serif;
            font-size: 4rem;
            color: var(--detective-accent);
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(201, 169, 97, 0.3);
            letter-spacing: 2px;
        }

        .game-subtitle {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.8rem;
            color: var(--detective-text);
            margin-bottom: 40px;
            opacity: 0.9;
        }

        .game-description {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 50px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .detective-quote {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.5rem;
            font-style: italic;
            color: var(--detective-accent);
            margin-bottom: 50px;
            position: relative;
            padding: 0 30px;
        }

        .detective-quote::before, .detective-quote::after {
            content: '"';
            font-size: 3rem;
            position: absolute;
            opacity: 0.5;
        }

        .detective-quote::before {
            top: -20px;
            left: 0;
        }

        .detective-quote::after {
            bottom: -40px;
            right: 0;
        }

        .start-game-btn {
            background: linear-gradient(135deg, var(--detective-accent) 0%, #e6c277 100%);
            color: var(--detective-bg);
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(201, 169, 97, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .start-game-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .start-game-btn:hover::before {
            left: 100%;
        }

        .start-game-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(201, 169, 97, 0.4);
        }

        .detective-badge {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 100px;
            background-color: var(--detective-accent);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 2;
        }

        .detective-badge i {
            font-size: 3rem;
            color: var(--detective-bg);
        }

        /* --- FLOATING ICONS & PANELS --- */
        .floating-icons {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 2000;
        }
        .floating-icons button {
            background: var(--float-color);
            color: white;
            width: 54px;
            height: 54px;
            border-radius: 50%;
            border: none;
            font-size: 20px;
            display: grid;
            place-items: center;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            cursor: pointer;
            transition: transform .15s ease, background .15s ease;
        }
        .floating-icons button:hover { transform: scale(1.08); background: var(--float-color-hover); }

        .panel-box {
            position: fixed;
            right: 90px;
            top: 50%;
            transform: translateY(-50%);
            width: 420px;
            max-height: 75vh;
            background: rgba(10, 14, 26, 0.9);
            border: 1px solid var(--detective-accent);
            border-radius: 12px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.5);
            overflow: auto;
            padding: 24px;
            z-index: 2100;
            display: none;
            font-family: 'Patrick Hand', cursive;
            font-size: 1.2rem;
            color: var(--detective-text);
        }
        .panel-box.active { display: block; }

        .panel-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .panel-header h3 { margin:0; font-size:1.6rem; color:var(--detective-accent); }
        .close-panel { background:none; border:none; font-size:1.4rem; cursor:pointer; color:var(--detective-accent); }

        .mission-row { padding:12px; border-radius:8px; margin-bottom:10px; background:rgba(201, 169, 97, 0.1); box-shadow: 0 2px 6px rgba(0,0,0,0.2); display:flex; justify-content:space-between; align-items:center; }
        .mission-row.completed { opacity:0.6; text-decoration:line-through; background:rgba(76, 175, 80, 0.1); }

        .toast {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: rgba(10, 14, 26, 0.9);
            border-left: 6px solid var(--detective-accent);
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.5);
            z-index: 3000;
            display: none;
            font-size: 1.1rem;
            max-width: 400px;
            color: var(--detective-text);
        }
        .toast.show { display: block; }

        .info { font-family: 'Roboto', sans-serif; color:var(--detective-text); font-size:1.1rem; margin-bottom:12px; }

        @media (max-width: 1024px) {
            .game-title { font-size: 3rem; }
            .game-subtitle { font-size: 1.5rem; }
            .game-description { font-size: 1.1rem; }
            .detective-quote { font-size: 1.3rem; }
            .panel-box { right: 10px; width: 92%; top: 55%; transform: translateY(-55%); }
            .floating-icons { right: 10px; }
            .magnifying-glass { width: 200px; height: 200px; }
            .secret-documents { width: 100px; height: 150px; }
        }

        @media (max-width: 768px) {
            .game-title { font-size: 2.5rem; }
            .game-subtitle { font-size: 1.3rem; }
            .game-description { font-size: 1rem; }
            .detective-quote { font-size: 1.1rem; }
            .magnifying-glass { width: 150px; height: 150px; }
            .secret-documents { width: 80px; height: 120px; }
        }
    </style>
     <script type="module" src="./global-settings.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="hamburger" id="hamburger-menu">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="user-dropdown" id="user-dropdown">
            <a href="cuenta.html">Mi Cuenta</a>
            <a href="configuracion.html">Configuraci√≥n</a>
            <a href="notificaciones.html">Notificaciones</a>
            <hr>
            <a href="index.html" id="logout-btn">Cerrar Sesi√≥n</a>
        </div>
    </nav>

    <div class="game-intro-container">
        <!-- Detective Background Elements -->
        <div class="detective-bg-elements">
            <div class="magnifying-glass"></div>
            <div class="fingerprint"></div>
            <div class="secret-documents"></div>
        </div>

        <!-- Game Intro Content -->
        <div class="game-intro-content">
            <h1 class="game-title">Misi√≥n Completada</h1>
            <h2 class="game-subtitle">¬°Felicidades, Agente!</h2>
            
            <p class="game-description">
               Has descifrado con √©xito todos los mensajes cifrados y descubierto la informaci√≥n clave. Tus habilidades de comprensi√≥n literal te han permitido reconstruir textos con "errores" o "lagunas de sentido" y completar tu misi√≥n con √©xito.


            </p>
            
            <div class="detective-quote">
              El √©xito no es la clave de la felicidad. La felicidad es la clave del √©xito. Si amas lo que haces, tendr√°s √©xito.

            </div>
            
            <button class="start-game-btn" id="start-game-btn">Continuar</button>
        </div>
        
        <div class="detective-badge">
            <i class="fas fa-user-secret"></i>
        </div>
    </div>

    <!-- Floating vertical icons -->
    <div class="floating-icons" aria-hidden="false">
        <button id="btn-misiones" title="Misiones">üéØ</button>
        <button id="btn-nivel" title="Nivel actual">‚≠ê</button>
        <button id="btn-progreso" title="Progreso">üìä</button>
        <button id="btn-analisis" title="An√°lisis">üìà</button>
    </div>

    <!-- Panel Misiones -->
    <div class="panel-box" id="panel-misiones" aria-hidden="true">
        <div class="panel-header">
            <h3>Misiones</h3>
            <button class="close-panel" data-close="misiones">&times;</button>
        </div>
        <div id="misiones-content">
            <!-- missions list injected by JS -->
        </div>
    </div>

    <!-- Panel Nivel -->
    <div class="panel-box" id="panel-nivel" aria-hidden="true">
        <div class="panel-header">
            <h3>Tu nivel</h3>
            <button class="close-panel" data-close="nivel">&times;</button>
        </div>
        <div id="nivel-content">
            <!-- level info injected by JS -->
        </div>
    </div>

    <!-- Panel Progreso -->
    <div class="panel-box" id="panel-progreso" aria-hidden="true">
        <div class="panel-header">
            <h3>Progreso</h3>
            <button class="close-panel" data-close="progreso">&times;</button>
        </div>
        <div id="progreso-content">
            <!-- progress injected by JS -->
        </div>
    </div>

    <!-- Panel Analisis -->
    <div class="panel-box" id="panel-analisis" aria-hidden="true">
        <div class="panel-header">
            <h3>An√°lisis (promedio 0‚Äì300)</h3>
            <button class="close-panel" data-close="analisis">&times;</button>
        </div>
        <div id="analisis-content">
            <div id="analisis-stats" style="margin-top:12px;"></div>
        </div>
    </div>

    <!-- Toast notification for mission completed -->
    <div class="toast" id="mission-toast" role="status" aria-live="polite"></div>

    <!-- Audio element for mission completion sound -->
    <audio id="mission-sound" src="mission.mp3" preload="auto"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Cargado. Inicializando pantalla de juego...");

            // --- CONSTANTES Y VARIABLES ---
            const MISSIONS_KEY = 'skopia_missions_v1';
            const USER_PROFILE_KEY = 'skopia_user_profile_v1';
            const GAME_STATS_KEY = 'skopia_game_stats_v1';
            let toastTimer = null;
            let gameStartTime = null;

            // Lista de IDs de misiones "meta" que no cuentan para la racha
            const META_MISSION_IDS = [38]; // Misi√≥n 38: Revisa tu historial de progreso

            const missionsTemplate = [
                 { id: 1, title: "Completa tu primer examen", points: 50 },
            { id: 2, title: "Logra al menos 180/300 en un examen", points: 80 },
            { id: 3, title: "Lee toda la teor√≠a de una lecci√≥n", points: 40 },
            { id: 4, title: "Termina una sesi√≥n de estudio sin salir", points: 50 },
            { id: 5, title: "Gana tu primer juego", points: 50 },
            { id: 6, title: "Usa una pista o ayuda en un juego", points: 30 },
            { id: 7, title: "Repite un examen para mejorar tu nota", points: 50 },
            { id: 8, title: "Cambia tu nombre de usuario", points: 40 },
            { id: 9, title: "Acumula tus primeras 200 estrellas", points: 30 },
            { id: 10, title: "Completa 3 misiones seguidas", points: 50 },

            { id: 11, title: "Logra 240/300 en un examen", points: 150 },
            { id: 12, title: "Completa un examen sin errores (300/300)", points: 200 },
            { id: 13, title: "Gana 3 juegos distintos", points: 60 },
            { id: 14, title: "Termina una teor√≠a con ejemplo pr√°ctico", points: 40 },
            { id: 15, title: "Participa en una pr√°ctica de repaso", points: 30 },
            { id: 16, title: "Completa 2 ex√°menes el mismo d√≠a", points: 80 },
            { id: 17, title: "Obt√©n 500 estrellas acumuladas", points: 50 },
            { id: 18, title: "Gana un juego en menos de 2 minutos", points: 50 },
            { id: 19, title: "Repite un juego hasta mejorar tu resultado", points: 30 },
            { id: 20, title: "Completa todas las misiones del nivel 1", points: 100 },

            { id: 21, title: "Logra 270/300 en un examen", points: 180 },
            { id: 22, title: "Supera tu propia mejor nota", points: 60 },
            { id: 23, title: "Termina 5 juegos de pr√°ctica", points: 50 },
            { id: 24, title: "Lee toda la teor√≠a sin usar pistas", points: 40 },
            { id: 25, title: "Completa todos los subniveles de un tema (5/5)", points: 100 },
            { id: 26, title: "Suma 1000 estrellas totales", points: 50 },
            { id: 27, title: "Gana un examen con tiempo limitado", points: 80 },
            { id: 28, title: "Juega y gana el modo ‚Äúescape room‚Äù", points: 60 },
            { id: 29, title: "Completa un juego de ahorcado correctamente", points: 50 },
            { id: 30, title: "Haz un examen de repaso general", points: 70 },

            { id: 31, title: "Logra 300/300 en dos ex√°menes seguidos", points: 200 },
            { id: 32, title: "Completa todos los juegos de un m√≥dulo", points: 100 },
            { id: 33, title: "Termina la teor√≠a de un m√≥dulo completo", points: 80 },
            { id: 34, title: "Gana un juego tipo tablero", points: 60 },
            { id: 35, title: "Completa una misi√≥n cronometrada", points: 80 },
            { id: 36, title: "Obt√©n 2000 estrellas acumuladas", points: 60 },
            { id: 37, title: "Gana un juego sin usar pistas", points: 50 },
            { id: 38, title: "Revisa tu historial de progreso", points: 30 },
            { id: 39, title: "Completa 10 misiones seguidas sin fallar", points: 100 },
            { id: 40, title: "Termina un examen con todos los tiempos perfectos", points: 150 },

            { id: 41, title: "Completa 5 ex√°menes con m√°s de 240/300", points: 150 },
            { id: 42, title: "Termina todos los subniveles del nivel 6", points: 140 },
            { id: 43, title: "Consigue 3000 estrellas", points: 120 },
            { id: 44, title: "Estudia 10 d√≠as seguidos", points: 130 },
            { id: 45, title: "Completa 10 misiones", points: 140 },
            { id: 46, title: "Llega al nivel 6.5", points: 130 },
            { id: 47, title: "Termina un examen sin errores", points: 150 },
            { id: 48, title: "Supera tu propio puntaje anterior", points: 140 },
            { id: 49, title: "Contesta 500 preguntas", points: 130 },
            { id: 50, title: "Completa un examen en menos de 25 minutos", points: 140 },

            { id: 51, title: "Alcanza el top 10 por primera vez (local)", points: 150 },
            { id: 52, title: "Mantente en el top 10 por 3 d√≠as (local)", points: 140 },
            { id: 53, title: "Gana 4000 estrellas", points: 130 },
            { id: 54, title: "Termina la ruta RC con promedio ‚â•200", points: 140 },
            { id: 55, title: "Termina la ruta LC con promedio ‚â•200", points: 140 },
            { id: 56, title: "Termina la ruta CC con promedio ‚â•200", points: 140 },
            { id: 57, title: "Obt√©n 250 puntos o m√°s en tres rutas", points: 150 },
            { id: 58, title: "Crea una racha de 20 aciertos seguidos", points: 140 },
            { id: 59, title: "Completa 15 misiones", points: 130 },
            { id: 60, title: "Alcanza el nivel 7", points: 150 },

            { id: 61, title: "Consigue 6000 estrellas", points: 160 },
            { id: 62, title: "Estudia 20 d√≠as seguidos", points: 170 },
            { id: 63, title: "Termina todos los niveles de una ruta (10/10)", points: 180 },
            { id: 64, title: "Contesta 1000 preguntas", points: 160 },
            { id: 65, title: "Supera a 5 usuarios en el ranking (local)", points: 170 },
            { id: 66, title: "Alcanza el nivel 8", points: 170 },
            { id: 67, title: "Termina 20 misiones", points: 160 },
            { id: 68, title: "Obt√©n promedio ‚â•250 puntos en una ruta", points: 180 },
            { id: 69, title: "Logra 5 ex√°menes con 250 o m√°s puntos", points: 170 },
            { id: 70, title: "Termina las rutas RC y LC completas", points: 180 },

            { id: 71, title: "Mantente en el top 5 (local)", points: 170 },
            { id: 72, title: "Completa todos los subniveles (50 total)", points: 180 },
            { id: 73, title: "Gana 8000 estrellas", points: 160 },
            { id: 74, title: "Termina 25 misiones", points: 170 },
            { id: 75, title: "Sube de nivel sin fallar un examen", points: 160 },
            { id: 76, title: "Obt√©n 280 puntos en un examen", points: 180 },
            { id: 77, title: "Completa 10 ex√°menes sin pistas", points: 170 },
            { id: 78, title: "Obt√©n 270 o m√°s en las tres rutas", points: 180 },
            { id: 79, title: "Alcanza el nivel 9", points: 180 },
            { id: 80, title: "Termina 30 misiones", points: 170 },

            { id: 81, title: "Gana 10,000 estrellas", points: 190 },
            { id: 82, title: "Mantente en el top 3 (local)", points: 190 },
            { id: 83, title: "Termina las tres rutas con promedio ‚â•250", points: 190 },
            { id: 84, title: "Completa los 50 subniveles con m√°s de 200 puntos promedio", points: 200 },
            { id: 85, title: "Llega al nivel 10", points: 200 },
            { id: 86, title: "Gana 15,000 estrellas", points: 200 },
            { id: 87, title: "Mantente en el top 3 por 7 d√≠as (local)", points: 190 },
            { id: 88, title: "Consigue 300 puntos en un examen", points: 200 },
            { id: 89, title: "Termina 40 misiones", points: 190 },
            { id: 90, title: "Completa todos los ex√°menes de pr√°ctica", points: 190 },

            { id: 91, title: "Llega a 20,000 estrellas", points: 200 },
            { id: 92, title: "Termina 50 misiones", points: 190 },
            { id: 93, title: "Mantente en el top 1 por 3 d√≠as (local)", points: 200 },
            { id: 94, title: "Termina todas las rutas al 100%", points: 200 },
            { id: 95, title: "Obt√©n todas las medallas", points: 190 },
            { id: 96, title: "Consigue 25,000 estrellas", points: 200 },
            { id: 97, title: "Cumple todas las misiones b√°sicas e intermedias", points: 190 },
            { id: 98, title: "Mantente activo 30 d√≠as seguidos", points: 200 },
            { id: 99, title: "Llega a 30,000 estrellas", points: 200 },
            { id: 100, title: "üèÜ Maestro del Saber Pro: completa todo el sistema", points: 200 }
            ];

            const LEVELS = [
                { idx: 1, name: "Novato/a", min: 0, max: 299 }, 
                { idx: 2, name: "Aprendiz/a", min: 300, max: 799 },
                { idx: 3, name: "Explorador/a", min: 800, max: 1499 }, 
                { idx: 4, name: "Analista", min: 1500, max: 2499 },
                { idx: 5, name: "Estratega", min: 2500, max: 3699 }, 
                { idx: 6, name: "Sabio/a", min: 3700, max: 4999 },
                { idx: 7, name: "Maestro/a", min: 5000, max: 6499 }, 
                { idx: 8, name: "√âlite", min: 6500, max: 7999 },
                { idx: 9, name: "Leyenda", min: 8000, max: 9499 }, 
                { idx: 10, name: "Rey/Reina Sk√≥pia", min: 9500, max: Infinity }
            ];

            // --- FUNCIONES PRINCIPALES ---

            function initMissions() {
                if (!localStorage.getItem(MISSIONS_KEY)) {
                    const initial = missionsTemplate.map(m => ({ ...m, completed: false }));
                    localStorage.setItem(MISSIONS_KEY, JSON.stringify(initial));
                    console.log("Misiones inicializadas.");
                }
            }

            function initUserProfile() {
                if (!localStorage.getItem(USER_PROFILE_KEY)) {
                    const initial = { originalEmail: "", nameChangeMissionCompleted: false };
                    localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(initial));
                }
            }

            function initGameStats() {
                if (!localStorage.getItem(GAME_STATS_KEY)) {
                    const initial = {
                        gamesPlayed: 0, gamesWon: 0, hintsUsed: 0, totalTime: 0,
                        bestTime: null, lastPlayDate: null, streakDays: 0
                    };
                    localStorage.setItem(GAME_STATS_KEY, JSON.stringify(initial));
                    console.log("Estad√≠sticas de juego inicializadas.");
                }
            }

            function completeMission(id) {
                console.log(`>>> Llamada a completeMission con ID: ${id}`);
                const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
                const mission = data.find(m => m.id === id);
                if (mission && !mission.completed) {
                    mission.completed = true;
                    localStorage.setItem(MISSIONS_KEY, JSON.stringify(data));
                    console.log(`!!! MISI√ìN COMPLETADA: ID=${id}, Titulo="${mission.title}", Puntos=${mission.points} !!!`);
                    
                    document.getElementById('mission-sound').play().catch(e => console.log("Error al reproducir sonido:", e));
                    showMissionToast(`¬°Misi√≥n completada: ${mission.title} (+${mission.points}‚≠ê)!`, 5000);
                    updateAllDisplays();
                    
                    setTimeout(() => {
                        console.log("Iniciando verificaci√≥n de misiones especiales de forma diferida...");
                        checkAndCompleteSpecialMissions();
                    }, 200);
                } else {
                    console.log(`>>> Misi√≥n ${id} ya estaba completada o no existe.`);
                }
            }

            function checkAndCompleteSpecialMissions() {
                const missionsData = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
                const totalPoints = getTotalPoints();
                const completedCount = getCompletedCount();
                const gameStats = JSON.parse(localStorage.getItem(GAME_STATS_KEY) || "{}");
                let changed = false;
                const newlyCompletedMissions = [];

                // Misi√≥n 9: Acumula tus primeras 200 estrellas
                if (totalPoints >= 200) {
                    const mission9 = missionsData.find(m => m.id === 9);
                    if (mission9 && !mission9.completed) {
                        mission9.completed = true;
                        changed = true;
                        newlyCompletedMissions.push(mission9);
                    }
                }
                
                // Misi√≥n 10: Completa 3 misiones seguidas (EXCLUYENDO MISIONES META)
                const metaCompletedCount = missionsData.filter(m => m.completed && META_MISSION_IDS.includes(m.id)).length;
                const realCompletedCount = completedCount - metaCompletedCount;
                console.log(`Verificando Misi√≥n 10: Total completadas=${completedCount}, Meta completadas=${metaCompletedCount}, Reales=${realCompletedCount}`);
                if (realCompletedCount >= 3) {
                    const mission10 = missionsData.find(m => m.id === 10);
                    if (mission10 && !mission10.completed) {
                        mission10.completed = true;
                        changed = true;
                        newlyCompletedMissions.push(mission10);
                    }
                }
                
                // Misi√≥n 13: Gana 3 juegos distintos
                if (gameStats.gamesWon >= 3) {
                    const mission13 = missionsData.find(m => m.id === 13);
                    if (mission13 && !mission13.completed) {
                        mission13.completed = true;
                        changed = true;
                        newlyCompletedMissions.push(mission13);
                    }
                }

                // Otras misiones seg√∫n puntos
                if (totalPoints >= 500) { const m = missionsData.find(m => m.id === 17); if (m && !m.completed) { m.completed = true; changed = true; newlyCompletedMissions.push(m);} }
                if (totalPoints >= 1000) { const m = missionsData.find(m => m.id === 26); if (m && !m.completed) { m.completed = true; changed = true; newlyCompletedMissions.push(m);} }
                if (totalPoints >= 3000) { const m = missionsData.find(m => m.id === 43); if (m && !m.completed) { m.completed = true; changed = true; newlyCompletedMissions.push(m);} }

                if (changed) {
                    localStorage.setItem(MISSIONS_KEY, JSON.stringify(missionsData));
                    document.getElementById('mission-sound').play().catch(e => console.log("Error al reproducir sonido:", e));
                    newlyCompletedMissions.forEach(m => {
                        console.log(`!!! MISI√ìN ESPECIAL COMPLETADA: ID=${m.id}, Titulo="${m.title}", Puntos=${m.points} !!!`);
                        showMissionToast(`¬°Misi√≥n completada: ${m.title} (+${m.points}‚≠ê)!`, 5000);
                    });
                    updateAllDisplays();
                } else {
                    console.log("No hay nuevas misiones especiales para completar.");
                }
            }

            function showMissionToast(text, ms = 60000) {
                const toast = document.getElementById('mission-toast');
                toast.innerHTML = `<strong>${text}</strong>`;
                toast.classList.add('show');
                if (toastTimer) clearTimeout(toastTimer);
                toastTimer = setTimeout(() => toast.classList.remove('show'), ms);
            }

            function getTotalPoints() {
                const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
                return data.reduce((sum, m) => sum + (m.completed ? m.points : 0), 0);
            }

            function getLevelFromPoints(total) {
                for (let i = LEVELS.length - 1; i >= 0; i--) {
                    if (total >= LEVELS[i].min) return LEVELS[i];
                }
                return LEVELS[0];
            }

            function getCompletedCount() {
                return JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]").filter(m => m.completed).length;
            }

            // --- RENDER FUNCTIONS ---
            function renderMissions() {
                const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
                const container = document.getElementById('misiones-content');
                container.innerHTML = '';
                const incompleteMissions = data.filter(m => !m.completed).slice(0, 3);
                if (incompleteMissions.length === 0) {
                    container.innerHTML = '<div class="info">¬°Felicidades! Has completado todas las misiones.</div>';
                    return;
                }
                incompleteMissions.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'mission-row';
                    div.innerHTML = `<div style="flex:1"><div style="font-weight:700; color:var(--detective-text)">${m.id}. ${m.title}</div><div style="font-size:1rem; color:var(--detective-accent)">${m.points} ‚≠ê</div></div>`;
                    container.appendChild(div);
                });
            }

            function renderLevel() {
                const total = getTotalPoints();
                const level = getLevelFromPoints(total);
                const neededForNext = (level.max === Infinity) ? 0 : (level.max - total + 1);
                const progressPct = (level.max === Infinity) ? 100 : Math.min(100, Math.round(((total - level.min) / (level.max - level.min)) * 100));
                document.getElementById('nivel-content').innerHTML = `
                    <div class="info"><strong>Nivel:</strong> ${level.name} (${level.idx})</div>
                    <div class="info"><strong>Puntos:</strong> ${total} ‚≠ê</div>
                    <div class="info"><strong>Progreso:</strong> ${progressPct}%</div>
                    <div style="background:rgba(201, 169, 97, 0.2);border-radius:10px;padding:8px;margin-top:10px">
                        <div style="height:12px;background:linear-gradient(90deg,var(--detective-accent),#e6c277);width:${progressPct}%;border-radius:8px"></div>
                    </div>
                    ${level.max === Infinity ? '<div class="info" style="margin-top:8px">¬°Nivel m√°ximo!</div>' : `<div class="info" style="margin-top:8px">Para subir: ${neededForNext} ‚≠ê</div>`}
                `;
            }

            function renderProgress() {
                const total = getTotalPoints();
                const topTarget = 9500;
                const pct = Math.min(100, Math.round((total / topTarget) * 100));
                document.getElementById('progreso-content').innerHTML = `
                    <div class="info"><strong>Puntos:</strong> ${total} ‚≠ê</div>
                    <div class="info"><strong>Progreso Global:</strong> ${pct}%</div>
                    <div style="background:rgba(201, 169, 97, 0.2);border-radius:10px;padding:8px;margin-top:10px">
                        <div style="height:12px;background:linear-gradient(90deg,var(--detective-accent),#e6c277);width:${pct}%;border-radius:8px"></div>
                    </div>
                    <div class="info" style="margin-top:10px"><strong>Misiones:</strong> ${getCompletedCount()}/100</div>
                `;
            }

            function renderAnalysis() {
                const gameStats = JSON.parse(localStorage.getItem(GAME_STATS_KEY) || "{}");
                document.getElementById('analisis-stats').innerHTML = `
                    <div class="info"><strong>Juegos jugados:</strong> ${gameStats.gamesPlayed || 0}</div>
                    <div class="info"><strong>Juegos ganados:</strong> ${gameStats.gamesWon || 0}</div>
                    <div class="info"><strong>Pistas usadas:</strong> ${gameStats.hintsUsed || 0}</div>
                    <div class="info"><strong>Mejor tiempo:</strong> ${gameStats.bestTime ? `${gameStats.bestTime}s` : 'N/A'}</div>
                    <div class="info"><strong>Racha actual:</strong> ${gameStats.streakDays || 0} d√≠as</div>
                `;
            }

            function updateAllDisplays() {
                renderMissions(); renderLevel(); renderProgress(); renderAnalysis();
            }

            function closeAllPanels() {
                document.querySelectorAll('.panel-box').forEach(p => p.classList.remove('active'));
            }

            // --- EVENT LISTENERS ---
            window.addEventListener('userReady', (e) => {
                const user = e.detail.user;
                const userProfile = JSON.parse(localStorage.getItem(USER_PROFILE_KEY) || "{}");
                if (!userProfile.originalEmail) {
                    userProfile.originalEmail = user.email;
                    userProfile.nameChangeMissionCompleted = false;
                    localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(userProfile));
                }
                if (!userProfile.nameChangeMissionCompleted) {
                    const hasChangedName = user.displayName && user.displayName !== userProfile.originalEmail;
                    if (hasChangedName) {
                        completeMission(8);
                        userProfile.nameChangeMissionCompleted = true;
                        localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(userProfile));
                    }
                }
            });

            document.getElementById('hamburger-menu').addEventListener('click', () => {
                document.getElementById('user-dropdown').classList.toggle('active');
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                import("https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js").then(({ signOut }) => {
                    signOut(window.auth).then(() => window.location.href = 'index.html');
                });
            });

            window.addEventListener('click', (event) => {
                if (!event.target.closest('.navbar')) document.getElementById('user-dropdown').classList.remove('active');
                const isIcon = event.target.closest('.floating-icons');
                const isPanel = event.target.closest('.panel-box');
                if (!isIcon && !isPanel) closeAllPanels();
            });

          document.getElementById('start-game-btn').addEventListener('click', () => {
    saveMissionProgress();
    setTimeout(() => {
        window.location.href = 'LC.html';
    }, 1000);
});
            // **EVENT LISTENERS DE ICONOS (CORREGIDO)**
            document.getElementById('btn-misiones').addEventListener('click', () => {
                closeAllPanels();
                document.getElementById('panel-misiones').classList.add('active');
                renderMissions();
            });
            
            document.getElementById('btn-nivel').addEventListener('click', () => {
                closeAllPanels();
                document.getElementById('panel-nivel').classList.add('active');
                renderLevel();
            });
            
            document.getElementById('btn-progreso').addEventListener('click', () => {
                closeAllPanels();
                document.getElementById('panel-progreso').classList.add('active');
                renderProgress();
                // Completar misi√≥n 38 aqu√≠
                completeMission(38);
            });
            
            document.getElementById('btn-analisis').addEventListener('click', () => {
                closeAllPanels();
                document.getElementById('panel-analisis').classList.add('active');
                renderAnalysis();
            });
            
            document.querySelectorAll('.close-panel').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.getElementById('panel-' + e.target.getAttribute('data-close')).classList.remove('active');
                });
            });

            // --- INICIALIZACI√ìN ---
            initMissions(); initUserProfile(); initGameStats(); updateAllDisplays();
            
            const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
            const nextMission = data.find(m => !m.completed);
            if (nextMission) {
                showMissionToast(`¬°Nueva misi√≥n disponible: ${nextMission.title} (+${nextMission.points}‚≠ê)!`, 8000);
            }
            
            console.log("Pantalla de juego inicializada.");
        });

        // Funci√≥n para guardar el progreso de la misi√≥n completada
function saveMissionProgress() {
    const GAME_PROGRESS_KEY = 'skopia_game_progress_v1';
    const progress = JSON.parse(localStorage.getItem(GAME_PROGRESS_KEY) || "{}");
    
    progress.missionCompleted = true;
    progress.lastCompletedMission = {
        id: 1,
        title: "Misi√≥n: Comprensi√≥n Literal",
        completedAt: new Date().toISOString(),
        level: 1,
        sublevel: 1
    };
    
    if (!progress.completedSublevels) {
        progress.completedSublevels = [];
    }
    if (!progress.completedSublevels.includes(`1-1`)) {
        progress.completedSublevels.push(`1-1`);
    }
    
    localStorage.setItem(GAME_PROGRESS_KEY, JSON.stringify(progress));
    console.log("Progreso de misi√≥n guardado:", progress);
    
    // Mostrar notificaci√≥n (opcional)
    showNotification("¬°Progreso guardado correctamente!");
}

// Funci√≥n para verificar si la misi√≥n fue completada
function isMissionCompleted() {
    const GAME_PROGRESS_KEY = 'skopia_game_progress_v1';
    const progress = JSON.parse(localStorage.getItem(GAME_PROGRESS_KEY) || "{}");
    return progress.missionCompleted === true;
}

// Funci√≥n para mostrar notificaci√≥n (opcional)
function showNotification(message) {
    // Crear elemento de notificaci√≥n si no existe
    let notification = document.getElementById('progress-notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'progress-notification';
        notification.style.position = 'fixed';
        notification.style.bottom = '20px';
        notification.style.right = '20px';
        notification.style.background = 'rgba(10, 14, 26, 0.9)';
        notification.style.borderLeft = '6px solid #c9a961';
        notification.style.padding = '16px 20px';
        notification.style.borderRadius = '8px';
        notification.style.boxShadow = '0 6px 18px rgba(0,0,0,0.5)';
        notification.style.zIndex = '3000';
        notification.style.fontSize = '1.1rem';
        notification.style.maxWidth = '400px';
        notification.style.color = '#e0e0e0';
        notification.style.display = 'none';
        document.body.appendChild(notification);
    }
    
    notification.innerHTML = `<strong>${message}</strong>`;
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}
    </script>
</body>
</html>
