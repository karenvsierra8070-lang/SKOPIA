<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sk√≥pia - Centro de Notificaciones</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Colores alineados con el resto de la aplicaci√≥n */
        :root {
            --color-crema: #fdfbf5;
            --color-oliva-claro: #bec092;
            --color-oliva-oscuro: #272b00;
            --color-oliva-medio: #5a6133;
            --color-verde: #4CAF50;
            --color-rojo: #f44336;
            
            /* Variables de compatibilidad */
            --color-fondo: var(--color-oliva-oscuro);
            --color-libro-fondo: var(--color-crema);
            --color-texto-oscuro: var(--color-oliva-oscuro);
            --color-resalte: var(--color-oliva-medio);
            --color-btn-mision: var(--color-oliva-oscuro);
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--color-fondo);
            color: var(--color-texto-oscuro);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; 
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto; 
        }

        .contenedor-principal {
            position: relative;
            max-width: 900px; 
            width: 100%;
            margin: 20px auto; 
        }

        /* --- Estilo de Libro/Carta --- */
        .libro-contenedor {
            display: flex;
            background-color: var(--color-libro-fondo);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            min-height: 550px;
        }

        .pagina-izquierda, .pagina-derecha {
            padding: 40px 30px;
            width: 50%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .pagina-derecha {
            position: relative;
            border-left: 2px dashed var(--color-oliva-claro); 
            padding-left: 50px; 
        }

        .pagina-derecha::before {
            content: "";
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 20px;
            background: repeating-linear-gradient(90deg, var(--color-oliva-claro), var(--color-oliva-claro) 5px, transparent 5px, transparent 10px);
            opacity: 0.5;
            pointer-events: none;
        }

        .logo-area {
            text-align: center;
            margin-bottom: 20px;
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .logo-libro {
            width: 100%;
            max-width: 250px;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        .mascota-area {
            text-align: center;
            margin-top: auto; 
        }
        
        .mascota-panda {
            width: 220px;
            height: auto;
            margin-bottom: 10px;
        }

        .mascota-texto {
            font-size: 0.9em;
            color: var(--color-fondo);
            font-style: italic;
        }

        .carta-texto h2 {
            font-size: 1.8em;
            color: var(--color-fondo);
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--color-resalte);
            padding-bottom: 5px;
        }

        .carta-texto p {
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        /* --- Estilo para el bot√≥n de volver --- */
        .boton-volver {
            display: inline-flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 8px 15px;
            background-color: transparent;
            color: var(--color-oliva-medio);
            border: 1px solid var(--color-oliva-medio);
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        .boton-volver:hover {
            background-color: var(--color-oliva-medio);
            color: var(--color-crema);
            transform: translateY(-2px);
        }
        .boton-volver span {
            margin-right: 5px;
        }

        /* --- Estilos espec√≠ficos de esta p√°gina --- */
        .permission-card {
            background-color: #f9f9f9;
            border: 1px solid var(--color-oliva-claro);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .permission-card h3 {
            margin-top: 0;
            color: var(--color-oliva-medio);
        }

        .boton-principal {
            display: inline-block;
            width: auto;
            margin: 15px auto 0;
            padding: 12px 25px;
            background-color: var(--color-btn-mision);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s, transform 0.1s;
        }

        .boton-principal:hover {
            background-color: var(--color-resalte);
            transform: translateY(-2px);
        }

        .boton-principal:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .test-buttons-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .test-button {
            padding: 10px 15px;
            background-color: var(--color-oliva-medio);
            color: var(--color-crema);
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }

        .test-button:hover {
            background-color: var(--color-oliva-oscuro);
            transform: translateY(-2px);
        }

        #status-area {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
        }

        .status-success { background-color: rgba(76, 175, 80, 0.2); color: var(--color-verde); }
        .status-error { background-color: rgba(244, 67, 54, 0.2); color: var(--color-rojo); }
        .status-info { background-color: rgba(91, 97, 51, 0.2); color: var(--color-oliva-medio); }

        @media (max-width: 768px) {
            .libro-contenedor { flex-direction: column; }
            .pagina-izquierda, .pagina-derecha { width: 100%; padding: 20px; }
            .pagina-derecha { border-left: none; border-top: 2px dashed var(--color-oliva-claro); padding-left: 20px; }
            .pagina-derecha::before { display: none; }
        }
    </style>

    <!-- LLAMADA AL SISTEMA DE AJUSTES -->
    <script type="module" src="global-settings.js"></script>
</head>
<body>

    <div class="contenedor-principal">
        <div class="libro-contenedor">
            
            <div class="pagina-izquierda">
                <div class="logo-area">
                    <img src="logo.jpeg" alt="Logo Sk√≥pia" class="logo-libro"> 
                </div>
                <div class="mascota-area">
                    <img src="panda.jpeg" alt="Mascota Panda" class="mascota-panda">
                    <p class="mascota-texto">¬°No te pierdas nada!</p>
                </div>
            </div>

            <div class="pagina-derecha">
                <div class="carta-texto">
                    <h2>CENTRO DE NOTIFICACIONES</h2>
                    
                    <button id="volver-btn" class="boton-volver">
                        <span>‚Üê</span> Volver
                    </button>
                    
                    <div class="permission-card">
                        <h3>üîî Mantente Conectado</h3>
                        <p>Las notificaciones te ayudar√°n a recordar tus sesiones de estudio, celebrar tus logros y mantenerte enfocado en tu meta del Saber Pro.</p>
                        <p><strong>Para recibir notificaciones, primero debes darnos permiso.</strong></p>
                        <button id="permiso-btn" class="boton-principal">Solicitar Permiso de Notificaciones</button>
                    </div>

                    <div id="status-area">Esperando acci√≥n...</div>

                    <h3>üß™ Probar Diferentes Notificaciones</h3>
                    <p>Una vez concedido el permiso, usa los siguientes botones para ver c√≥mo se ver√≠an las alertas en tu dispositivo.</p>
                    
                    <div class="test-buttons-container">
                        <button id="simple-btn" class="test-button" disabled>Notificaci√≥n Simple</button>
                        <button id="icono-btn" class="test-button" disabled>Notificaci√≥n con √çcono</button>
                        <button id="accion-btn" class="test-button" disabled>Notificaci√≥n con Acci√≥n</button>
                        <button id="imagen-btn" class="test-button" disabled>Notificaci√≥n con Imagen</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        // NUEVO: Importamos las funciones de Firestore
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBGEwwuGLP0ULmsJkAhwwmNSlWAotGu_wY",
            projectId: "skopia-aa786",
            storageBucket: "skopia-aa786.firebasestorage.app",
            messagingSenderId: "719823055099",
            appId: "1:719823055099:web:7d91ea29e4b2dcbb9b685e"
        };

        if (window.location.hostname === "localhost") {
            firebaseConfig.authDomain = "localhost";
        } else {
            firebaseConfig.authDomain = "skopia-aa786.firebaseapp.com";
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        // NUEVO: Inicializamos Firestore
        const db = getFirestore(app);

        // --- INICIO: C√ìDIGO DE SUSCRIPCI√ìN A PUSH ---

        // ¬°TU CLAVE P√öBLICA YA EST√Å AQU√ç!
        const VAPID_PUBLIC_KEY = 'BFhKpwY1xHboaBNFjh514E-D9WJVghZ7xhrBWJjeKV6YXqbm9bIzZmzEx8YDNYk9rdHBCJwBF3Mm6bmHLIX_UzA';

        function urlB64ToUint8Array(base64String) {
          const padding = '='.repeat((4 - base64String.length % 4) % 4);
          const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
          const rawData = window.atob(base64);
          const outputArray = new Uint8Array(rawData.length);
          for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
          }
          return outputArray;
        }

        async function suscribirUsuarioAPush() {
          console.log("Intentando suscribir al usuario a Push...");
          if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
            console.error('Tu navegador no soporta Push Notifications.');
            return;
          }

          try {
            const registration = await navigator.serviceWorker.ready;
            const subscription = await registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: urlB64ToUint8Array(VAPID_PUBLIC_KEY)
            });

            console.log('Usuario suscrito:', subscription);
            alert('¬°Felicidades! Ahora est√°s suscrito a las notificaciones de Sk√≥pia.');
            guardarSuscripcionEnFirestore(subscription);

          } catch (error) {
            console.error('Error al suscribir al usuario:', error);
            alert('Hubo un error al intentar suscribirte. Revisa la consola para m√°s detalles.');
          }
        }

        async function guardarSuscripcionEnFirestore(subscription) {
          if (!auth.currentUser) {
            console.error("No hay un usuario autenticado para guardar la suscripci√≥n.");
            return;
          }
          
          const uid = auth.currentUser.uid;
          await setDoc(doc(db, "users", uid, "pushSubscriptions", "token"), subscription);
          console.log("¬°Suscripci√≥n guardada exitosamente en Firestore!");
        }

        // --- FIN: C√ìDIGO DE SUSCRIPCI√ìN A PUSH ---

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            
            // --- L√ìGICA DE NOTIFICACIONES ---
            const permisoBtn = document.getElementById('permiso-btn');
            const simpleBtn = document.getElementById('simple-btn');
            const iconoBtn = document.getElementById('icono-btn');
            const accionBtn = document.getElementById('accion-btn');
            const imagenBtn = document.getElementById('imagen-btn');
            const statusArea = document.getElementById('status-area');
            const testButtons = [simpleBtn, iconoBtn, accionBtn, imagenBtn];

            function updateStatus(message, type) {
                statusArea.textContent = message;
                statusArea.className = `status-${type}`;
            }

            function checkPermissionStatus() {
                if (Notification.permission === 'granted') {
                    updateStatus('‚úÖ Permiso concedido. Ya puedes probar las notificaciones.', 'success');
                    permisoBtn.textContent = 'Permiso Ya Concedido';
                    permisoBtn.disabled = true;
                    testButtons.forEach(btn => btn.disabled = false);
                } else if (Notification.permission === 'denied') {
                    updateStatus('‚ùå Permiso denegado. Activa las notificaciones manualmente en la configuraci√≥n de tu navegador.', 'error');
                    permisoBtn.textContent = 'Permiso Denegado';
                    permisoBtn.disabled = true;
                } else {
                    updateStatus('‚ÑπÔ∏è Esperando a que solicites permiso para mostrar notificaciones.', 'info');
                }
            }

            async function solicitarPermiso() {
                if (!('Notification' in window)) {
                    updateStatus('‚ùå Tu navegador no soporta notificaciones.', 'error');
                    return;
                }

                if (Notification.permission === 'default') {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        updateStatus('‚úÖ ¬°Gracias! Permiso concedido.', 'success');
                        testButtons.forEach(btn => btn.disabled = false);
                        permisoBtn.textContent = 'Permiso Ya Concedido';
                        
                        // NUEVO: Si el permiso se acaba de dar, lo suscribimos
                        await suscribirUsuarioAPush();
                    } else {
                        updateStatus('‚ùå Permiso denegado. No podr√°s recibir alertas.', 'error');
                    }
                    permisoBtn.disabled = true;
                } else if (Notification.permission === 'granted') {
                    // NUEVO: Si el permiso ya estaba concedido, lo suscribimos directamente
                    await suscribirUsuarioAPush();
                }
            }

            function mostrarNotificacionSimple() {
                const notification = new Notification('¬°Hola, Agente!', {
                    body: 'Esta es una notificaci√≥n simple de Sk√≥pia.',
                });
                updateStatus('üì§ Notificaci√≥n simple enviada.', 'info');
            }

            function mostrarNotificacionConIcono() {
                const notification = new Notification('¬°Nuevo Logro!', {
                    body: 'Has completado tu primera lecci√≥n.',
                    icon: 'logo.jpeg'
                });
                updateStatus('üì§ Notificaci√≥n con √≠cono enviada.', 'info');
            }

            function mostrarNotificacionConAccion() {
                if (!('actions' in Notification.prototype)) {
                    updateStatus('‚ùå Tu navegador no soporta notificaciones con botones de acci√≥n.', 'error');
                    return;
                }
                const notification = new Notification('¬øEstudiar ahora?', {
                    body: 'Tienes una sesi√≥n de estudio pendiente.',
                    icon: 'logo.jpeg',
                    actions: [
                        { action: 'yes', title: '¬°S√≠, vamos!' },
                        { action: 'no', title: 'Recordar m√°s tarde' }
                    ]
                });

                notification.onclick = (event) => {
                    event.preventDefault();
                    if (event.action === 'yes') {
                        alert('Redirigiendo al mapa de estudio...');
                        // window.location.href = 'modulos.html';
                    } else {
                        alert('Ok, te recordaremos m√°s tarde.');
                    }
                    notification.close();
                };
                updateStatus('üì§ Notificaci√≥n con acci√≥n enviada. ¬°Haz clic en los botones!', 'info');
            }

            function mostrarNotificacionConImagen() {
                const notification = new Notification('Revisa tu progreso', {
                    body: 'Tu mapa del tesoro se ha actualizado.',
                    icon: 'logo.jpeg',
                    image: 'panda.jpeg'
                });
                updateStatus('üì§ Notificaci√≥n con imagen enviada.', 'info');
            }

            // --- EVENT LISTENERS ---
            document.getElementById('volver-btn').addEventListener('click', () => {
                window.history.back();
            });

            permisoBtn.addEventListener('click', solicitarPermiso);
            simpleBtn.addEventListener('click', mostrarNotificacionSimple);
            iconoBtn.addEventListener('click', mostrarNotificacionConIcono);
            accionBtn.addEventListener('click', mostrarNotificacionConAccion);
            imagenBtn.addEventListener('click', mostrarNotificacionConImagen);

            // --- INICIO ---
            checkPermissionStatus();
        });
    </script>

    <!-- Script para registrar el Service Worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .then(registration => {
              console.log('Service Worker registrado con √©xito:', registration);
            })
            .catch(error => {
              console.log('Error al registrar el Service Worker:', error);
            });
        });
      }
    </script>
</body>
</html>
