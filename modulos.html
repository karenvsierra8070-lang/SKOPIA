<!DOCTYPE html> 
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Rutas - Sk√≥pia</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Roboto:wght@400;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBGEwwuGLP0ULmsJkAhwwmNSlWAotGu_wY",
            projectId: "skopia-aa786",
            storageBucket: "skopia-aa786.firebasestorage.app",
            messagingSenderId: "719823055099",
            appId: "1:719823055099:web:7d91ea29e4b2dcbb9b685e"
        };

        if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
            firebaseConfig.authDomain = "localhost";
        } else {
            firebaseConfig.authDomain = "skopia-aa786.firebaseapp.com";
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            initializePage(user);
        });

        function initializePage(user) {
            const userEmailSpan = document.getElementById('user-email');
            const logoutBtn = document.getElementById('logout-btn');
            userEmailSpan.textContent = user.email;
            logoutBtn.addEventListener('click', () => {
                signOut(auth).then(() => window.location.href = 'index.html');
            });
        }
    </script>

    <style>
        :root {
            --color-crema: #fdfbf5;
            --color-oliva-claro: #bec092;
            --color-oliva-medio: #5a6133;
            --color-oliva-oscuro: #272b00;
            --color-sombra: rgba(39, 43, 0, 0.1);

            /* color for floating icons matched to start-route btn */
            --float-color: var(--color-oliva-oscuro);
            --float-color-hover: var(--color-oliva-medio);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--color-crema) 0%, #f5efe5 100%);
            color: var(--color-oliva-oscuro);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- NAVBAR --- */
        .navbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 15px 40px;
            background-color: white;
            box-shadow: 0 2px 10px var(--color-sombra);
        }
        .hamburger {
            width: 30px;
            height: 25px;
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .hamburger span {
            display: block;
            height: 4px;
            width: 100%;
            background-color: var(--color-oliva-oscuro);
            border-radius: 2px;
            transition: all 0.3s ease-in-out;
        }
        .user-dropdown {
            position: absolute;
            top: 70px;
            right: 40px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px var(--color-sombra);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.3s, transform 0.3s, visibility 0.3s;
            z-index: 1000;
        }
        .user-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .user-dropdown a {
            display: block;
            padding: 15px 25px;
            text-decoration: none;
            color: var(--color-oliva-oscuro);
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .user-dropdown a:hover {
            background-color: var(--color-crema);
        }
        .user-dropdown hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 0;
        }

        /* --- HERO --- */
        .hero-section {
            text-align: center;
            padding: 40px 20px;
        }
        .logo-centro {
            display: block;
            margin: 0 auto 20px auto;
            height: 150px; /* Aumentado de 80px a 150px */
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .digital-clock {
            font-family: 'Orbitron', sans-serif;
            font-size: 5rem;
            font-weight: 700;
            color: black;
            letter-spacing: 5px;
            text-shadow: 0 0 10px rgba(0,0,0,0.1);
            transition: color 0.3s ease;
        }
        .digital-clock.hour-change {
            color: var(--color-oliva-medio);
        }
        .motivational-quote {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.8rem;
            color: var(--color-oliva-medio);
            margin-top: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            min-height: 50px;
            opacity: 0;
            animation: fadeIn 1s forwards;
        }
        .bienvenida {
            font-family: 'Patrick Hand', cursive;
            font-size: 2.2rem;
            color: var(--color-oliva-oscuro);
            margin-top: 25px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px 40px 40px;
            gap: 50px;
        }
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            flex-grow: 1;
        }
        .module-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 8px 25px var(--color-sombra);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }
        .module-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 35px rgba(39, 43, 0, 0.15);
        }
        .module-card h3 {
            font-family: 'Patrick Hand', cursive;
            font-size: 2rem;
            color: var(--color-oliva-oscuro);
            margin-bottom: 25px;
        }
        .start-route-btn {
            background-color: var(--color-oliva-oscuro);
            color: var(--color-crema);
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        .start-route-btn:hover {
            background-color: var(--color-oliva-medio);
            transform: scale(1.05);
        }

        /* --- MASCOTA --- */
        .mascota-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            position: relative;
            width: 300px;
        }
        .mascota-img {
            width: 100%;
            max-width: 220px;
            height: auto;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
        }
        .speech-bubble {
            position: static;
            border: 2px solid var(--color-oliva-claro);
            border-radius: 20px;
            padding: 15px 20px;
            background: white;
            box-shadow: 0 5px 15px var(--color-sombra);
        }
        .speech-bubble p {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.1rem;
            margin: 0;
        }

        /* --- COLORES DE M√ìDULOS --- */
        .module-lectura { background: linear-gradient(135deg, #e8f0e3, #ddebd5); }
        .module-razonamiento { background: linear-gradient(135deg, #d9e3d0, #cddbc3); }
        .module-ciudadanas { background: linear-gradient(135deg, #c5d2b8, #b8c7aa); }
        .module-ingles { background: linear-gradient(135deg, #bec092, #b3b685); }

        /* --- FLOATING ICONS & PANELS (MODIFIED) --- */
        .floating-icons {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 2000;
        }
        .floating-icons button {
            background: var(--float-color);
            color: white;
            width: 54px;
            height: 54px;
            border-radius: 50%;
            border: none;
            font-size: 20px;
            display: grid;
            place-items: center;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            cursor: pointer;
            transition: transform .15s ease, background .15s ease;
        }
        .floating-icons button:hover { transform: scale(1.08); background: var(--float-color-hover); }

        .panel-box {
            position: fixed;
            right: 90px;
            top: 50%;
            transform: translateY(-50%);
            width: 420px; /* Aumentado de 360px a 420px */
            max-height: 75vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.12);
            overflow: auto;
            padding: 24px; /* Aumentado de 18px a 24px */
            z-index: 2100;
            display: none;
            font-family: 'Patrick Hand', cursive;
            font-size: 1.2rem; /* Aumentado el tama√±o de fuente */
        }
        .panel-box.active { display: block; }

        .panel-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .panel-header h3 { margin:0; font-size:1.6rem; color:var(--color-oliva-oscuro); } /* Aumentado de 1.2rem a 1.6rem */
        .close-panel { background:none; border:none; font-size:1.4rem; cursor:pointer; color:var(--color-oliva-medio); } /* Aumentado de 1.1rem a 1.4rem */

        .mission-row { padding:12px; border-radius:8px; margin-bottom:10px; background:#fffaf0; box-shadow: 0 2px 6px rgba(0,0,0,0.04); display:flex; justify-content:space-between; align-items:center; } /* Aumentado padding */
        .mission-row.completed { opacity:0.6; text-decoration:line-through; background:#f0fff4; }

        .toast {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: #fff7e6;
            border-left: 6px solid var(--color-oliva-medio);
            padding: 16px 20px; /* Aumentado padding */
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            z-index: 3000;
            display: none;
            font-size: 1.1rem; /* Aumentado tama√±o de fuente */
            max-width: 400px; /* A√±adido ancho m√°ximo */
        }
        .toast.show { display: block; }

        .info { font-family: 'Roboto', sans-serif; color:var(--color-oliva-oscuro); font-size:1.1rem; margin-bottom:12px; } /* Aumentado tama√±o de fuente y margen */

        @media (max-width: 1024px) {
            .main-content { flex-direction: column; }
            .modules-grid { grid-template-columns: 1fr; width: 100%; }
            .mascota-container { width: 100%; margin-top: 30px; flex-direction: column; }
            .panel-box { right: 10px; width: 92%; top: 55%; transform: translateY(-55%); }
            .floating-icons { right: 10px; }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <!-- Logo eliminado de la navbar -->
        <div class="hamburger" id="hamburger-menu">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="user-dropdown" id="user-dropdown">
            <a href="#">Cuenta: <span id="user-email"></span></a>
            <a href="#">Configuraci√≥n</a>
            <a href="#">Notificaciones</a>
            <hr>
            <a href="#" id="logout-btn">Cerrar Sesi√≥n</a>
        </div>
    </nav>

    <section class="hero-section">
        <img src="logo.jpeg" alt="Logo Sk√≥pia" class="logo-centro">
        <div id="digital-clock" class="digital-clock">00:00:00</div>
        <p id="motivational-quote" class="motivational-quote"></p>
        <h2 class="bienvenida">¬°BIENVENIDO!</h2>
    </section>

    <main class="main-content">
        <section class="modules-grid">
            <div class="module-card module-lectura">
                <h3>Lectura Cr√≠tica</h3>
                <button class="start-route-btn" data-target="LC.html">Iniciar Ruta</button>
            </div>
            <div class="module-card module-razonamiento">
                <h3>Razonamiento Cuantitativo</h3>
                <button class="start-route-btn" data-target="RC.html">Iniciar Ruta</button>
            </div>
            <div class="module-card module-ciudadanas">
                <h3>Competencias Ciudadanas</h3>
                <button class="start-route-btn" data-target="CC.html">Iniciar Ruta</button>
            </div>
            <div class="module-card module-ingles">
                <h3>Ingl√©s</h3>
                <button class="start-route-btn" data-target="I.html">Iniciar Ruta</button>
            </div>
        </section>

        <aside class="mascota-container">
            <div class="speech-bubble">
                <p>Selecciona una ruta que quieras aprender</p>
            </div>
            <img src="oso.jpeg" alt="Mascota Oso" class="mascota-img">
        </aside>
    </main>

    <!-- ADDED: Floating vertical icons -->
    <div class="floating-icons" aria-hidden="false">
        <button id="btn-misiones" title="Misiones">üéØ</button>
        <button id="btn-nivel" title="Nivel actual">‚≠ê</button>
        <button id="btn-progreso" title="Progreso">üìä</button>
        <button id="btn-analisis" title="An√°lisis">üìà</button>
    </div>

    <!-- ADDED: Panel Misiones -->
    <div class="panel-box" id="panel-misiones" aria-hidden="true">
        <div class="panel-header">
            <h3>Misiones</h3>
            <button class="close-panel" data-close="misiones">&times;</button>
        </div>
        <div id="misiones-content">
            <!-- missions list injected by JS -->
        </div>
    </div>

    <!-- ADDED: Panel Nivel -->
    <div class="panel-box" id="panel-nivel" aria-hidden="true">
        <div class="panel-header">
            <h3>Tu nivel</h3>
            <button class="close-panel" data-close="nivel">&times;</button>
        </div>
        <div id="nivel-content">
            <!-- level info injected by JS -->
        </div>
    </div>

    <!-- ADDED: Panel Progreso -->
    <div class="panel-box" id="panel-progreso" aria-hidden="true">
        <div class="panel-header">
            <h3>Progreso</h3>
            <button class="close-panel" data-close="progreso">&times;</button>
        </div>
        <div id="progreso-content">
            <!-- progress injected by JS -->
        </div>
    </div>

    <!-- ADDED: Panel Analisis -->
    <div class="panel-box" id="panel-analisis" aria-hidden="true">
        <div class="panel-header">
            <h3>An√°lisis (promedio 0‚Äì300)</h3>
            <button class="close-panel" data-close="analisis">&times;</button>
        </div>
        <div id="analisis-content">
            <!-- analysis injected by JS -->
            <div id="analisis-stats" style="margin-top:12px;"></div>
        </div>
    </div>

    <!-- ADDED: Toast notification for mission completed -->
    <div class="toast" id="mission-toast" role="status" aria-live="polite"></div>

    <script>
        /*************************************************************************
         *  LOCAL DATA: 100 missions (fixed values taken from the updated list)
         *  Each mission: { id, title, points, completed }
         *************************************************************************/
        const MISSIONS_KEY = 'skopia_missions_v1';
        // CAMBIO CLAVE: Ahora guardamos los puntajes usando el tag √∫nico del examen como clave.
        const EXAMS_KEY = 'skopia_exam_scores_by_tag_v1';

        const missionsTemplate = [
            { id: 1, title: "Completa tu primer examen", points: 50 },
            { id: 2, title: "Logra al menos 180/300 en un examen", points: 80 },
            { id: 3, title: "Lee toda la teor√≠a de una lecci√≥n", points: 40 },
            { id: 4, title: "Termina una sesi√≥n de estudio sin salir", points: 50 },
            { id: 5, title: "Gana tu primer juego", points: 50 },
            { id: 6, title: "Usa una pista o ayuda en un juego", points: 30 },
            { id: 7, title: "Repite un examen para mejorar tu nota", points: 50 },
            { id: 8, title: "Cambia tu nombre de usuario", points: 40 },
            { id: 9, title: "Acumula tus primeras 200 estrellas", points: 30 },
            { id: 10, title: "Completa 3 misiones seguidas", points: 50 },

            { id: 11, title: "Logra 240/300 en un examen", points: 150 },
            { id: 12, title: "Completa un examen sin errores (300/300)", points: 200 },
            { id: 13, title: "Gana 3 juegos distintos", points: 60 },
            { id: 14, title: "Termina una teor√≠a con ejemplo pr√°ctico", points: 40 },
            { id: 15, title: "Participa en una pr√°ctica de repaso", points: 30 },
            { id: 16, title: "Completa 2 ex√°menes el mismo d√≠a", points: 80 },
            { id: 17, title: "Obt√©n 500 estrellas acumuladas", points: 50 },
            { id: 18, title: "Gana un juego en menos de 2 minutos", points: 50 },
            { id: 19, title: "Repite un juego hasta mejorar tu resultado", points: 30 },
            { id: 20, title: "Completa todas las misiones del nivel 1", points: 100 },

            { id: 21, title: "Logra 270/300 en un examen", points: 180 },
            { id: 22, title: "Supera tu propia mejor nota", points: 60 },
            { id: 23, title: "Termina 5 juegos de pr√°ctica", points: 50 },
            { id: 24, title: "Lee toda la teor√≠a sin usar pistas", points: 40 },
            { id: 25, title: "Completa todos los subniveles de un tema (5/5)", points: 100 },
            { id: 26, title: "Suma 1000 estrellas totales", points: 50 },
            { id: 27, title: "Gana un examen con tiempo limitado", points: 80 },
            { id: 28, title: "Juega y gana el modo ‚Äúescape room‚Äù", points: 60 },
            { id: 29, title: "Completa un juego de ahorcado correctamente", points: 50 },
            { id: 30, title: "Haz un examen de repaso general", points: 70 },

            { id: 31, title: "Logra 300/300 en dos ex√°menes seguidos", points: 200 },
            { id: 32, title: "Completa todos los juegos de un m√≥dulo", points: 100 },
            { id: 33, title: "Termina la teor√≠a de un m√≥dulo completo", points: 80 },
            { id: 34, title: "Gana un juego tipo tablero", points: 60 },
            { id: 35, title: "Completa una misi√≥n cronometrada", points: 80 },
            { id: 36, title: "Obt√©n 2000 estrellas acumuladas", points: 60 },
            { id: 37, title: "Gana un juego sin usar pistas", points: 50 },
            { id: 38, title: "Revisa tu historial de progreso", points: 30 },
            { id: 39, title: "Completa 10 misiones seguidas sin fallar", points: 100 },
            { id: 40, title: "Termina un examen con todos los tiempos perfectos", points: 150 },

            { id: 41, title: "Completa 5 ex√°menes con m√°s de 240/300", points: 150 },
            { id: 42, title: "Termina todos los subniveles del nivel 6", points: 140 },
            { id: 43, title: "Consigue 3000 estrellas", points: 120 },
            { id: 44, title: "Estudia 10 d√≠as seguidos", points: 130 },
            { id: 45, title: "Completa 10 misiones", points: 140 },
            { id: 46, title: "Llega al nivel 6.5", points: 130 },
            { id: 47, title: "Termina un examen sin errores", points: 150 },
            { id: 48, title: "Supera tu propio puntaje anterior", points: 140 },
            { id: 49, title: "Contesta 500 preguntas", points: 130 },
            { id: 50, title: "Completa un examen en menos de 25 minutos", points: 140 },

            { id: 51, title: "Alcanza el top 10 por primera vez (local)", points: 150 },
            { id: 52, title: "Mantente en el top 10 por 3 d√≠as (local)", points: 140 },
            { id: 53, title: "Gana 4000 estrellas", points: 130 },
            { id: 54, title: "Termina la ruta RC con promedio ‚â•200", points: 140 },
            { id: 55, title: "Termina la ruta LC con promedio ‚â•200", points: 140 },
            { id: 56, title: "Termina la ruta CC con promedio ‚â•200", points: 140 },
            { id: 57, title: "Obt√©n 250 puntos o m√°s en tres rutas", points: 150 },
            { id: 58, title: "Crea una racha de 20 aciertos seguidos", points: 140 },
            { id: 59, title: "Completa 15 misiones", points: 130 },
            { id: 60, title: "Alcanza el nivel 7", points: 150 },

            { id: 61, title: "Consigue 6000 estrellas", points: 160 },
            { id: 62, title: "Estudia 20 d√≠as seguidos", points: 170 },
            { id: 63, title: "Termina todos los niveles de una ruta (10/10)", points: 180 },
            { id: 64, title: "Contesta 1000 preguntas", points: 160 },
            { id: 65, title: "Supera a 5 usuarios en el ranking (local)", points: 170 },
            { id: 66, title: "Alcanza el nivel 8", points: 170 },
            { id: 67, title: "Termina 20 misiones", points: 160 },
            { id: 68, title: "Obt√©n promedio ‚â•250 puntos en una ruta", points: 180 },
            { id: 69, title: "Logra 5 ex√°menes con 250 o m√°s puntos", points: 170 },
            { id: 70, title: "Termina las rutas RC y LC completas", points: 180 },

            { id: 71, title: "Mantente en el top 5 (local)", points: 170 },
            { id: 72, title: "Completa todos los subniveles (50 total)", points: 180 },
            { id: 73, title: "Gana 8000 estrellas", points: 160 },
            { id: 74, title: "Termina 25 misiones", points: 170 },
            { id: 75, title: "Sube de nivel sin fallar un examen", points: 160 },
            { id: 76, title: "Obt√©n 280 puntos en un examen", points: 180 },
            { id: 77, title: "Completa 10 ex√°menes sin pistas", points: 170 },
            { id: 78, title: "Obt√©n 270 o m√°s en las tres rutas", points: 180 },
            { id: 79, title: "Alcanza el nivel 9", points: 180 },
            { id: 80, title: "Termina 30 misiones", points: 170 },

            { id: 81, title: "Gana 10,000 estrellas", points: 190 },
            { id: 82, title: "Mantente en el top 3 (local)", points: 190 },
            { id: 83, title: "Termina las tres rutas con promedio ‚â•250", points: 190 },
            { id: 84, title: "Completa los 50 subniveles con m√°s de 200 puntos promedio", points: 200 },
            { id: 85, title: "Llega al nivel 10", points: 200 },
            { id: 86, title: "Gana 15,000 estrellas", points: 200 },
            { id: 87, title: "Mantente en el top 3 por 7 d√≠as (local)", points: 190 },
            { id: 88, title: "Consigue 300 puntos en un examen", points: 200 },
            { id: 89, title: "Termina 40 misiones", points: 190 },
            { id: 90, title: "Completa todos los ex√°menes de pr√°ctica", points: 190 },

            { id: 91, title: "Llega a 20,000 estrellas", points: 200 },
            { id: 92, title: "Termina 50 misiones", points: 190 },
            { id: 93, title: "Mantente en el top 1 por 3 d√≠as (local)", points: 200 },
            { id: 94, title: "Termina todas las rutas al 100%", points: 200 },
            { id: 95, title: "Obt√©n todas las medallas", points: 190 },
            { id: 96, title: "Consigue 25,000 estrellas", points: 200 },
            { id: 97, title: "Cumple todas las misiones b√°sicas e intermedias", points: 190 },
            { id: 98, title: "Mantente activo 30 d√≠as seguidos", points: 200 },
            { id: 99, title: "Llega a 30,000 estrellas", points: 200 },
            { id: 100, title: "üèÜ Maestro del Saber Pro: completa todo el sistema", points: 200 }
        ];

        // Level thresholds as defined earlier
        const LEVELS = [
            { idx: 1, name: "Novato/a", min: 0, max: 299 },
            { idx: 2, name: "Aprendiz/a", min: 300, max: 799 },
            { idx: 3, name: "Explorador/a", min: 800, max: 1499 },
            { idx: 4, name: "Analista", min: 1500, max: 2499 },
            { idx: 5, name: "Estratega", min: 2500, max: 3699 },
            { idx: 6, name: "Sabio/a", min: 3700, max: 4999 },
            { idx: 7, name: "Maestro/a", min: 5000, max: 6499 },
            { idx: 8, name: "√âlite", min: 6500, max: 7999 },
            { idx: 9, name: "Leyenda", min: 8000, max: 9499 },
            { idx: 10, name: "Rey/Reina Sk√≥pia", min: 9500, max: Infinity }
        ];

        // Initialize missions in localStorage if not present (keep any existing)
        function initMissions() {
            const stored = localStorage.getItem(MISSIONS_KEY);
            if (!stored) {
                const initial = missionsTemplate.map(m => ({ ...m, completed: false }));
                localStorage.setItem(MISSIONS_KEY, JSON.stringify(initial));
            }
        }

        // Render missions into panel - solo muestra las primeras 3 no completadas
        function renderMissions() {
            const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
            const container = document.getElementById('misiones-content');
            container.innerHTML = '';
            
            // Filtrar solo las misiones no completadas y tomar las primeras 3
            const incompleteMissions = data.filter(m => !m.completed).slice(0, 3);
            
            if (incompleteMissions.length === 0) {
                container.innerHTML = '<div class="info">¬°Felicidades! Has completado todas las misiones disponibles.</div>';
                return;
            }
            
            incompleteMissions.forEach(m => {
                const div = document.createElement('div');
                div.className = 'mission-row';
                div.innerHTML = `
                    <div style="flex:1">
                        <div style="font-weight:700; color:var(--color-oliva-oscuro)">${m.id}. ${m.title}</div>
                        <div style="font-size:1rem; color:#556b2f">${m.points} ‚≠ê</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Sistema de notificaciones de misiones - muestra una por una
        let missionNotificationQueue = [];
        let isShowingNotification = false;

        function queueMissionNotification(mission) {
            missionNotificationQueue.push(mission);
            if (!isShowingNotification) {
                processMissionQueue();
            }
        }

        function processMissionQueue() {
            if (missionNotificationQueue.length === 0) {
                isShowingNotification = false;
                return;
            }
            
            isShowingNotification = true;
            const mission = missionNotificationQueue.shift();
            showMissionToast(`¬°Nueva misi√≥n disponible: ${mission.title} (+${mission.points}‚≠ê)!`, 60000);
            
            setTimeout(() => {
                processMissionQueue();
            }, 61000); // Espera un poco m√°s de 60 segundos para asegurar que la notificaci√≥n anterior se haya cerrado
        }

        // Inicializar notificaciones de misiones al cargar la p√°gina
        function initMissionNotifications() {
            const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
            const incompleteMissions = data.filter(m => !m.completed).slice(0, 3);
            
            // Agregar las primeras 3 misiones no completadas a la cola de notificaciones
            incompleteMissions.forEach(mission => {
                queueMissionNotification(mission);
            });
        }

        // Toast show/hide
        let toastTimer = null;
        function showMissionToast(text, ms = 60000) {
            const toast = document.getElementById('mission-toast');
            toast.innerHTML = `<strong>${text}</strong> <div style="font-size:0.9rem;margin-top:6px;color:#666">Se ocultar√° en ${Math.ceil(ms/1000)}s</div>`;
            toast.classList.add('show');
            // countdown update (optional)
            let remaining = ms;
            if (toastTimer) clearInterval(toastTimer);
            toastTimer = setInterval(() => {
                remaining -= 1000;
                if (remaining <= 0) {
                    toast.classList.remove('show');
                    clearInterval(toastTimer);
                } else {
                    toast.innerHTML = `<strong>${text}</strong> <div style="font-size:0.9rem;margin-top:6px;color:#666">Se ocultar√° en ${Math.ceil(remaining/1000)}s</div>`;
                }
            }, 1000);
            // ensure hide after ms
            setTimeout(()=> {
                toast.classList.remove('show');
                if (toastTimer) { clearInterval(toastTimer); toastTimer = null; }
            }, ms + 200);
        }

        // Compute total points from completed missions
        function getTotalPoints() {
            const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
            return data.reduce((sum, m) => sum + (m.completed ? m.points : 0), 0);
        }

        // Determine current level based on total points using LEVELS
        function getLevelFromPoints(total) {
            for (let i = LEVELS.length -1; i >=0; i--) {
                if (total >= LEVELS[i].min) return LEVELS[i];
            }
            return LEVELS[0];
        }

        // Render level panel content
        function renderLevel() {
            const total = getTotalPoints();
            const level = getLevelFromPoints(total);
            // compute progress to next level
            let nextMin = level.max === Infinity ? level.min : level.max + 1;
            let neededForNext = (level.max === Infinity) ? 0 : (level.max - total + 1);
            let progressPct = 0;
            if (level.max === Infinity) progressPct = 100;
            else progressPct = Math.min(100, Math.round(((total - level.min) / (level.max - level.min)) * 100));
            document.getElementById('nivel-content').innerHTML = `
                <div class="info"><strong>Nivel:</strong> ${level.name} (${level.idx})</div>
                <div class="info"><strong>Puntos acumulados:</strong> ${total} ‚≠ê</div>
                <div class="info"><strong>Progreso hacia siguiente nivel:</strong> ${progressPct}%</div>
                <div style="background:#f1f1f1;border-radius:10px;padding:8px;margin-top:10px">
                    <div style="height:12px;background:linear-gradient(90deg,var(--color-oliva-medio),#bdbd74);width:${progressPct}%;border-radius:8px"></div>
                </div>
                ${level.max === Infinity ? '<div class="info" style="margin-top:8px">¬°Has alcanzado el nivel m√°ximo!</div>' : `<div class="info" style="margin-top:8px">Puntos para subir: ${neededForNext} ‚≠ê</div>`}
            `;
        }

        // Render progress panel: percent toward top target (9500 = Rey/Reina)
        function renderProgress() {
            const total = getTotalPoints();
            const topTarget = 9500; // based on level thresholds
            const pct = Math.min(100, Math.round((total / topTarget) * 100));
            document.getElementById('progreso-content').innerHTML = `
                <div class="info"><strong>Puntos acumulados:</strong> ${total} ‚≠ê</div>
                <div class="info"><strong>Progreso global hacia Rey/Reina:</strong> ${pct}%</div>
                <div style="background:#f1f1f1;border-radius:10px;padding:8px;margin-top:10px">
                    <div style="height:12px;background:linear-gradient(90deg,var(--color-oliva-medio),#bdbd74);width:${pct}%;border-radius:8px"></div>
                </div>
                <div class="info" style="margin-top:10px"><strong>Misiones completadas:</strong> ${getCompletedCount()}/100</div>
            `;
        }

        function getCompletedCount() {
            const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
            return data.filter(m => m.completed).length;
        }

        /*************************************************************************
         *  SISTEMA DE EX√ÅMENES BASADO EN TAGS (CORREGIDO)
         *************************************************************************/

        // Ahora la funci√≥n guarda el puntaje de un examen espec√≠fico usando su tag √∫nico.
        // examTag: Un string √∫nico, ej: 'RC-razonamiento-logico' o 'diagnostico'
        // score: 0 - 300
        function addExamScore(examTag, score) {
            if (!examTag || typeof score !== 'number' || score < 0 || score > 300) {
                console.error("Puntaje de examen inv√°lido.", { examTag, score });
                return false;
            }

            // Obtenemos el objeto de puntajes actual (si no hay, usamos uno vac√≠o)
            let examScores = JSON.parse(localStorage.getItem(EXAMS_KEY) || '{}');

            // Actualizamos SOLO el puntaje del examen con el tag correspondiente.
            // Si el examen se repite, este valor se sobrescribe.
            examScores[examTag] = score;

            // Guardamos el objeto actualizado
            localStorage.setItem(EXAMS_KEY, JSON.stringify(examScores));
            console.log(`Puntaje para el examen '${examTag}' actualizado a ${score}.`);
            return true;
        }

        // Calcula el promedio de TODOS los ex√°menes, excepto 'diagnostico'.
        function getExamStats() {
            const examScores = JSON.parse(localStorage.getItem(EXAMS_KEY) || '{}');
            
            // Filtramos para excluir el examen de diagn√≥stico del promedio
            const { diagnostico, ...otherExams } = examScores;
            const scores = Object.values(otherExams); // Obtenemos una lista de los puntajes de los ex√°menes normales

            if (scores.length === 0) {
                return { 
                    count: 0, 
                    sum: 0, 
                    avg: 0, 
                    details: otherExams,
                    diagnosticScore: diagnostico || 'N/A' // Mostramos el puntaje del diagn√≥stico por separado
                };
            }

            const sum = scores.reduce((a, b) => a + b, 0);
            const avg = Math.round(sum / scores.length);

            return {
                count: scores.length, // N√∫mero de ex√°menes (sin contar diagn√≥stico)
                sum: sum,
                avg: avg,
                details: otherExams, // Puntajes de todos los ex√°menes excepto diagn√≥stico
                diagnosticScore: diagnostico || 'N/A' // Puntaje del diagn√≥stico
            };
        }

        function renderAnalysis() {
            const stats = getExamStats();
            
            // Mostramos el puntaje del diagn√≥stico de forma destacada
            let diagnosticHtml = `<div class="info"><strong>Puntaje Inicial (Diagn√≥stico):</strong> ${stats.diagnosticScore} / 300</div>`;
            
            let detailsHtml = '';
            // Mostramos los detalles de los ex√°menes normales
            for (const tag in stats.details) {
                detailsHtml += `<div class="info" style="font-size:1rem; color:#555;">- ${tag}: ${stats.details[tag]} / 300</div>`;
            }

            document.getElementById('analisis-stats').innerHTML = `
                ${diagnosticHtml}
                <hr style="margin: 12px 0; border: none; border-top: 1px solid #eee;">
                <div class="info"><strong>Ex√°menes de pr√°ctica realizados:</strong> ${stats.count}</div>
                <div class="info"><strong>Suma de puntajes (pr√°ctica):</strong> ${stats.sum}</div>
                <div class="info"><strong>Promedio general (pr√°ctica):</strong> ${stats.avg} / 300</div>
                <hr style="margin: 12px 0; border: none; border-top: 1px solid #eee;">
                <div style="font-weight: bold; margin-bottom: 8px;">√öltimos Puntajes por Examen:</div>
                ${detailsHtml || '<div class="info" style="color:#888;">A√∫n no hay ex√°menes de pr√°ctica registrados.</div>'}
                <div style="margin-top:10px;">
                    <button id="clear-exams" style="background:var(--float-color); color:white; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; font-size:1rem;">Borrar todos los puntajes</button>
                </div>
            `;
            document.getElementById('clear-exams').addEventListener('click', () => {
                if (confirm('¬øEliminar todos los puntajes de ex√°menes registrados?')) {
                    localStorage.removeItem(EXAMS_KEY);
                    renderAnalysis();
                }
            });
        }

        // Ahora las misiones se verifican con el puntaje del examen espec√≠fico.
        function checkExamMissions(examTag, score) {
            const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
            let changed = false;

            // Misi√≥n 1: "Completa tu primer examen" (que no sea de diagn√≥stico)
            if (examTag !== 'diagnostico' && score > 0) {
                const m1 = data.find(m => m.id === 1);
                if (m1 && !m1.completed) {
                    completeMission(1);
                    changed = true;
                }
            }
            // Misi√≥n 2: "Logra al menos 180/300 en un examen"
            if (score >= 180) {
                const m2 = data.find(m => m.id === 2);
                if (m2 && !m2.completed) {
                    completeMission(2);
                    changed = true;
                }
            }
            // Misi√≥n 11: "Logra 240/300 en un examen"
            if (score >= 240) {
                const m11 = data.find(m => m.id === 11);
                if (m11 && !m11.completed) {
                    completeMission(11);
                    changed = true;
                }
            }
            // Misi√≥n 12: "Completa un examen sin errores (300/300)"
            if (score === 300) {
                const m12 = data.find(m => m.id === 12);
                if (m12 && !m12.completed) {
                    completeMission(12);
                    changed = true;
                }
            }
            if (changed) updateAllDisplays();
        }

        // UI: open/close panels
        function closeAllPanels() {
            document.querySelectorAll('.panel-box').forEach(p => p.classList.remove('active'));
        }

        document.getElementById('btn-misiones').addEventListener('click', ()=> {
            togglePanelBox('panel-misiones');
        });
        document.getElementById('btn-nivel').addEventListener('click', ()=> {
            togglePanelBox('panel-nivel');
        });
        document.getElementById('btn-progreso').addEventListener('click', ()=> {
            togglePanelBox('panel-progreso');
        });
        document.getElementById('btn-analisis').addEventListener('click', ()=> {
            togglePanelBox('panel-analisis');
            renderAnalysis();
        });

        document.querySelectorAll('.close-panel').forEach(btn=>{
            btn.addEventListener('click', (e)=>{
                const parent = e.currentTarget.closest('.panel-box');
                if (parent) parent.classList.remove('active');
            });
        });

        function togglePanelBox(id) {
            const el = document.getElementById(id);
            if (!el) return;
            const isActive = el.classList.contains('active');
            closeAllPanels();
            if (!isActive) {
                el.classList.add('active');
                // render relevant content
                if (id === 'panel-misiones') renderMissions();
                if (id === 'panel-nivel') renderLevel();
                if (id === 'panel-progreso') renderProgress();
                if (id === 'panel-analisis') renderAnalysis();
            }
        }

        // Funci√≥n para marcar autom√°ticamente una misi√≥n como completada
        function completeMission(id) {
            const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
            const idx = data.findIndex(m => m.id === id);
            if (idx === -1) return;
            const mission = data[idx];
            if (!mission.completed) {
                mission.completed = true;
                localStorage.setItem(MISSIONS_KEY, JSON.stringify(data));
                showMissionToast(`¬°Misi√≥n completada: ${mission.title} (+${mission.points}‚≠ê)!`, 60000);
                updateAllDisplays();
                
                // Verificar si hay nuevas misiones para mostrar
                const incompleteMissions = data.filter(m => !m.completed).slice(0, 3);
                if (incompleteMissions.length > 0) {
                    queueMissionNotification(incompleteMissions[0]);
                }
            }
        }

        // update all displayed panels' content
        function updateAllDisplays() {
            if (document.getElementById('panel-misiones').classList.contains('active')) renderMissions();
            if (document.getElementById('panel-nivel').classList.contains('active')) renderLevel();
            if (document.getElementById('panel-progreso').classList.contains('active')) renderProgress();
            if (document.getElementById('panel-analisis').classList.contains('active')) renderAnalysis();
        }

        // initial setup
        (function init() {
            initMissions();
            // attach click outside to close panels
            document.addEventListener('click', (e)=>{
                const panels = document.querySelectorAll('.panel-box');
                const isIcon = e.target.closest('.floating-icons');
                const isPanel = e.target.closest('.panel-box');
                if (!isIcon && !isPanel) {
                    panels.forEach(p => p.classList.remove('active'));
                }
            });
            // show mission count badge on icon? (optional)
            renderMissions(); // prepare data
            renderLevel();
            renderProgress();
            renderAnalysis();
            
            // Inicializar sistema de notificaciones de misiones
            initMissionNotifications();
        })();

        // expose functions for other pages to push exam scores or mark missions programmatically:
        window.SKOPIA = {
            addExamScore, // Ahora requiere (examTag, score)
            completeMission,
            getTotalPoints: getTotalPoints,
            getLevel: ()=> getLevelFromPoints(getTotalPoints())
        };
    </script>

    <!-- ORIGINAL SCRIPTS (kept unchanged) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const hamburgerMenu = document.getElementById('hamburger-menu');
            const userDropdown = document.getElementById('user-dropdown');
            hamburgerMenu.addEventListener('click', () => {
                userDropdown.classList.toggle('active');
            });
            window.addEventListener('click', (event) => {
                if (!event.target.closest('.navbar')) {
                    userDropdown.classList.remove('active');
                }
            });

            const clockElement = document.getElementById('digital-clock');
            let lastHour = -1;
            function updateClock() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                const currentHour = now.getHours();
                if (currentHour !== lastHour) {
                    clockElement.classList.add('hour-change');
                    setTimeout(() => {
                        clockElement.textContent = `${hours}:${minutes}:${seconds}`;
                        clockElement.classList.remove('hour-change');
                    }, 300);
                    lastHour = currentHour;
                } else {
                    clockElement.textContent = `${hours}:${minutes}:${seconds}`;
                }
            }
            updateClock();
            setInterval(updateClock, 1000);

            const quotes = [
                "El estudio es la llave que abre las puertas del futuro.",
                "Cada d√≠a es una nueva oportunidad para aprender algo nuevo.",
                "El conocimiento es poder, pero la curiosidad es la chispa que lo enciende.",
                "No tengas miedo a cometer errores, ten miedo a no intentar.",
                "El experto en algo fue una vez un principiante.",
                "El √©xito es la suma de peque√±os esfuerzos repetidos d√≠a tras d√≠a."
            ];
            let currentQuoteIndex = 0;
            const quoteElement = document.getElementById('motivational-quote');
            function changeQuote() {
                quoteElement.style.animation = 'none';
                setTimeout(() => {
                    quoteElement.textContent = quotes[currentQuoteIndex];
                    quoteElement.style.animation = 'fadeIn 1s forwards';
                }, 20);
                currentQuoteIndex = (currentQuoteIndex + 1) % quotes.length;
            }
            changeQuote();
            setInterval(changeQuote, 120000);

            const routeButtons = document.querySelectorAll('.start-route-btn');
            routeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetPage = button.getAttribute('data-target');
                    if (targetPage) {
                        window.location.href = targetPage;
                    }
                });
            });
        });
    </script>
</body>
</html>

