<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agente del Lenguaje - Sk√≥pia</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Roboto:wght@400;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBGEwwuGLP0ULmsJkAhwwmNSlWAotGu_wY",
            projectId: "skopia-aa786",
            storageBucket: "skopia-aa786.firebasestorage.app",
            messagingSenderId: "719823055099",
            appId: "1:719823055099:web:7d91ea29e4b2dcbb9b685e"
        };

        if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
            firebaseConfig.authDomain = "localhost";
        } else {
            firebaseConfig.authDomain = "skopia-aa786.firebaseapp.com";
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.auth = auth;

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            window.dispatchEvent(new CustomEvent('userReady', { detail: { user } }));
        });
    </script>

    <style>
        :root {
            --color-crema: #fdfbf5;
            --color-oliva-claro: #bec092;
            --color-oliva-medio: #5a6133;
            --color-oliva-oscuro: #272b00;
            --color-sombra: rgba(39, 43, 0, 0.1);
            --float-color: var(--color-oliva-oscuro);
            --float-color-hover: var(--color-oliva-medio);
            --detective-blue: #1a3a52;
            --detective-gold: #d4af37;
            --detective-paper: #f5f1e8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--color-crema) 0%, #f5efe5 100%);
            color: var(--color-oliva-oscuro);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- NAVBAR --- */
        .navbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 15px 40px;
            background-color: white;
            box-shadow: 0 2px 10px var(--color-sombra);
        }
        .hamburger {
            width: 30px;
            height: 25px;
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .hamburger span {
            display: block;
            height: 4px;
            width: 100%;
            background-color: var(--color-oliva-oscuro);
            border-radius: 2px;
            transition: all 0.3s ease-in-out;
        }
        .user-dropdown {
            position: absolute;
            top: 70px;
            right: 40px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px var(--color-sombra);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.3s, transform 0.3s, visibility 0.3s;
            z-index: 1000;
        }
        .user-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .user-dropdown a {
            display: block;
            padding: 15px 25px;
            text-decoration: none;
            color: var(--color-oliva-oscuro);
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .user-dropdown a:hover {
            background-color: var(--color-crema);
        }
        .user-dropdown hr {
            border: none;
            border-top: 1px solid #eee;
            margin: 0;
        }

        /* --- GAME CONTAINER --- */
        .game-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 40px;
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* --- GAME PHASES --- */
        .game-phase {
            width: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
        }
        .game-phase.active {
            display: flex;
        }

        /* --- INTRO SCREEN --- */
        .intro-screen {
            text-align: center;
            background-color: var(--detective-paper);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 2px solid var(--detective-blue);
            max-width: 800px;
        }
        .intro-screen h1 {
            font-family: 'Orbitron', sans-serif;
            color: var(--detective-blue);
            margin-bottom: 20px;
            font-size: 2.5rem;
        }
        .intro-screen p {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 30px;
            color: var(--color-oliva-oscuro);
        }
        .start-game-btn {
            background-color: var(--detective-blue);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-family: 'Patrick Hand', cursive;
        }
        .start-game-btn:hover {
            background-color: #0f2338;
            transform: scale(1.05);
        }

        /* --- PHASE 1: SUMMARY SELECTION --- */
        .phase-1-container {
            width: 100%;
            background-color: var(--detective-paper);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 2px solid var(--detective-blue);
        }
        .file-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--detective-blue);
        }
        .file-icon {
            font-size: 2rem;
            color: var(--detective-blue);
            margin-right: 15px;
        }
        .file-title {
            font-family: 'Patrick Hand', cursive;
            font-size: 1.8rem;
            color: var(--detective-blue);
        }
        .secret-text {
            background-color: rgba(26, 58, 82, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            font-size: 1.1rem;
            line-height: 1.6;
            position: relative;
        }
        .hint-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--detective-gold);
            color: var(--detective-blue);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: transform 0.2s;
        }
        .hint-btn:hover {
            transform: scale(1.1);
        }
        .hint-used .secret-text {
            background-color: rgba(212, 175, 55, 0.2);
        }
        .hint-used .secret-text .highlighted {
            background-color: rgba(212, 175, 55, 0.4);
            padding: 2px 4px;
            border-radius: 3px;
        }
        .summaries-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .summary-card {
            background-color: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .summary-card:hover {
            border-color: var(--detective-blue);
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .summary-card.correct {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }
        .summary-card.incorrect {
            border-color: #F44336;
            background-color: rgba(244, 67, 54, 0.1);
        }
        .summary-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--detective-blue);
        }
        .summary-text {
            font-size: 1rem;
            line-height: 1.4;
        }
        .phase-btn {
            background-color: var(--detective-blue);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            margin-top: 20px;
            font-family: 'Patrick Hand', cursive;
            display: none;
        }
        .phase-btn.show {
            display: block;
        }
        .phase-btn:hover {
            background-color: #0f2338;
            transform: scale(1.05);
        }

        /* --- PHASE 2: CONNECTORS --- */
        .phase-2-container {
            width: 100%;
            background-color: var(--detective-paper);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 2px solid var(--detective-blue);
        }
        .encrypted-text {
            background-color: rgba(26, 58, 82, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            font-size: 1.1rem;
            line-height: 1.6;
            position: relative;
        }
        .encrypted-text.decrypted {
            background-color: rgba(76, 175, 80, 0.1);
            border: 1px solid #4CAF50;
        }
        .drop-zone {
            display: inline-block;
            width: 120px;
            height: 30px;
            border-bottom: 2px dashed var(--detective-blue);
            margin: 0 5px;
            vertical-align: middle;
            position: relative;
        }
        .drop-zone.filled {
            border-bottom: 2px solid #4CAF50;
        }
        .connectors-tray {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(26, 58, 82, 0.05);
            border-radius: 10px;
        }
        .connector {
            background-color: white;
            border: 1px solid var(--detective-blue);
            border-radius: 20px;
            padding: 8px 15px;
            cursor: move;
            transition: all 0.3s;
        }
        .connector:hover {
            background-color: var(--detective-blue);
            color: white;
        }
        .connector.dragging {
            opacity: 0.5;
        }
        .connector.used {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* --- PHASE 3: AUTHENTIC VERSION --- */
        .phase-3-container {
            width: 100%;
            background-color: var(--detective-paper);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 2px solid var(--detective-blue);
        }
        .versions-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .version-card {
            background-color: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .version-card:hover {
            border-color: var(--detective-blue);
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .version-card.correct {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }
        .version-card.incorrect {
            border-color: #F44336;
            background-color: rgba(244, 67, 54, 0.1);
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* --- PHASE 4: PRONOUNS --- */
        .phase-4-container {
            width: 100%;
            background-color: var(--detective-paper);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 2px solid var(--detective-blue);
        }
        .pronoun-text {
            background-color: rgba(26, 58, 82, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        .pronoun {
            color: var(--detective-blue);
            font-weight: bold;
            cursor: pointer;
            position: relative;
            text-decoration: underline;
            text-decoration-style: dotted;
        }
        .pronoun-options {
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            border: 1px solid var(--detective-blue);
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 100;
            display: none;
            min-width: 200px;
        }
        .pronoun-options.show {
            display: block;
        }
        .pronoun-option {
            padding: 5px 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .pronoun-option:hover {
            background-color: rgba(26, 58, 82, 0.1);
        }
        .pronoun-option.correct {
            color: #4CAF50;
            font-weight: bold;
        }
        .connection-line {
            position: absolute;
            background-color: var(--detective-gold);
            height: 2px;
            transform-origin: left center;
            z-index: 1;
            pointer-events: none;
        }

        /* --- PHASE 5: IDEA NETWORK --- */
        .phase-5-container {
            width: 100%;
            background-color: var(--detective-paper);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 2px solid var(--detective-blue);
        }
        .network-board {
            position: relative;
            width: 100%;
            height: 500px;
            background-color: rgba(26, 58, 82, 0.05);
            border-radius: 10px;
            margin-top: 20px;
            overflow: hidden;
        }
        .idea-bubble {
            position: absolute;
            background-color: white;
            border: 2px solid var(--detective-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 15px;
            cursor: move;
            transition: all 0.3s;
            font-size: 0.9rem;
            max-width: 150px;
            z-index: 2;
        }
        .idea-bubble.main {
            background-color: var(--detective-blue);
            color: white;
            font-weight: bold;
            width: 180px;
            height: 180px;
            font-size: 1.1rem;
        }
        .idea-bubble.secondary {
            width: 120px;
            height: 120px;
        }
        .idea-bubble.distractor {
            border-color: #ccc;
            color: #888;
        }
        .idea-bubble:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .idea-bubble.connected {
            border-color: var(--detective-gold);
            background-color: rgba(212, 175, 55, 0.1);
        }
        .network-board.completed {
            background-color: rgba(76, 175, 80, 0.1);
            border: 1px solid #4CAF50;
        }
        .network-connection {
            position: absolute;
            background-color: var(--detective-gold);
            height: 2px;
            transform-origin: left center;
            z-index: 1;
            pointer-events: none;
        }

        /* --- COMPLETION SCREEN --- */
        .completion-screen {
            text-align: center;
            background-color: var(--detective-paper);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 2px solid var(--detective-blue);
            max-width: 800px;
            display: none;
        }
        .completion-screen.show {
            display: block;
        }
        .badge {
            width: 150px;
            height: 150px;
            background-color: var(--detective-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .badge i {
            font-size: 4rem;
            color: var(--detective-blue);
        }
        .completion-screen h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--detective-blue);
            margin-bottom: 20px;
            font-size: 2.5rem;
        }
        .completion-screen p {
            font-size: 1.2rem;
            line-height: 1.6;
            margin-bottom: 30px;
            color: var(--color-oliva-oscuro);
        }
        .exit-game-btn {
            background-color: var(--detective-blue);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-family: 'Patrick Hand', cursive;
        }
        .exit-game-btn:hover {
            background-color: #0f2338;
            transform: scale(1.05);
        }

        /* --- FLOATING ICONS & PANELS --- */
        .floating-icons {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 2000;
        }
        .floating-icons button {
            background: var(--float-color);
            color: white;
            width: 54px;
            height: 54px;
            border-radius: 50%;
            border: none;
            font-size: 20px;
            display: grid;
            place-items: center;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            cursor: pointer;
            transition: transform .15s ease, background .15s ease;
        }
        .floating-icons button:hover { transform: scale(1.08); background: var(--float-color-hover); }

        .panel-box {
            position: fixed;
            right: 90px;
            top: 50%;
            transform: translateY(-50%);
            width: 420px;
            max-height: 75vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.12);
            overflow: auto;
            padding: 24px;
            z-index: 2100;
            display: none;
            font-family: 'Patrick Hand', cursive;
            font-size: 1.2rem;
        }
        .panel-box.active { display: block; }

        .panel-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .panel-header h3 { margin:0; font-size:1.6rem; color:var(--color-oliva-oscuro); }
        .close-panel { background:none; border:none; font-size:1.4rem; cursor:pointer; color:var(--color-oliva-medio); }

        .mission-row { padding:12px; border-radius:8px; margin-bottom:10px; background:#fffaf0; box-shadow: 0 2px 6px rgba(0,0,0,0.04); display:flex; justify-content:space-between; align-items:center; }
        .mission-row.completed { opacity:0.6; text-decoration:line-through; background:#f0fff4; }

        .toast {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: #fff7e6;
            border-left: 6px solid var(--color-oliva-medio);
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            z-index: 3000;
            display: none;
            font-size: 1.1rem;
            max-width: 400px;
        }
        .toast.show { display: block; }

        .info { font-family: 'Roboto', sans-serif; color:var(--color-oliva-oscuro); font-size:1.1rem; margin-bottom:12px; }

        /* --- TIMER --- */
        .game-timer {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: var(--detective-blue);
            color: white;
            padding: 10px 15px;
            border-radius: 30px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        @media (max-width: 1024px) {
            .game-container { padding: 20px; }
            .panel-box { right: 10px; width: 92%; top: 55%; transform: translateY(-55%); }
            .floating-icons { right: 10px; }
            .summaries-container, .versions-container { grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="hamburger" id="hamburger-menu">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="user-dropdown" id="user-dropdown">
            <a href="cuenta.html">Mi Cuenta</a>
            <a href="configuracion.html">Configuraci√≥n</a>
            <a href="notificaciones.html">Notificaciones</a>
            <hr>
            <a href="index.html" id="logout-btn">Cerrar Sesi√≥n</a>
        </div>
    </nav>

    <div class="game-container">
        <div class="game-timer" id="game-timer">00:00</div>
        
        <!-- INTRO SCREEN -->
        <div class="game-phase active" id="intro-phase">
            <div class="intro-screen">
                <h1>Agente del Lenguaje</h1>
                <p>Eres un agente secreto del conocimiento que trabaja en la Agencia del Lenguaje.</p>
                <p>Tu misi√≥n: descifrar mensajes cifrados (textos) para descubrir informaci√≥n clave.</p>
                <p>Cada texto tiene "errores" o "lagunas de sentido", y t√∫ debes usar tus habilidades de comprensi√≥n literal para reconstruirlo.</p>
                <button class="start-game-btn" id="start-game-btn">Comenzar Misi√≥n</button>
            </div>
        </div>

        <!-- PHASE 1: SUMMARY SELECTION -->
        <div class="game-phase" id="phase-1">
            <div class="phase-1-container">
                <div class="file-header">
                    <div class="file-icon"><i class="fas fa-file-secret"></i></div>
                    <div class="file-title">Archivo Secreto #001</div>
                </div>
                <div class="secret-text" id="secret-text">
                    El cambio clim√°tico es uno de los mayores desaf√≠os que enfrenta la humanidad en el siglo XXI. Los cient√≠ficos han demostrado que las actividades humanas, especialmente la quema de combustibles f√≥siles, han aumentado significativamente las concentraciones de gases de efecto invernadero en la atm√≥sfera. Estos gases atrapan el calor del sol, causando un aumento de la temperatura global. Este calentamiento tiene consecuencias graves: derretimiento de glaciares, aumento del nivel del mar, eventos clim√°ticos extremos y p√©rdida de biodiversidad. Para mitigar estos efectos, es necesario reducir las emisiones de gases de efecto invernadero mediante la transici√≥n a energ√≠as renovables, la mejora de la eficiencia energ√©tica y cambios en los patrones de consumo y producci√≥n.
                    <button class="hint-btn" id="hint-btn-1" title="Usar lupa (pista)"><i class="fas fa-search"></i></button>
                </div>
                <h3>Selecciona el resumen correcto de la misi√≥n:</h3>
                <div class="summaries-container">
                    <div class="summary-card" data-correct="false">
                        <div class="summary-title">Resumen A</div>
                        <div class="summary-text">El cambio clim√°tico es un fen√≥meno natural que ha ocurrido a lo largo de la historia de la Tierra sin intervenci√≥n humana.</div>
                    </div>
                    <div class="summary-card" data-correct="true">
                        <div class="summary-title">Resumen B</div>
                        <div class="summary-text">Las actividades humanas han aumentado los gases de efecto invernadero, causando calentamiento global con consecuencias graves que requieren acci√≥n para mitigar.</div>
                    </div>
                    <div class="summary-card" data-correct="false">
                        <div class="summary-title">Resumen C</div>
                        <div class="summary-text">La √∫nica soluci√≥n al cambio clim√°tico es dejar de usar cualquier tipo de energ√≠a y volver a un estilo de vida preindustrial.</div>
                    </div>
                    <div class="summary-card" data-correct="false">
                        <div class="summary-title">Resumen D</div>
                        <div class="summary-text">El aumento de la temperatura global es beneficioso porque permitir√° cultivar en regiones que antes eran demasiado fr√≠as.</div>
                    </div>
                </div>
                <button class="phase-btn" id="next-phase-1-btn">Siguiente Archivo Secreto</button>
            </div>
        </div>

        <!-- PHASE 2: CONNECTORS -->
        <div class="game-phase" id="phase-2">
            <div class="phase-2-container">
                <div class="file-header">
                    <div class="file-icon"><i class="fas fa-file-secret"></i></div>
                    <div class="file-title">Archivo Secreto #002</div>
                </div>
                <div class="encrypted-text" id="encrypted-text">
                    Los ecosistemas forestales juegan un papel crucial en el equilibrio del planeta. <span class="drop-zone" data-connector="por-eso"></span> act√∫an como pulmones de la Tierra, produciendo ox√≠geno y absorbiendo di√≥xido de carbono. <span class="drop-zone" data-connector="adem√°s"></span> proporcionan h√°bitats para miles de especies. <span class="drop-zone" data-connector="sin-embargo"></span> la deforestaci√≥n amenaza estos servicios vitales. <span class="drop-zone" data-connector="a-pesar-de-ello"></span> muchas comunidades dependen de los bosques para su subsistencia.
                </div>
                <h3>Arrastra los conectores al lugar correcto:</h3>
                <div class="connectors-tray">
                    <div class="connector" draggable="true" data-connector="por-eso">Por eso</div>
                    <div class="connector" draggable="true" data-connector="adem√°s">Adem√°s</div>
                    <div class="connector" draggable="true" data-connector="sin-embargo">Sin embargo</div>
                    <div class="connector" draggable="true" data-connector="a-pesar-de-ello">A pesar de ello</div>
                </div>
                <button class="phase-btn" id="next-phase-2-btn">Siguiente Archivo Secreto</button>
            </div>
        </div>

        <!-- PHASE 3: AUTHENTIC VERSION -->
        <div class="game-phase" id="phase-3">
            <div class="phase-3-container">
                <div class="file-header">
                    <div class="file-icon"><i class="fas fa-file-secret"></i></div>
                    <div class="file-title">Archivo Secreto #003</div>
                </div>
                <h3>Identifica la versi√≥n aut√©ntica del mensaje:</h3>
                <div class="versions-container">
                    <div class="version-card" data-correct="false">
                        <div class="summary-title">Versi√≥n A</div>
                        <div class="summary-text">La inteligencia artificial soon reemplazar√° completamente a los humanos en todas las tareas laborales, haciendo innecesario el trabajo humano.</div>
                    </div>
                    <div class="version-card" data-correct="true">
                        <div class="summary-title">Versi√≥n B</div>
                        <div class="summary-text">La inteligencia artificial est√° transformando el mundo laboral, complementando habilidades humanas y creando nuevas oportunidades, aunque tambi√©n presenta desaf√≠os.</div>
                    </div>
                    <div class="version-card" data-correct="false">
                        <div class="summary-title">Versi√≥n C</div>
                        <div class="summary-text">La inteligencia artificial es solo una moda pasajera que no tendr√° un impacto significativo en la sociedad o el empleo a largo plazo.</div>
                    </div>
                </div>
                <button class="phase-btn" id="next-phase-3-btn">Siguiente Archivo Secreto</button>
            </div>
        </div>

        <!-- PHASE 4: PRONOUNS -->
        <div class="game-phase" id="phase-4">
            <div class="phase-4-container">
                <div class="file-header">
                    <div class="file-icon"><i class="fas fa-file-secret"></i></div>
                    <div class="file-title">Archivo Secreto #004</div>
                </div>
                <div class="pronoun-text" id="pronoun-text">
                    La Revoluci√≥n Industrial, que comenz√≥ en Gran Breta√±a en el siglo XVIII, transform√≥ radicalmente la forma en que <span class="pronoun" data-options="las personas,los animales,las plantas">las personas</span> produc√≠an bienes. <span class="pronoun" data-options="este proceso,la revoluci√≥n,la industria">Este proceso</span> introdujo nuevas tecnolog√≠as como la m√°quina de vapor y el telar mec√°nico, que aumentaron enormemente la productividad. <span class="pronoun" data-options="estas innovaciones,los productos,los trabajadores">Estas innovaciones</span> permitieron la producci√≥n en masa de art√≠culos que antes eran caros y escasos. <span class="pronoun" data-options="los due√±os de f√°bricas,los trabajadores,los consumidores">Los due√±os de f√°bricas</span> se beneficiaron enormemente de <span class="pronoun" data-options="este sistema,la producci√≥n,el trabajo">este sistema</span>, aunque tambi√©n condujo a condiciones laborales dif√≠ciles para muchos trabajadores.
                </div>
                <button class="phase-btn" id="next-phase-4-btn">Siguiente Archivo Secreto</button>
            </div>
        </div>

        <!-- PHASE 5: IDEA NETWORK -->
        <div class="game-phase" id="phase-5">
            <div class="phase-5-container">
                <div class="file-header">
                    <div class="file-icon"><i class="fas fa-file-secret"></i></div>
                    <div class="file-title">Archivo Secreto #005</div>
                </div>
                <h3>Construye la red de ideas correcta:</h3>
                <div class="network-board" id="network-board">
                    <div class="idea-bubble main" data-id="main" style="top: 50%; left: 50%; transform: translate(-50%, -50%);">Impacto de las redes sociales en la comunicaci√≥n</div>
                    <div class="idea-bubble secondary" data-id="1" style="top: 20%; left: 30%;">Cambio en patrones de interacci√≥n social</div>
                    <div class="idea-bubble secondary" data-id="2" style="top: 30%; left: 70%;">Influencia en opini√≥n p√∫blica</div>
                    <div class="idea-bubble secondary" data-id="3" style="top: 70%; left: 25%;">Creaci√≥n de comunidades virtuales</div>
                    <div class="idea-bubble secondary" data-id="4" style="top: 75%; left: 65%;">Transformaci√≥n del periodismo</div>
                    <div class="idea-bubble distractor" data-id="5" style="top: 40%; left: 15%;">Invenci√≥n del tel√©fono</div>
                    <div class="idea-bubble distractor" data-id="6" style="top: 60%; left: 85;">Historia de la radio</div>
                </div>
                <button class="phase-btn" id="complete-game-btn">Completar Misi√≥n</button>
            </div>
        </div>

        <!-- COMPLETION SCREEN -->
        <div class="completion-screen" id="completion-screen">
            <div class="badge">
                <i class="fas fa-user-secret"></i>
            </div>
            <h2>¬°Misi√≥n Cumplida, Agente!</h2>
            <p>Has descifrado todos los mensajes con √©xito. Tu agudeza para la comprensi√≥n literal es impresionante.</p>
            <p>Has ganado la insignia de Agente del Lenguaje de la Agencia del Lenguaje.</p>
            <button class="exit-game-btn" id="exit-game-btn">Salir del Juego</button>
        </div>
    </div>

    <!-- Floating vertical icons -->
    <div class="floating-icons" aria-hidden="false">
        <button id="btn-misiones" title="Misiones">üéØ</button>
        <button id="btn-nivel" title="Nivel actual">‚≠ê</button>
        <button id="btn-progreso" title="Progreso">üìä</button>
        <button id="btn-analisis" title="An√°lisis">üìà</button>
    </div>

    <!-- Panel Misiones -->
    <div class="panel-box" id="panel-misiones" aria-hidden="true">
        <div class="panel-header">
            <h3>Misiones</h3>
            <button class="close-panel" data-close="misiones">&times;</button>
        </div>
        <div id="misiones-content">
            <!-- missions list injected by JS -->
        </div>
    </div>

    <!-- Panel Nivel -->
    <div class="panel-box" id="panel-nivel" aria-hidden="true">
        <div class="panel-header">
            <h3>Tu nivel</h3>
            <button class="close-panel" data-close="nivel">&times;</button>
        </div>
        <div id="nivel-content">
            <!-- level info injected by JS -->
        </div>
    </div>

    <!-- Panel Progreso -->
    <div class="panel-box" id="panel-progreso" aria-hidden="true">
        <div class="panel-header">
            <h3>Progreso</h3>
            <button class="close-panel" data-close="progreso">&times;</button>
        </div>
        <div id="progreso-content">
            <!-- progress injected by JS -->
        </div>
    </div>

    <!-- Panel Analisis -->
    <div class="panel-box" id="panel-analisis" aria-hidden="true">
        <div class="panel-header">
            <h3>An√°lisis (promedio 0‚Äì300)</h3>
            <button class="close-panel" data-close="analisis">&times;</button>
        </div>
        <div id="analisis-content">
            <div id="analisis-stats" style="margin-top:12px;"></div>
        </div>
    </div>

    <!-- Toast notification for mission completed -->
    <div class="toast" id="mission-toast" role="status" aria-live="polite"></div>

    <!-- Audio element for mission completion sound -->
    <audio id="mission-sound" src="mission.mp3" preload="auto"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Cargado. Inicializando juego de Agente del Lenguaje...");

            // --- CONSTANTES Y VARIABLES ---
            const MISSIONS_KEY = 'skopia_missions_v1';
            const USER_PROFILE_KEY = 'skopia_user_profile_v1';
            const GAME_STATS_KEY = 'skopia_game_stats_v1';
            let toastTimer = null;
            let gameStartTime = null;
            let gameTimer = null;
            let currentPhase = 0;
            let usedHint = false;
            let completedMissionsInSession = 0;
            let connections = [];
            let draggedConnector = null;

            const missionsTemplate = [
                { id: 1, title: "Completa tu primer examen", points: 50 },
                { id: 2, title: "Logra al menos 180/300 en un examen", points: 80 },
                { id: 3, title: "Lee toda la teor√≠a de una lecci√≥n", points: 40 },
                { id: 4, title: "Termina una sesi√≥n de estudio sin salir", points: 50 },
                { id: 5, title: "Gana tu primer juego", points: 50 },
                { id: 6, title: "Usa una pista o ayuda en un juego", points: 30 },
                { id: 7, title: "Repite un examen para mejorar tu nota", points: 50 },
                { id: 8, title: "Cambia tu nombre de usuario", points: 40 },
                { id: 9, title: "Acumula tus primeras 200 estrellas", points: 30 },
                { id: 10, title: "Completa 3 misiones seguidas", points: 50 },
                { id: 11, title: "Logra 240/300 en un examen", points: 150 },
                { id: 12, title: "Completa un examen sin errores (300/300)", points: 200 },
                { id: 13, title: "Gana 3 juegos distintos", points: 60 },
                { id: 14, title: "Termina una teor√≠a con ejemplo pr√°ctico", points: 40 },
                { id: 15, title: "Participa en una pr√°ctica de repaso", points: 30 },
                { id: 16, title: "Completa 2 ex√°menes el mismo d√≠a", points: 80 },
                { id: 17, title: "Obt√©n 500 estrellas acumuladas", points: 50 },
                { id: 18, title: "Gana un juego en menos de 2 minutos", points: 50 },
                { id: 19, title: "Repite un juego hasta mejorar tu resultado", points: 30 },
                { id: 20, title: "Completa todas las misiones del nivel 1", points: 100 },
                { id: 21, title: "Logra 270/300 en un examen", points: 180 },
                { id: 22, title: "Supera tu propia mejor nota", points: 60 },
                { id: 23, title: "Termina 5 juegos de pr√°ctica", points: 50 },
                { id: 24, title: "Lee toda la teor√≠a sin usar pistas", points: 40 },
                { id: 25, title: "Completa todos los subniveles de un tema (5/5)", points: 100 },
                { id: 26, title: "Suma 1000 estrellas totales", points: 50 },
                { id: 27, title: "Gana un examen con tiempo limitado", points: 80 },
                { id: 28, title: "Juega y gana el modo "escape room"", points: 60 },
                { id: 29, title: "Completa un juego de ahorcado correctamente", points: 50 },
                { id: 30, title: "Haz un examen de repaso general", points: 70 },
                { id: 31, title: "Logra 300/300 en dos ex√°menes seguidos", points: 200 },
                { id: 32, title: "Completa todos los juegos de un m√≥dulo", points: 100 },
                { id: 33, title: "Termina la teor√≠a de un m√≥dulo completo", points: 80 },
                { id: 34, title: "Gana un juego tipo tablero", points: 60 },
                { id: 35, title: "Completa una misi√≥n cronometrada", points: 80 },
                { id: 36, title: "Obt√©n 2000 estrellas acumuladas", points: 60 },
                { id: 37, title: "Gana un juego sin usar pistas", points: 50 },
                { id: 38, title: "Revisa tu historial de progreso", points: 30 },
                { id: 39, title: "Completa 10 misiones seguidas sin fallar", points: 100 },
                { id: 40, title: "Termina un examen con todos los tiempos perfectos", points: 150 },
                { id: 41, title: "Completa 5 ex√°menes con m√°s de 240/300", points: 150 },
                { id: 42, title: "Termina todos los subniveles del nivel 6", points: 140 },
                { id: 43, title: "Consigue 3000 estrellas", points: 120 },
                { id: 44, title: "Estudia 10 d√≠as seguidos", points: 130 },
                { id: 45, title: "Completa 10 misiones", points: 140 },
                { id: 46, title: "Llega al nivel 6.5", points: 130 },
                { id: 47, title: "Termina un examen sin errores", points: 150 },
                { id: 48, title: "Supera tu propio puntaje anterior", points: 140 },
                { id: 49, title: "Contesta 500 preguntas", points: 130 },
                { id: 50, title: "Completa un examen en menos de 25 minutos", points: 140 },
                { id: 51, title: "Alcanza el top 10 por primera vez (local)", points: 150 },
                { id: 52, title: "Mantente en el top 10 por 3 d√≠as (local)", points: 140 },
                { id: 53, title: "Gana 4000 estrellas", points: 130 },
                { id: 54, title: "Termina la ruta RC con promedio ‚â•200", points: 140 },
                { id: 55, title: "Termina la ruta LC con promedio ‚â•200", points: 140 },
                { id: 56, title: "Termina la ruta CC con promedio ‚â•200", points: 140 },
                { id: 57, title: "Obt√©n 250 puntos o m√°s en tres rutas", points: 150 },
                { id: 58, title: "Crea una racha de 20 aciertos seguidos", points: 140 },
                { id: 59, title: "Completa 15 misiones", points: 130 },
                { id: 60, title: "Alcanza el nivel 7", points: 150 },
                { id: 61, title: "Consigue 6000 estrellas", points: 160 },
                { id: 62, title: "Estudia 20 d√≠as seguidos", points: 170 },
                { id: 63, title: "Termina todos los niveles de una ruta (10/10)", points: 180 },
                { id: 64, title: "Contesta 1000 preguntas", points: 160 },
                { id: 65, title: "Supera a 5 usuarios en el ranking (local)", points: 170 },
                { id: 66, title: "Alcanza el nivel 8", points: 170 },
                { id: 67, title: "Termina 20 misiones", points: 160 },
                { id: 68, title: "Obt√©n promedio ‚â•250 puntos en una ruta", points: 180 },
                { id: 69, title: "Logra 5 ex√°menes con 250 o m√°s puntos", points: 170 },
                { id: 70, title: "Termina las rutas RC y LC completas", points: 180 },
                { id: 71, title: "Mantente en el top 5 (local)", points: 170 },
                { id: 72, title: "Completa todos los subniveles (50 total)", points: 180 },
                { id: 73, title: "Gana 8000 estrellas", points: 160 },
                { id: 74, title: "Termina 25 misiones", points: 170 },
                { id: 75, title: "Sube de nivel sin fallar un examen", points: 160 },
                { id: 76, title: "Obt√©n 280 puntos en un examen", points: 180 },
                { id: 77, title: "Completa 10 ex√°menes sin pistas", points: 170 },
                { id: 78, title: "Obt√©n 270 o m√°s en las tres rutas", points: 180 },
                { id: 79, title: "Alcanza el nivel 9", points: 180 },
                { id: 80, title: "Termina 30 misiones", points: 170 },
                { id: 81, title: "Gana 10,000 estrellas", points: 190 },
                { id: 82, title: "Mantente en el top 3 (local)", points: 190 },
                { id: 83, title: "Termina las tres rutas con promedio ‚â•250", points: 190 },
                { id: 84, title: "Completa los 50 subniveles con m√°s de 200 puntos promedio", points: 200 },
                { id: 85, title: "Llega al nivel 10", points: 200 },
                { id: 86, title: "Gana 15,000 estrellas", points: 200 },
                { id: 87, title: "Mantente en el top 3 por 7 d√≠as (local)", points: 190 },
                { id: 88, title: "Consigue 300 puntos en un examen", points: 200 },
                { id: 89, title: "Termina 40 misiones", points: 190 },
                { id: 90, title: "Completa todos los ex√°menes de pr√°ctica", points: 190 },
                { id: 91, title: "Llega a 20,000 estrellas", points: 200 },
                { id: 92, title: "Termina 50 misiones", points: 190 },
                { id: 93, title: "Mantente en el top 1 por 3 d√≠as (local)", points: 200 },
                { id: 94, title: "Termina todas las rutas al 100%", points: 200 },
                { id: 95, title: "Obt√©n todas las medallas", points: 190 },
                { id: 96, title: "Consigue 25,000 estrellas", points: 200 },
                { id: 97, title: "Cumple todas las misiones b√°sicas e intermedias", points: 190 },
                { id: 98, title: "Mantente activo 30 d√≠as seguidos", points: 200 },
                { id: 99, title: "Llega a 30,000 estrellas", points: 200 },
                { id: 100, title: "üèÜ Maestro del Saber Pro: completa todo el sistema", points: 200 }
            ];

            const LEVELS = [
                { idx: 1, name: "Novato/a", min: 0, max: 299 }, 
                { idx: 2, name: "Aprendiz/a", min: 300, max: 799 },
                { idx: 3, name: "Explorador/a", min: 800, max: 1499 }, 
                { idx: 4, name: "Analista", min: 1500, max: 2499 },
                { idx: 5, name: "Estratega", min: 2500, max: 3699 }, 
                { idx: 6, name: "Sabio/a", min: 3700, max: 4999 },
                { idx: 7, name: "Maestro/a", min: 5000, max: 6499 }, 
                { idx: 8, name: "√âlite", min: 6500, max: 7999 },
                { idx: 9, name: "Leyenda", min: 8000, max: 9499 }, 
                { idx: 10, name: "Rey/Reina Sk√≥pia", min: 9500, max: Infinity }
            ];

            // --- FUNCIONES PRINCIPALES ---

            function initMissions() {
                if (!localStorage.getItem(MISSIONS_KEY)) {
                    const initial = missionsTemplate.map(m => ({ ...m, completed: false }));
                    localStorage.setItem(MISSIONS_KEY, JSON.stringify(initial));
                    console.log("Misiones inicializadas.");
                }
            }

            function initUserProfile() {
                if (!localStorage.getItem(USER_PROFILE_KEY)) {
                    const initial = { originalEmail: "", nameChangeMissionCompleted: false };
                    localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(initial));
                }
            }

            function initGameStats() {
                if (!localStorage.getItem(GAME_STATS_KEY)) {
                    const initial = {
                        gamesPlayed: 0,
                        gamesWon: 0,
                        bestTime: null,
                        lastLogin: new Date().toDateString(),
                        consecutiveDays: 1
                    };
                    localStorage.setItem(GAME_STATS_KEY, JSON.stringify(initial));
                    console.log("Estad√≠sticas de juego inicializadas.");
                } else {
                    checkConsecutiveDays();
                }
            }

            function checkConsecutiveDays() {
                const stats = JSON.parse(localStorage.getItem(GAME_STATS_KEY) || "{}");
                const today = new Date().toDateString();
                
                if (stats.lastLogin !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    if (stats.lastLogin === yesterday.toDateString()) {
                        stats.consecutiveDays++;
                    } else {
                        stats.consecutiveDays = 1;
                    }
                    
                    stats.lastLogin = today;
                    localStorage.setItem(GAME_STATS_KEY, JSON.stringify(stats));
                    
                    // Comprobar misi√≥n de 10 d√≠as seguidos
                    if (stats.consecutiveDays === 10) {
                        completeMission(44);
                    }
                }
            }

            function completeMission(id) {
                console.log(`>>> Llamada a completeMission con ID: ${id}`);
                const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
                const mission = data.find(m => m.id === id);
                
                if (mission && !mission.completed) {
                    mission.completed = true;
                    localStorage.setItem(MISSIONS_KEY, JSON.stringify(data));
                    console.log(`!!! MISI√ìN COMPLETADA: ID=${id}, Titulo="${mission.title}", Puntos=${mission.points} !!!`);
                    
                    document.getElementById('mission-sound').play().catch(e => console.log("Error al reproducir sonido:", e));
                    showMissionToast(`¬°Misi√≥n completada: ${mission.title} (+${mission.points}‚≠ê)!`, 5000);
                    updateAllDisplays();
                    
                    // Incrementar contador de misiones completadas en esta sesi√≥n
                    completedMissionsInSession++;
                    
                    // Comprobar si se completaron 3 misiones seguidas
                    if (completedMissionsInSession === 3) {
                        completeMission(10);
                    }
                    
                    // Comprobar misiones basadas en puntos
                    checkPointMissions();
                    
                    // Mostrar notificaci√≥n de la siguiente misi√≥n
                    setTimeout(() => {
                        showNextMissionNotification();
                    }, 5500);
                } else {
                    console.log(`>>> Misi√≥n ${id} ya estaba completada o no existe.`);
                }
            }

            function showNextMissionNotification() {
                const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
                const nextMission = data.find(m => !m.completed);
                if (nextMission) {
                    showMissionToast(`Nueva misi√≥n disponible: ${nextMission.title} (+${nextMission.points}‚≠ê)`, 8000);
                }
            }

            function checkPointMissions() {
                const totalPoints = getTotalPoints();
                
                if (totalPoints >= 200) completeMission(9);
                if (totalPoints >= 500) completeMission(17);
                if (totalPoints >= 1000) completeMission(26);
                if (totalPoints >= 3000) completeMission(43);
            }

            function showMissionToast(text, ms = 60000) {
                const toast = document.getElementById('mission-toast');
                toast.innerHTML = `<strong>${text}</strong>`;
                toast.classList.add('show');
                if (toastTimer) clearTimeout(toastTimer);
                toastTimer = setTimeout(() => toast.classList.remove('show'), ms);
            }

            function getTotalPoints() {
                const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
                return data.reduce((sum, m) => sum + (m.completed ? m.points : 0), 0);
            }

            function getLevelFromPoints(total) {
                for (let i = LEVELS.length - 1; i >= 0; i--) {
                    if (total >= LEVELS[i].min) return LEVELS[i];
                }
                return LEVELS[0];
            }

            function getCompletedCount() {
                return JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]").filter(m => m.completed).length;
            }

            // --- RENDER FUNCTIONS ---
            function renderMissions() {
                const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]");
                const container = document.getElementById('misiones-content');
                container.innerHTML = '';
                
                // Obtener las pr√≥ximas 3 misiones no completadas en orden
                const nextMissions = data.filter(m => !m.completed).slice(0, 3);
                
                if (nextMissions.length === 0) {
                    container.innerHTML = '<div class="info">¬°Felicidades! Has completado todas las misiones.</div>';
                    return;
                }
                
                nextMissions.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'mission-row';
                    div.innerHTML = `
                        <div style="flex:1">
                            <div style="font-weight:700; color:var(--color-oliva-oscuro)">${m.id}. ${m.title}</div>
                            <div style="font-size:1rem; color:#556b2f">${m.points} ‚≠ê</div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            function renderLevel() {
                const total = getTotalPoints();
                const level = getLevelFromPoints(total);
                const neededForNext = (level.max === Infinity) ? 0 : (level.max - total + 1);
                const progressPct = (level.max === Infinity) ? 100 : Math.min(100, Math.round(((total - level.min) / (level.max - level.min)) * 100));
                
                document.getElementById('nivel-content').innerHTML = `
                    <div class="info"><strong>Nivel:</strong> ${level.name} (${level.idx})</div>
                    <div class="info"><strong>Puntos:</strong> ${total} ‚≠ê</div>
                    <div class="info"><strong>Progreso:</strong> ${progressPct}%</div>
                    <div style="background:#f1f1f1;border-radius:10px;padding:8px;margin-top:10px">
                        <div style="height:12px;background:linear-gradient(90deg,var(--color-oliva-medio),#bdbd74);width:${progressPct}%;border-radius:8px"></div>
                    </div>
                    ${level.max === Infinity ? '<div class="info" style="margin-top:8px">¬°Nivel m√°ximo!</div>' : `<div class="info" style="margin-top:8px">Para subir: ${neededForNext} ‚≠ê</div>`}
                `;
            }

            function renderProgress() {
                const total = getTotalPoints();
                const topTarget = 9500;
                const pct = Math.min(100, Math.round((total / topTarget) * 100));
                const stats = JSON.parse(localStorage.getItem(GAME_STATS_KEY) || "{}");
                
                document.getElementById('progreso-content').innerHTML = `
                    <div class="info"><strong>Puntos:</strong> ${total} ‚≠ê</div>
                    <div class="info"><strong>Progreso Global:</strong> ${pct}%</div>
                    <div style="background:#f1f1f1;border-radius:10px;padding:8px;margin-top:10px">
                        <div style="height:12px;background:linear-gradient(90deg,var(--color-oliva-medio),#bdbd74);width:${pct}%;border-radius:8px"></div>
                    </div>
                    <div class="info" style="margin-top:10px"><strong>Misiones:</strong> ${getCompletedCount()}/100</div>
                    <div class="info" style="margin-top:10px"><strong>Juegos ganados:</strong> ${stats.gamesWon || 0}</div>
                    <div class="info" style="margin-top:10px"><strong>Mejor tiempo:</strong> ${stats.bestTime ? formatTime(stats.bestTime) : 'N/A'}</div>
                    <div class="info" style="margin-top:10px"><strong>D√≠as seguidos:</strong> ${stats.consecutiveDays || 0}</div>
                `;
            }

            function renderAnalysis() {
                document.getElementById('analisis-stats').innerHTML = '<div class="info">An√°lisis de ex√°menes (pendiente de implementar).</div>';
            }

            function updateAllDisplays() {
                renderMissions();
                renderLevel();
                renderProgress();
                renderAnalysis();
            }

            function closeAllPanels() {
                document.querySelectorAll('.panel-box').forEach(p => p.classList.remove('active'));
            }

            function formatTime(milliseconds) {
                const totalSeconds = Math.floor(milliseconds / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            // --- GAME FUNCTIONS ---
            function startGame() {
                gameStartTime = Date.now();
                usedHint = false;
                currentPhase = 1;
                completedMissionsInSession = 0;
                
                // Actualizar estad√≠sticas de juego
                const stats = JSON.parse(localStorage.getItem(GAME_STATS_KEY) || "{}");
                stats.gamesPlayed = (stats.gamesPlayed || 0) + 1;
                localStorage.setItem(GAME_STATS_KEY, JSON.stringify(stats));
                
                // Iniciar temporizador
                updateGameTimer();
                gameTimer = setInterval(updateGameTimer, 1000);
                
                // Mostrar primera fase
                showPhase(1);
            }

            function updateGameTimer() {
                if (!gameStartTime) return;
                
                const elapsed = Date.now() - gameStartTime;
                const totalSeconds = Math.floor(elapsed / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                
                document.getElementById('game-timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            function showPhase(phaseNumber) {
                // Ocultar todas las fases
                document.querySelectorAll('.game-phase').forEach(phase => {
                    phase.classList.remove('active');
                });
                
                // Mostrar la fase solicitada
                document.getElementById(`phase-${phaseNumber}`).classList.add('active');
                currentPhase = phaseNumber;
                
                // Inicializar la fase espec√≠fica
                switch(phaseNumber) {
                    case 1:
                        initPhase1();
                        break;
                    case 2:
                        initPhase2();
                        break;
                    case 3:
                        initPhase3();
                        break;
                    case 4:
                        initPhase4();
                        break;
                    case 5:
                        initPhase5();
                        break;
                }
            }

            function initPhase1() {
                // Configurar evento para la pista
                document.getElementById('hint-btn-1').addEventListener('click', function() {
                    if (!usedHint) {
                        usedHint = true;
                        document.getElementById('secret-text').parentElement.classList.add('hint-used');
                        
                        // Resaltar palabras clave
                        const text = document.getElementById('secret-text');
                        const highlightedText = text.innerHTML.replace(
                            /(cambio clim√°tico|actividades humanas|gases de efecto invernadero|calentamiento global|consecuencias|mitigar)/g,
                            '<span class="highlighted">$1</span>'
                        );
                        text.innerHTML = highlightedText + '<button class="hint-btn" id="hint-btn-1" title="Usar lupa (pista)"><i class="fas fa-search"></i></button>';
                        
                        // Completar misi√≥n de usar pista
                        completeMission(6);
                    }
                });
                
                // Configurar eventos para las tarjetas de resumen
                document.querySelectorAll('.summary-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const isCorrect = this.getAttribute('data-correct') === 'true';
                        
                        // Marcar todas las tarjetas
                        document.querySelectorAll('.summary-card').forEach(c => {
                            if (c.getAttribute('data-correct') === 'true') {
                                c.classList.add('correct');
                            } else {
                                c.classList.add('incorrect');
                            }
                        });
                        
                        // Mostrar bot√≥n para continuar
                        document.getElementById('next-phase-1-btn').classList.add('show');
                        
                        // Si es incorrecto, mostrar mensaje
                        if (!isCorrect) {
                            showMissionToast('Respuesta incorrecta. Intenta con otro resumen.', 3000);
                        }
                    });
                });
                
                // Configurar bot√≥n para siguiente fase
                document.getElementById('next-phase-1-btn').addEventListener('click', function() {
                    showPhase(2);
                });
            }

            function initPhase2() {
                // Configurar drag and drop para conectores
                document.querySelectorAll('.connector').forEach(connector => {
                    connector.addEventListener('dragstart', function(e) {
                        draggedConnector = this;
                        this.classList.add('dragging');
                    });
                    
                    connector.addEventListener('dragend', function(e) {
                        this.classList.remove('dragging');
                    });
                });
                
                document.querySelectorAll('.drop-zone').forEach(zone => {
                    zone.addEventListener('dragover', function(e) {
                        e.preventDefault();
                    });
                    
                    zone.addEventListener('drop', function(e) {
                        e.preventDefault();
                        
                        if (draggedConnector && !this.classList.contains('filled')) {
                            const connectorType = draggedConnector.getAttribute('data-connector');
                            const zoneType = this.getAttribute('data-connector');
                            
                            if (connectorType === zoneType) {
                                this.textContent = draggedConnector.textContent;
                                this.classList.add('filled');
                                draggedConnector.classList.add('used');
                                
                                // Comprobar si todos los conectores est√°n en su lugar
                                const allFilled = Array.from(document.querySelectorAll('.drop-zone')).every(z => z.classList.contains('filled'));
                                
                                if (allFilled) {
                                    document.getElementById('encrypted-text').classList.add('decrypted');
                                    document.getElementById('next-phase-2-btn').classList.add('show');
                                    showMissionToast('¬°Mensaje descifrado correctamente!', 3000);
                                }
                            }
                        }
                    });
                });
                
                // Configurar bot√≥n para siguiente fase
                document.getElementById('next-phase-2-btn').addEventListener('click', function() {
                    showPhase(3);
                });
            }

            function initPhase3() {
                // Configurar eventos para las tarjetas de versi√≥n
                document.querySelectorAll('.version-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const isCorrect = this.getAttribute('data-correct') === 'true';
                        
                        if (isCorrect) {
                            this.classList.add('correct');
                            document.getElementById('next-phase-3-btn').classList.add('show');
                            showMissionToast('¬°Versi√≥n aut√©ntica encontrada!', 3000);
                        } else {
                            this.classList.add('incorrect');
                            showMissionToast('Esta no es la versi√≥n aut√©ntica. Sigue buscando.', 3000);
                        }
                    });
                });
                
                // Configurar bot√≥n para siguiente fase
                document.getElementById('next-phase-3-btn').addEventListener('click', function() {
                    showPhase(4);
                });
            }

            function initPhase4() {
                // Configurar eventos para los pronombres
                document.querySelectorAll('.pronoun').forEach(pronoun => {
                    pronoun.addEventListener('click', function() {
                        // Cerrar todas las opciones abiertas
                        document.querySelectorAll('.pronoun-options').forEach(options => {
                            options.classList.remove('show');
                        });
                        
                        // Mostrar opciones para este pronombre
                        const options = this.querySelector('.pronoun-options');
                        if (options) {
                            options.classList.add('show');
                        }
                    });
                });
                
                // Configurar eventos para las opciones de pronombres
                document.querySelectorAll('.pronoun-option').forEach(option => {
                    option.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        const pronoun = this.closest('.pronoun');
                        const isCorrect = this.classList.contains('correct');
                        
                        if (isCorrect) {
                            pronoun.style.color = '#4CAF50';
                            pronoun.style.textDecoration = 'underline';
                            
                            // Crear l√≠nea de conexi√≥n (simplificada para este ejemplo)
                            const line = document.createElement('div');
                            line.className = 'connection-line';
                            pronoun.appendChild(line);
                            
                            showMissionToast('¬°Conexi√≥n correcta!', 2000);
                        } else {
                            pronoun.style.color = '#F44336';
                            showMissionToast('Esa no es la referencia correcta.', 2000);
                        }
                        
                        // Cerrar opciones
                        this.closest('.pronoun-options').classList.remove('show');
                        
                        // Comprobar si todos los pronombres est√°n resueltos
                        const allResolved = Array.from(document.querySelectorAll('.pronoun')).every(p => 
                            p.style.color === 'rgb(76, 175, 80)' || p.style.color === '#4CAF50'
                        );
                        
                        if (allResolved) {
                            document.getElementById('next-phase-4-btn').classList.add('show');
                            showMissionToast('¬°Todas las conexiones establecidas!', 3000);
                        }
                    });
                });
                
                // Configurar bot√≥n para siguiente fase
                document.getElementById('next-phase-4-btn').addEventListener('click', function() {
                    showPhase(5);
                });
            }

            function initPhase5() {
                // Configurar drag and drop para las burbujas de ideas
                let mainBubble = document.querySelector('.idea-bubble.main');
                let connectedBubbles = new Set();
                
                document.querySelectorAll('.idea-bubble.secondary').forEach(bubble => {
                    bubble.addEventListener('click', function() {
                        // Si ya est√° conectada, desconectar
                        if (this.classList.contains('connected')) {
                            this.classList.remove('connected');
                            connectedBubbles.delete(this);
                            
                            // Eliminar l√≠nea de conexi√≥n
                            const lineId = `line-${mainBubble.getAttribute('data-id')}-${this.getAttribute('data-id')}`;
                            const line = document.getElementById(lineId);
                            if (line) line.remove();
                        } else {
                            // Conectar con la idea principal
                            this.classList.add('connected');
                            connectedBubbles.add(this);
                            
                            // Crear l√≠nea de conexi√≥n
                            const lineId = `line-${mainBubble.getAttribute('data-id')}-${this.getAttribute('data-id')}`;
                            const line = document.createElement('div');
                            line.id = lineId;
                            line.className = 'network-connection';
                            
                            // Calcular posici√≥n de la l√≠nea
                            const mainRect = mainBubble.getBoundingClientRect();
                            const bubbleRect = this.getBoundingClientRect();
                            const boardRect = document.getElementById('network-board').getBoundingClientRect();
                            
                            const x1 = mainRect.left + mainRect.width / 2 - boardRect.left;
                            const y1 = mainRect.top + mainRect.height / 2 - boardRect.top;
                            const x2 = bubbleRect.left + bubbleRect.width / 2 - boardRect.left;
                            const y2 = bubbleRect.top + bubbleRect.height / 2 - boardRect.top;
                            
                            const length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
                            const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
                            
                            line.style.width = `${length}px`;
                            line.style.left = `${x1}px`;
                            line.style.top = `${y1}px`;
                            line.style.transform = `rotate(${angle}deg)`;
                            
                            document.getElementById('network-board').appendChild(line);
                        }
                        
                        // Comprobar si todas las ideas secundarias correctas est√°n conectadas
                        const allSecondaryConnected = Array.from(document.querySelectorAll('.idea-bubble.secondary')).every(b => 
                            b.classList.contains('connected')
                        );
                        
                        if (allSecondaryConnected) {
                            document.getElementById('network-board').classList.add('completed');
                            document.getElementById('complete-game-btn').classList.add('show');
                            showMissionToast('¬°Red de ideas completada!', 3000);
                        }
                    });
                });
                
                // Configurar bot√≥n para completar el juego
                document.getElementById('complete-game-btn').addEventListener('click', function() {
                    completeGame();
                });
            }

            function completeGame() {
                // Detener temporizador
                clearInterval(gameTimer);
                
                // Calcular tiempo transcurrido
                const elapsed = Date.now() - gameStartTime;
                const stats = JSON.parse(localStorage.getItem(GAME_STATS_KEY) || "{}");
                
                // Actualizar estad√≠sticas
                stats.gamesWon = (stats.gamesWon || 0) + 1;
                
                // Comprobar si es el mejor tiempo
                if (!stats.bestTime || elapsed < stats.bestTime) {
                    stats.bestTime = elapsed;
                }
                
                localStorage.setItem(GAME_STATS_KEY, JSON.stringify(stats));
                
                // Comprobar misiones relacionadas con el juego
                completeMission(5); // Gana tu primer juego
                
                if (stats.gamesWon === 3) {
                    completeMission(13); // Gana 3 juegos distintos
                }
                
                if (stats.gamesWon > 1) {
                    completeMission(19); // Repite un juego hasta mejorar tu resultado
                }
                
                if (elapsed < 120000) { // Menos de 2 minutos
                    completeMission(18); // Gana un juego en menos de 2 minutos
                }
                
                if (!usedHint) {
                    completeMission(37); // Gana un juego sin usar pistas
                }
                
                // Mostrar pantalla de completaci√≥n
                document.querySelectorAll('.game-phase').forEach(phase => {
                    phase.classList.remove('active');
                });
                
                document.getElementById('completion-screen').classList.add('show');
            }

            // --- EVENT LISTENERS ---
            window.addEventListener('userReady', (e) => {
                const user = e.detail.user;
                console.log("Evento 'userReady' recibido para:", user.email);
                const userProfile = JSON.parse(localStorage.getItem(USER_PROFILE_KEY) || "{}");

                // Inicializar perfil si es la primera vez que se loguea
                if (!userProfile.originalEmail) {
                    userProfile.originalEmail = user.email;
                    userProfile.nameChangeMissionCompleted = false;
                    localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(userProfile));
                    console.log("Perfil de usuario inicializado por primera vez. Email original guardado:", userProfile.originalEmail);
                }

                // Comprobar la misi√≥n de cambiar nombre SOLO si no se ha completado
                if (!userProfile.nameChangeMissionCompleted) {
                    console.log("Comprobando misi√≥n 8 (cambiar nombre)...");
                    const hasChangedName = user.displayName && user.displayName !== userProfile.originalEmail;
                    if (hasChangedName) {
                        console.log(`¬°Cambio de nombre detectado! Original: "${userProfile.originalEmail}", Nuevo: "${user.displayName}". Completando misi√≥n 8.`);
                        completeMission(8);
                        userProfile.nameChangeMissionCompleted = true;
                        localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(userProfile));
                    } else {
                        console.log("No se detect√≥ cambio de nombre. DisplayName actual:", user.displayName);
                    }
                } else {
                    console.log("Misi√≥n 8 ya fue completada anteriormente.");
                }
            });

            document.getElementById('hamburger-menu').addEventListener('click', () => {
                document.getElementById('user-dropdown').classList.toggle('active');
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                import("https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js").then(({ signOut }) => {
                    signOut(window.auth).then(() => window.location.href = 'index.html');
                });
            });

            window.addEventListener('click', (event) => {
                if (!event.target.closest('.navbar')) {
                    document.getElementById('user-dropdown').classList.remove('active');
                }
                const isIcon = event.target.closest('.floating-icons');
                const isPanel = event.target.closest('.panel-box');
                if (!isIcon && !isPanel) {
                    closeAllPanels();
                }
            });

            // Configurar bot√≥n de comenzar juego
            document.getElementById('start-game-btn').addEventListener('click', function() {
                document.getElementById('intro-phase').classList.remove('active');
                startGame();
            });

            // Configurar bot√≥n de salir del juego
            document.getElementById('exit-game-btn').addEventListener('click', function() {
                window.location.href = 'comprension-literal.html';
            });

            // **EVENT LISTENERS DE ICONOS (FUNCIONANDO)**
            document.getElementById('btn-misiones').addEventListener('click', () => {
                closeAllPanels();
                document.getElementById('panel-misiones').classList.add('active');
                renderMissions();
                
                // Completar misi√≥n de revisar progreso
                completeMission(38);
            });
            
            document.getElementById('btn-nivel').addEventListener('click', () => {
                closeAllPanels();
                document.getElementById('panel-nivel').classList.add('active');
                renderLevel();
            });
            
            document.getElementById('btn-progreso').addEventListener('click', () => {
                closeAllPanels();
                document.getElementById('panel-progreso').classList.add('active');
                renderProgress();
                
                // Completar misi√≥n de revisar progreso
                completeMission(38);
            });
            
            document.getElementById('btn-analisis').addEventListener('click', () => {
                closeAllPanels();
                document.getElementById('panel-analisis').classList.add('active');
                renderAnalysis();
            });

            document.querySelectorAll('.close-panel').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.getElementById('panel-' + e.target.getAttribute('data-close')).classList.remove('active');
                });
            });

            // --- INICIALIZACI√ìN ---
            initMissions();
            initUserProfile();
            initGameStats();
            updateAllDisplays();
            console.log("Juego de Agente del Lenguaje inicializado.");
        });
    </script>
</body>
</html>
