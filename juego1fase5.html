<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fase 5: Red de Ideas - Sk√≥pia</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Roboto:wght@400;700&family=Orbitron:wght@700&family=Cinzel:wght@700&family=Special+Elite&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBGEwwuGLP0ULmsJkAhwwmNSlWAotGu_wY",
            projectId: "skopia-aa786",
            storageBucket: "skopia-aa786.firebasestorage.app",
            messagingSenderId: "719823055099",
            appId: "1:719823055099:web:7d91ea29e4b2dcbb9b685e"
        };

        if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
            firebaseConfig.authDomain = "localhost";
        } else {
            firebaseConfig.authDomain = "skopia-aa786.firebaseapp.com";
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.auth = auth;

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            window.dispatchEvent(new CustomEvent('userReady', { detail: { user } }));
        });
    </script>

    <style>
        :root {
            --color-crema: #fdfbf5;
            --color-oliva-claro: #bec092;
            --color-oliva-medio: #5a6133;
            --color-oliva-oscuro: #272b00;
            --color-sombra: rgba(39, 43, 0, 0.1);
            --float-color: var(--color-oliva-oscuro);
            --float-color-hover: var(--color-oliva-medio);
            --detective-bg: #0a0e1a;
            --detective-accent: #c9a961;
            --detective-text: #e0e0e0;
            --paper-bg: #f5f1e8;
            --paper-text: #333;
            --highlight-bg: #ffeb3b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--detective-bg);
            color: var(--detective-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- NAVBAR (Same as juego1.html) --- */
        .navbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 15px 40px;
            background-color: rgba(10, 14, 26, 0.8);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            position: relative;
            z-index: 1000;
        }
        .hamburger {
            width: 30px;
            height: 25px;
            position: relative;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .hamburger span {
            display: block;
            height: 4px;
            width: 100%;
            background-color: var(--detective-text);
            border-radius: 2px;
            transition: all 0.3s ease-in-out;
        }
        .user-dropdown {
            position: absolute;
            top: 70px;
            right: 40px;
            background-color: rgba(10, 14, 26, 0.9);
            border: 1px solid var(--detective-accent);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.3s, transform 0.3s, visibility 0.3s;
            z-index: 1000;
        }
        .user-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .user-dropdown a {
            display: block;
            padding: 15px 25px;
            text-decoration: none;
            color: var(--detective-text);
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .user-dropdown a:hover {
            background-color: rgba(201, 169, 97, 0.2);
        }
        .user-dropdown hr {
            border: none;
            border-top: 1px solid rgba(201, 169, 97, 0.3);
            margin: 0;
        }

        /* --- MUSIC PLAYER --- */
        .music-player {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 5000;
        }
        .music-control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--detective-accent);
            color: var(--detective-bg);
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        .music-control-btn:hover {
            transform: scale(1.1);
            background-color: #e6c277;
        }

        /* --- MAIN GAME CONTAINER --- */
        .game-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--detective-bg) 0%, #1a2332 100%);
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .game-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            color: var(--detective-accent);
            text-shadow: 0 0 10px rgba(201, 169, 97, 0.3);
        }

        /* --- IDEA BOARD STYLING --- */
        .idea-board {
            width: 100%;
            max-width: 1200px;
            background-color: var(--paper-bg);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            position: relative;
            margin-bottom: 30px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .board-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(45deg, rgba(201, 169, 97, 0.05) 25%, transparent 25%),
                              linear-gradient(-45deg, rgba(201, 169, 97, 0.05) 25%, transparent 25%),
                              linear-gradient(45deg, transparent 75%, rgba(201, 169, 97, 0.05) 75%),
                              linear-gradient(-45deg, transparent 75%, rgba(201, 169, 97, 0.05) 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            opacity: 0.3;
        }
        
        .board-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        /* --- CENTRAL TEXT --- */
        .central-text {
            width: 100%;
            padding: 25px;
            background-color: rgba(142, 68, 173, 0.9);
            color: white;
            font-family: 'Special Elite', cursive;
            font-size: 1.2rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 10;
            border: 2px solid #8e44ad;
            border-radius: 10px 10px 0 0;
        }
        
        /* --- OPTIONS CONTAINER --- */
        .options-container {
            flex: 1;
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            z-index: 2;
            background-color: var(--paper-bg);
        }
        
        /* --- OPTION BOXES --- */
        .option-box {
            background-color: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            font-family: 'Patrick Hand', cursive;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
            position: relative;
            color: #333; /* Texto negro por defecto */
        }
        
        .option-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            border-color: #3498db;
        }
        
        .option-box.selected-main {
            background-color: rgba(142, 68, 173, 0.9);
            color: white; /* Texto blanco cuando est√° seleccionado como principal */
            border: 3px solid #8e44ad;
            transform: scale(1.02);
            z-index: 5;
        }
        
        .option-box.selected-secondary {
            background-color: rgba(46, 204, 113, 0.9);
            color: white; /* Texto blanco cuando est√° seleccionado como secundario */
            border: 3px solid #2ecc71;
            transform: scale(1.02);
            z-index: 5;
        }
        
        .option-box.incorrect {
            background-color: rgba(231, 76, 60, 0.9);
            color: white; /* Texto blanco cuando es incorrecto */
            border: 3px solid #e74c3c;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .option-box .option-number {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: #3498db;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .option-box.selected-main .option-number {
            background-color: #8e44ad;
        }
        
        .option-box.selected-secondary .option-number {
            background-color: #2ecc71;
        }
        
        .connection-line {
            stroke: #3498db;
            stroke-width: 3;
            fill: none;
            stroke-dasharray: 5, 5;
            animation: dash 20s linear infinite;
        }
        
        .connection-line.main {
            stroke: #8e44ad;
            stroke-width: 4;
        }
        
        .connection-line.secondary {
            stroke: #2ecc71;
            stroke-width: 3;
        }
        
        @keyframes dash {
            to {
                stroke-dashoffset: -100;
            }
        }
        
        .glow-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(46, 204, 113, 0.3) 0%, rgba(46, 204, 113, 0) 70%);
            opacity: 0;
            pointer-events: none;
            z-index: 0;
        }
        
        .glow-effect.active {
            animation: glow 2s ease-in-out forwards;
        }
        
        @keyframes glow {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        .completion-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 10px;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 20;
            opacity: 0;
            pointer-events: none;
        }
        
        .completion-message.show {
            animation: fadeInOut 3s ease-in-out forwards;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        }
        
        /* --- SELECTION COUNTER --- */
        .selection-counter {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(10, 14, 26, 0.8);
            color: var(--detective-accent);
            padding: 10px 20px;
            border-radius: 20px;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            z-index: 15;
        }
        
        /* --- GAME CONTROLS --- */
        .game-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
        }
        .hint-button {
            background: var(--detective-accent);
            color: var(--detective-bg);
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .hint-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .hint-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .timer {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--detective-accent);
        }

        /* --- FEEDBACK MESSAGE --- */
        .feedback-message {
            width: 100%;
            max-width: 800px;
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Patrick Hand', cursive;
            font-size: 1.3rem;
            min-height: 40px;
            font-weight: bold;
        }
        .feedback-message.success { color: #4CAF50; }
        .feedback-message.error { color: #f44336; }

        /* --- FLOATING ICONS & PANELS (Same as juego1.html) --- */
        .floating-icons {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 2000;
        }
        .floating-icons button {
            background: var(--float-color);
            color: white;
            width: 54px;
            height: 54px;
            border-radius: 50%;
            border: none;
            font-size: 20px;
            display: grid;
            place-items: center;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            cursor: pointer;
            transition: transform .15s ease, background .15s ease;
        }
        .floating-icons button:hover { transform: scale(1.08); background: var(--float-color-hover); }

        .panel-box {
            position: fixed;
            right: 90px;
            top: 50%;
            transform: translateY(-50%);
            width: 420px;
            max-height: 75vh;
            background: rgba(10, 14, 26, 0.9);
            border: 1px solid var(--detective-accent);
            border-radius: 12px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.5);
            overflow: auto;
            padding: 24px;
            z-index: 2100;
            display: none;
            font-family: 'Patrick Hand', cursive;
            font-size: 1.2rem;
            color: var(--detective-text);
        }
        .panel-box.active { display: block; }
        .panel-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .panel-header h3 { margin:0; font-size:1.6rem; color:var(--detective-accent); }
        .close-panel { background:none; border:none; font-size:1.4rem; cursor:pointer; color:var(--detective-accent); }
        .mission-row { padding:12px; border-radius:8px; margin-bottom:10px; background:rgba(201, 169, 97, 0.1); box-shadow: 0 2px 6px rgba(0,0,0,0.2); display:flex; justify-content:space-between; align-items:center; }
        .mission-row.completed { opacity:0.6; text-decoration:line-through; background:rgba(76, 175, 80, 0.1); }
        .toast {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: rgba(10, 14, 26, 0.9);
            border-left: 6px solid var(--detective-accent);
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.5);
            z-index: 3000;
            display: none;
            font-size: 1.1rem;
            max-width: 400px;
            color: var(--detective-text);
        }
        .toast.show { display: block; }
        .info { font-family: 'Roboto', sans-serif; color:var(--detective-text); font-size:1.1rem; margin-bottom:12px; }

        @media (max-width: 768px) {
            .options-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                padding: 20px;
            }
            .option-box {
                font-size: 0.9rem;
                min-height: 70px;
                padding: 12px;
            }
            .central-text {
                font-size: 1rem;
                padding: 20px;
            }
            .game-controls { flex-direction: column; gap: 15px; }
            .panel-box { right: 10px; width: 92%; top: 55%; transform: translateY(-55%); }
            .floating-icons { right: 10px; }
        }
    </style>
     <script type="module" src="./global-settings.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="hamburger" id="hamburger-menu"><span></span><span></span><span></span></div>
        <div class="user-dropdown" id="user-dropdown">
            <a href="cuenta.html">Mi Cuenta</a>
            <a href="configuracion.html">Configuraci√≥n</a>
            <a href="notificaciones.html">Notificaciones</a>
            <hr>
            <a href="index.html" id="logout-btn">Cerrar Sesi√≥n</a>
        </div>
    </nav>

    <!-- Music Player -->
    <div class="music-player">
        <button id="music-control-btn" class="music-control-btn" title="Pausar/Reproducir M√∫sica">
            <i class="fas fa-volume-up"></i>
        </button>
    </div>
    <audio id="background-music" loop>
        <source src="https://www.bensound.com/bensound-music/bensound-mystery.mp3" type="audio/mpeg">
        Tu navegador no soporta el elemento de audio.
    </audio>

    <main class="game-container">
        <header class="game-header">
            <h1 class="game-title">Fase 5: Red de Ideas</h1>
        </header>

        <div class="idea-board" id="idea-board">
            <div class="board-background"></div>
            <svg class="board-svg" id="board-svg"></svg>
            <div class="glow-effect" id="glow-effect"></div>
            
            <!-- Selection Counter -->
            <div class="selection-counter" id="selection-counter">
                Selecciones: <span id="selection-count">0</span>/3
            </div>
            
            <!-- Central Text at the top -->
            <div class="central-text" id="central-text">
                La inteligencia artificial est√° transformando radicalmente m√∫ltiples aspectos de nuestra sociedad contempor√°nea.
            </div>
            
            <!-- Options Container in a grid -->
            <div class="options-container" id="options-container">
                <!-- Option Boxes (15 total) -->
                <div class="option-box" id="option-1" data-type="main">
                    <div class="option-number">1</div>
                    <span>Impacto en el empleo</span>
                </div>
                
                <div class="option-box" id="option-2" data-type="secondary">
                    <div class="option-number">2</div>
                    <span>Automatizaci√≥n de tareas</span>
                </div>
                
                <div class="option-box" id="option-3" data-type="secondary">
                    <div class="option-number">3</div>
                    <span>√âtica en algoritmos</span>
                </div>
                
                <div class="option-box" id="option-4" data-type="distractor">
                    <div class="option-number">4</div>
                    <span>Historia de los robots</span>
                </div>
                
                <div class="option-box" id="option-5" data-type="distractor">
                    <div class="option-number">5</div>
                    <span>Componentes electr√≥nicos</span>
                </div>
                
                <div class="option-box" id="option-6" data-type="distractor">
                    <div class="option-number">6</div>
                    <span>Biograf√≠as de cient√≠ficos</span>
                </div>
                
                <div class="option-box" id="option-7" data-type="distractor">
                    <div class="option-number">7</div>
                    <span>Lenguajes de programaci√≥n</span>
                </div>
                
                <div class="option-box" id="option-8" data-type="distractor">
                    <div class="option-number">8</div>
                    <span>Hardware vs Software</span>
                </div>
                
                <div class="option-box" id="option-9" data-type="distractor">
                    <div class="option-number">9</div>
                    <span>Redes sociales</span>
                </div>
                
                <div class="option-box" id="option-10" data-type="distractor">
                    <div class="option-number">10</div>
                    <span>Ciberseguridad b√°sica</span>
                </div>
                
                <div class="option-box" id="option-11" data-type="distractor">
                    <div class="option-number">11</div>
                    <span>Inteligencia emocional</span>
                </div>
                
                <div class="option-box" id="option-12" data-type="distractor">
                    <div class="option-number">12</div>
                    <span>Realidad virtual</span>
                </div>
                
                <div class="option-box" id="option-13" data-type="distractor">
                    <div class="option-number">13</div>
                    <span>Blockchain</span>
                </div>
                
                <div class="option-box" id="option-14" data-type="distractor">
                    <div class="option-number">14</div>
                    <span>Big Data</span>
                </div>
                
                <div class="option-box" id="option-15" data-type="distractor">
                    <div class="option-number">15</div>
                    <span>Machine Learning</span>
                </div>
            </div>
            
            <!-- Completion Message -->
            <div class="completion-message" id="completion-message">
                ¬°Red completada con √©xito!<br>
                Redirigiendo...
            </div>
        </div>

        <div class="game-controls">
            <button class="hint-button" id="hint-button">
                <i class="fas fa-lightbulb"></i>
                <span>Pista</span>
            </button>
            <div class="timer" id="timer">Tiempo: 00:00</div>
        </div>

        <div class="feedback-message" id="feedback-message"></div>
    </main>

    <!-- Floating vertical icons (Same as juego1.html) -->
    <div class="floating-icons" aria-hidden="false">
        <button id="btn-misiones" title="Misiones">üéØ</button>
        <button id="btn-nivel" title="Nivel actual">‚≠ê</button>
        <button id="btn-progreso" title="Progreso">üìä</button>
        <button id="btn-analisis" title="An√°lisis">üìà</button>
    </div>

    <!-- Panels (Same as juego1.html) -->
    <div class="panel-box" id="panel-misiones" aria-hidden="true">
        <div class="panel-header"><h3>Misiones</h3><button class="close-panel" data-close="misiones">&times;</button></div>
        <div id="misiones-content"></div>
    </div>
    <div class="panel-box" id="panel-nivel" aria-hidden="true">
        <div class="panel-header"><h3>Tu nivel</h3><button class="close-panel" data-close="nivel">&times;</button></div>
        <div id="nivel-content"></div>
    </div>
    <div class="panel-box" id="panel-progreso" aria-hidden="true">
        <div class="panel-header"><h3>Progreso</h3><button class="close-panel" data-close="progreso">&times;</button></div>
        <div id="progreso-content"></div>
    </div>
    <div class="panel-box" id="panel-analisis" aria-hidden="true">
        <div class="panel-header"><h3>An√°lisis (promedio 0‚Äì300)</h3><button class="close-panel" data-close="analisis">&times;</button></div>
        <div id="analisis-content"><div id="analisis-stats" style="margin-top:12px;"></div></div>
    </div>

    <div class="toast" id="mission-toast" role="status" aria-live="polite"></div>
    <audio id="mission-sound" src="mission.mp3" preload="auto"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Cargado. Inicializando Fase 5 del juego...");

            // --- CONSTANTES Y VARIABLES GLOBALES DEL JUEGO ---
            const GAME1_STATE_KEY = 'skopia_game1_state_v1';
            const MISSIONS_KEY = 'skopia_missions_v1';
            const USER_PROFILE_KEY = 'skopia_user_profile_v1';
            const GAME_STATS_KEY = 'skopia_game_stats_v1';
            const CURRENT_PHASE = 5;
            const TOTAL_PHASES = 5;

            let toastTimer = null;
            let gameStartTime = null;
            let timerInterval = null;
            let hintUsed = false;
            let puzzleSolved = false;
            let selectedMain = null;
            let selectedSecondary = [];
            let connections = {};

            // --- FUNCIONES DE GESTI√ìN DEL ESTADO DEL JUEGO ---
            function getGameState() {
                const state = localStorage.getItem(GAME1_STATE_KEY);
                return state ? JSON.parse(state) : { totalTime: 0, hintsUsed: false, currentPhase: 1 };
            }
            function saveGameState(state) {
                localStorage.setItem(GAME1_STATE_KEY, JSON.stringify(state));
            }

            // --- COPIAR TODO EL SISTEMA DE MISIONES DE JUEGO1.HTML ---
            const META_MISSION_IDS = [38];
            const missionsTemplate = [
                { id: 1, title: "Completa tu primer examen", points: 50 }, { id: 2, title: "Logra al menos 180/300 en un examen", points: 80 },
                { id: 3, title: "Lee toda la teor√≠a de una lecci√≥n", points: 40 }, { id: 4, title: "Termina una sesi√≥n de estudio sin salir", points: 50 },
                { id: 5, title: "Gana tu primer juego", points: 50 }, { id: 6, title: "Usa una pista o ayuda en un juego", points: 30 },
                { id: 7, title: "Repite un examen para mejorar tu nota", points: 50 }, { id: 8, title: "Cambia tu nombre de usuario", points: 40 },
                { id: 9, title: "Acumula tus primeras 200 estrellas", points: 30 }, { id: 10, title: "Completa 3 misiones seguidas", points: 50 },
                { id: 11, title: "Logra 240/300 en un examen", points: 150 }, { id: 12, title: "Completa un examen sin errores (300/300)", points: 200 },
                { id: 13, title: "Gana 3 juegos distintos", points: 60 }, { id: 18, title: "Gana un juego en menos de 2 minutos", points: 50 },
                { id: 19, title: "Repite un juego hasta mejorar tu resultado", points: 30 }, { id: 37, title: "Gana un juego sin usar pistas", points: 50 },
                { id: 38, title: "Revisa tu historial de progreso", points: 30 }, { id: 100, title: "üèÜ Maestro del Saber Pro: completa todo el sistema", points: 200 }
            ];
            const LEVELS = [
                { idx: 1, name: "Novato/a", min: 0, max: 299 }, { idx: 2, name: "Aprendiz/a", min: 300, max: 799 },
                { idx: 3, name: "Explorador/a", min: 800, max: 1499 }, { idx: 4, name: "Analista", min: 1500, max: 2499 },
                { idx: 5, name: "Estratega", min: 2500, max: 3699 }, { idx: 6, name: "Sabio/a", min: 3700, max: 4999 },
                { idx: 7, name: "Maestro/a", min: 5000, max: 6499 }, { idx: 8, name: "√âlite", min: 6500, max: 7999 },
                { idx: 9, name: "Leyenda", min: 8000, max: 9499 }, { idx: 10, name: "Rey/Reina Sk√≥pia", min: 9500, max: Infinity }
            ];

            function initMissions() { if (!localStorage.getItem(MISSIONS_KEY)) { const initial = missionsTemplate.map(m => ({ ...m, completed: false })); localStorage.setItem(MISSIONS_KEY, JSON.stringify(initial)); } }
            function initUserProfile() { if (!localStorage.getItem(USER_PROFILE_KEY)) { const initial = { originalEmail: "", nameChangeMissionCompleted: false }; localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(initial)); } }
            function initGameStats() { if (!localStorage.getItem(GAME_STATS_KEY)) { const initial = { gamesPlayed: 0, gamesWon: 0, hintsUsed: 0, totalTime: 0, bestTime: null, lastPlayDate: null, streakDays: 0 }; localStorage.setItem(GAME_STATS_KEY, JSON.stringify(initial)); } }
            function completeMission(id) { const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]"); const mission = data.find(m => m.id === id); if (mission && !mission.completed) { mission.completed = true; localStorage.setItem(MISSIONS_KEY, JSON.stringify(data)); document.getElementById('mission-sound').play().catch(e => console.log("Error al reproducir sonido:", e)); showMissionToast(`¬°Misi√≥n completada: ${mission.title} (+${mission.points}‚≠ê)!`, 5000); updateAllDisplays(); setTimeout(() => checkAndCompleteSpecialMissions(), 200); } }
            function checkAndCompleteSpecialMissions() { const missionsData = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]"); const totalPoints = getTotalPoints(); const completedCount = getCompletedCount(); const gameStats = JSON.parse(localStorage.getItem(GAME_STATS_KEY) || "{}"); let changed = false; const newlyCompletedMissions = []; if (totalPoints >= 200) { const m = missionsData.find(m => m.id === 9); if (m && !m.completed) { m.completed = true; changed = true; newlyCompletedMissions.push(m); } } const mission10 = missionsData.find(m => m.id === 10); const metaCompletedCount = missionsData.filter(m => m.completed && META_MISSION_IDS.includes(m.id)).length; const realCompletedCount = completedCount - metaCompletedCount; if (realCompletedCount >= 3 && mission10 && !mission10.completed) { mission10.completed = true; changed = true; newlyCompletedMissions.push(mission10); } if (gameStats.gamesWon >= 3) { const m = missionsData.find(m => m.id === 13); if (m && !m.completed) { m.completed = true; changed = true; newlyCompletedMissions.push(m); } } if (totalPoints >= 500) { const m = missionsData.find(m => m.id === 17); if (m && !m.completed) { m.completed = true; changed = true; newlyCompletedMissions.push(m);} } if (totalPoints >= 1000) { const m = missionsData.find(m => m.id === 26); if (m && !m.completed) { m.completed = true; changed = true; newlyCompletedMissions.push(m);} } if (totalPoints >= 3000) { const m = missionsData.find(m => m.id === 43); if (m && !m.completed) { m.completed = true; changed = true; newlyCompletedMissions.push(m);} } if (changed) { localStorage.setItem(MISSIONS_KEY, JSON.stringify(missionsData)); document.getElementById('mission-sound').play().catch(e => console.log("Error al reproducir sonido:", e)); newlyCompletedMissions.forEach(m => { showMissionToast(`¬°Misi√≥n completada: ${mission.title} (+${mission.points}‚≠ê)!`, 5000); }); updateAllDisplays(); } }
            function showMissionToast(text, ms = 60000) { const toast = document.getElementById('mission-toast'); toast.innerHTML = `<strong>${text}</strong>`; toast.classList.add('show'); if (toastTimer) clearTimeout(toastTimer); toastTimer = setTimeout(() => toast.classList.remove('show'), ms); }
            function getTotalPoints() { const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]"); return data.reduce((sum, m) => sum + (m.completed ? m.points : 0), 0); }
            function getLevelFromPoints(total) { for (let i = LEVELS.length - 1; i >= 0; i--) if (total >= LEVELS[i].min) return LEVELS[i]; return LEVELS[0]; }
            function getCompletedCount() { return JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]").filter(m => m.completed).length; }
            function renderMissions() { const data = JSON.parse(localStorage.getItem(MISSIONS_KEY) || "[]"); const container = document.getElementById('misiones-content'); container.innerHTML = ''; const incompleteMissions = data.filter(m => !m.completed).slice(0, 3); if (incompleteMissions.length === 0) { container.innerHTML = '<div class="info">¬°Felicidades! Has completado todas las misiones.</div>'; return; } incompleteMissions.forEach(m => { const div = document.createElement('div'); div.className = 'mission-row'; div.innerHTML = `<div style="flex:1"><div style="font-weight:700; color:var(--detective-text)">${m.id}. ${m.title}</div><div style="font-size:1rem; color:var(--detective-accent)">${m.points} ‚≠ê</div></div>`; container.appendChild(div); }); }
            function renderLevel() { const total = getTotalPoints(); const level = getLevelFromPoints(total); const neededForNext = (level.max === Infinity) ? 0 : (level.max - total + 1); const progressPct = (level.max === Infinity) ? 100 : Math.min(100, Math.round(((total - level.min) / (level.max - level.min)) * 100)); document.getElementById('nivel-content').innerHTML = `<div class="info"><strong>Nivel:</strong> ${level.name} (${level.idx})</div><div class="info"><strong>Puntos:</strong> ${total} ‚≠ê</div><div class="info"><strong>Progreso:</strong> ${progressPct}%</div><div style="background:rgba(201, 169, 97, 0.2);border-radius:10px;padding:8px;margin-top:10px"><div style="height:12px;background:linear-gradient(90deg,var(--detective-accent),#e6c277);width:${progressPct}%;border-radius:8px"></div></div>${level.max === Infinity ? '<div class="info" style="margin-top:8px">¬°Nivel m√°ximo!</div>' : `<div class="info" style="margin-top:8px">Para subir: ${neededForNext} ‚≠ê</div>`}`; }
            function renderProgress() { const total = getTotalPoints(); const topTarget = 9500; const pct = Math.min(100, Math.round((total / topTarget) * 100)); document.getElementById('progreso-content').innerHTML = `<div class="info"><strong>Puntos:</strong> ${total} ‚≠ê</div><div class="info"><strong>Progreso Global:</strong> ${pct}%</div><div style="background:rgba(201, 169, 97, 0.2);border-radius:10px;padding:8px;margin-top:10px"><div style="height:12px;background:linear-gradient(90deg,var(--detective-accent),#e6c277);width:${pct}%;border-radius:8px"></div></div><div class="info" style="margin-top:10px"><strong>Misiones:</strong> ${getCompletedCount()}/100</div>`; }
            function renderAnalysis() { const gameStats = JSON.parse(localStorage.getItem(GAME_STATS_KEY) || "{}"); document.getElementById('analisis-stats').innerHTML = `<div class="info"><strong>Juegos jugados:</strong> ${gameStats.gamesPlayed || 0}</div><div class="info"><strong>Juegos ganados:</strong> ${gameStats.gamesWon || 0}</div><div class="info"><strong>Pistas usadas:</strong> ${gameStats.hintsUsed || 0}</div><div class="info"><strong>Mejor tiempo:</strong> ${gameStats.bestTime ? `${gameStats.bestTime}s` : 'N/A'}</div><div class="info"><strong>Racha actual:</strong> ${gameStats.streakDays || 0} d√≠as</div>`; }
            function updateAllDisplays() { renderMissions(); renderLevel(); renderProgress(); renderAnalysis(); }
            function closeAllPanels() { document.querySelectorAll('.panel-box').forEach(p => p.classList.remove('active')); }

            // --- EVENT LISTENERS FOR MISSION SYSTEM (Same as juego1.html) ---
            window.addEventListener('userReady', (e) => { const user = e.detail.user; const userProfile = JSON.parse(localStorage.getItem(USER_PROFILE_KEY) || "{}"); if (!userProfile.originalEmail) { userProfile.originalEmail = user.email; userProfile.nameChangeMissionCompleted = false; localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(userProfile)); } if (!userProfile.nameChangeMissionCompleted) { const hasChangedName = user.displayName && user.displayName !== userProfile.originalEmail; if (hasChangedName) { completeMission(8); userProfile.nameChangeMissionCompleted = true; localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(userProfile)); } } });
            document.getElementById('hamburger-menu').addEventListener('click', () => { document.getElementById('user-dropdown').classList.toggle('active'); });
            document.getElementById('logout-btn').addEventListener('click', () => { import("https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js").then(({ signOut }) => { signOut(window.auth).then(() => window.location.href = 'index.html'); }); });
            window.addEventListener('click', (event) => { if (!event.target.closest('.navbar')) document.getElementById('user-dropdown').classList.remove('active'); const isIcon = event.target.closest('.floating-icons'); const isPanel = event.target.closest('.panel-box'); if (!isIcon && !isPanel) closeAllPanels(); });
            document.getElementById('btn-misiones').addEventListener('click', () => { closeAllPanels(); document.getElementById('panel-misiones').classList.add('active'); renderMissions(); });
            document.getElementById('btn-nivel').addEventListener('click', () => { closeAllPanels(); document.getElementById('panel-nivel').classList.add('active'); renderLevel(); });
            document.getElementById('btn-progreso').addEventListener('click', () => { closeAllPanels(); document.getElementById('panel-progreso').classList.add('active'); renderProgress(); completeMission(38); });
            document.getElementById('btn-analisis').addEventListener('click', () => { closeAllPanels(); document.getElementById('panel-analisis').classList.add('active'); renderAnalysis(); });
            document.querySelectorAll('.close-panel').forEach(btn => { btn.addEventListener('click', (e) => { document.getElementById('panel-' + e.target.getAttribute('data-close')).classList.remove('active'); }); });

            // --- L√ìGICA ESPEC√çFICA DE ESTA FASE DEL JUEGO ---
            const ideaBoard = document.getElementById('idea-board');
            const boardSvg = document.getElementById('board-svg');
            const centralText = document.getElementById('central-text');
            const feedbackMessage = document.getElementById('feedback-message');
            const hintButton = document.getElementById('hint-button');
            const timerDisplay = document.getElementById('timer');
            const musicControlBtn = document.getElementById('music-control-btn');
            const backgroundMusic = document.getElementById('background-music');
            const glowEffect = document.getElementById('glow-effect');
            const completionMessage = document.getElementById('completion-message');
            const selectionCount = document.getElementById('selection-count');

            function startGame() {
                const state = getGameState();
                gameStartTime = Date.now();
                startTimer();
                // Intentar reproducir m√∫sica
                backgroundMusic.play().then(() => {
                    musicControlBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                }).catch(error => {
                    console.log("La reproducci√≥n autom√°tica de m√∫sica fue bloqueada por el navegador.");
                    musicControlBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                });
                
                // Inicializar eventos de clic
                initClickEvents();
                
                // Mezclar las opciones
                shuffleOptions();
            }

            function startTimer() {
                timerInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
                    const minutes = String(Math.floor(elapsed / 60)).padStart(2, '0');
                    const seconds = String(elapsed % 60).padStart(2, '0');
                    timerDisplay.textContent = `Tiempo: ${minutes}:${seconds}`;
                }, 1000);
            }

            function stopTimer() {
                if (timerInterval) {
                    clearInterval(timerInterval);
                    const elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
                    const state = getGameState();
                    state.totalTime += elapsed;
                    saveGameState(state);
                }
            }

            function shuffleOptions() {
                const container = document.getElementById('options-container');
                const options = Array.from(container.querySelectorAll('.option-box'));
                
                // Mezclar el array de opciones
                for (let i = options.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [options[i], options[j]] = [options[j], options[i]];
                }
                
                // Limpiar el contenedor
                container.innerHTML = '';
                
                // Agregar las opciones mezcladas
                options.forEach((option, index) => {
                    // Actualizar el n√∫mero de opci√≥n
                    const numberElement = option.querySelector('.option-number');
                    numberElement.textContent = index + 1;
                    container.appendChild(option);
                });
            }

            function initClickEvents() {
                document.querySelectorAll('.option-box').forEach(option => {
                    option.addEventListener('click', () => selectOption(option));
                });
            }

            function selectOption(option) {
                if (puzzleSolved) return;
                
                const optionType = option.dataset.type;
                
                // Si ya est√° seleccionada, deseleccionarla
                if (option.classList.contains('selected-main') || option.classList.contains('selected-secondary')) {
                    deselectOption(option);
                    return;
                }
                
                // Si no hay idea principal seleccionada y esta es de tipo main
                if (!selectedMain && optionType === 'main') {
                    selectedMain = option;
                    option.classList.add('selected-main');
                    drawConnection(option, 'main');
                    feedbackMessage.textContent = "Idea principal seleccionada. Ahora selecciona 2 ideas secundarias.";
                    feedbackMessage.className = 'feedback-message success';
                }
                // Si ya hay idea principal y esta es de tipo secondary
                else if (selectedMain && optionType === 'secondary' && selectedSecondary.length < 2) {
                    selectedSecondary.push(option);
                    option.classList.add('selected-secondary');
                    drawConnection(option, 'secondary');
                    feedbackMessage.textContent = `Idea secundaria ${selectedSecondary.length}/2 seleccionada.`;
                    feedbackMessage.className = 'feedback-message success';
                    
                    // Si ya se seleccionaron 2 secundarias, verificar si son correctas
                    if (selectedSecondary.length === 2) {
                        setTimeout(() => checkCompletion(), 500);
                    }
                }
                // Si la selecci√≥n es incorrecta
                else {
                    option.classList.add('incorrect');
                    feedbackMessage.textContent = "Selecci√≥n incorrecta. Int√©ntalo de nuevo.";
                    feedbackMessage.className = 'feedback-message error';
                    
                    setTimeout(() => {
                        option.classList.remove('incorrect');
                    }, 1000);
                }
                
                updateSelectionCounter();
            }

            function deselectOption(option) {
                if (option.classList.contains('selected-main')) {
                    selectedMain = null;
                    option.classList.remove('selected-main');
                    removeConnection(option.id);
                } else if (option.classList.contains('selected-secondary')) {
                    selectedSecondary = selectedSecondary.filter(o => o !== option);
                    option.classList.remove('selected-secondary');
                    removeConnection(option.id);
                }
                
                updateSelectionCounter();
            }

            function updateSelectionCounter() {
                const total = (selectedMain ? 1 : 0) + selectedSecondary.length;
                selectionCount.textContent = total;
            }

            function drawConnection(option, type) {
                const optionRect = option.getBoundingClientRect();
                const textRect = centralText.getBoundingClientRect();
                const boardRect = ideaBoard.getBoundingClientRect();
                
                // Calcular puntos de conexi√≥n
                const optionCenterX = optionRect.left + optionRect.width / 2 - boardRect.left;
                const optionCenterY = optionRect.top + optionRect.height / 2 - boardRect.top;
                const textCenterX = textRect.left + textRect.width / 2 - boardRect.left;
                const textCenterY = textRect.top + textRect.height / 2 - boardRect.top;
                
                // Crear l√≠nea SVG
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('id', `line-${option.id}`);
                line.setAttribute('x1', optionCenterX);
                line.setAttribute('y1', optionCenterY);
                line.setAttribute('x2', textCenterX);
                line.setAttribute('y2', textCenterY);
                line.setAttribute('class', `connection-line ${type}`);
                
                // Agregar al SVG
                boardSvg.appendChild(line);
                
                // Guardar referencia
                connections[option.id] = line;
            }

            function removeConnection(optionId) {
                if (connections[optionId]) {
                    boardSvg.removeChild(connections[optionId]);
                    delete connections[optionId];
                }
            }

            function checkCompletion() {
                // Verificar si las selecciones son correctas
                const correctMain = selectedMain && selectedMain.dataset.type === 'main';
                const correctSecondary = selectedSecondary.length === 2 && 
                    selectedSecondary.every(o => o.dataset.type === 'secondary');
                
                if (correctMain && correctSecondary) {
                    completePuzzle();
                } else {
                    feedbackMessage.textContent = "Algunas selecciones son incorrectas. Int√©ntalo de nuevo.";
                    feedbackMessage.className = 'feedback-message error';
                    
                    // Resetear selecciones incorrectas
                    setTimeout(() => {
                        if (selectedMain && selectedMain.dataset.type !== 'main') {
                            deselectOption(selectedMain);
                        }
                        selectedSecondary.forEach(o => {
                            if (o.dataset.type !== 'secondary') {
                                deselectOption(o);
                            }
                        });
                    }, 1500);
                }
            }

            function completePuzzle() {
                puzzleSolved = true;
                
                // Mostrar mensaje de completado
                completionMessage.classList.add('show');
                
                // Activar efecto de brillo
                glowEffect.classList.add('active');
                
                // Actualizar estad√≠sticas del juego
                const gameStats = JSON.parse(localStorage.getItem(GAME_STATS_KEY) || "{}");
                gameStats.gamesPlayed = (gameStats.gamesPlayed || 0) + 1;
                gameStats.gamesWon = (gameStats.gamesWon || 0) + 1;
                const elapsed = Math.floor((Date.now() - gameStartTime) / 1000);
                if (!gameStats.bestTime || elapsed < gameStats.bestTime) {
                    gameStats.bestTime = elapsed;
                }
                localStorage.setItem(GAME_STATS_KEY, JSON.stringify(gameStats));
                
                // Completar misiones relevantes
                completeMission(5); // Gana tu primer juego
                if (!hintUsed) {
                    completeMission(37); // Gana un juego sin usar pistas
                }
                if (elapsed < 120) {
                    completeMission(18); // Gana un juego en menos de 2 minutos
                }
                
                // Redirigir despu√©s de la animaci√≥n
                setTimeout(() => {
                    stopTimer();
                    window.location.href = 'felicitacionesjuego1.html';
                }, 3000);
            }

            function useHint() {
                const state = getGameState();
                if (state.hintsUsed || puzzleSolved) return;
                
                state.hintsUsed = true;
                saveGameState(state);
                completeMission(6); // Completar misi√≥n de usar pista
                
                // Resaltar la idea principal correcta
                const mainOption = document.querySelector('.option-box[data-type="main"]:not(.selected-main)');
                if (mainOption) {
                    mainOption.style.boxShadow = '0 0 20px rgba(142, 68, 173, 0.8)';
                    setTimeout(() => {
                        mainOption.style.boxShadow = '';
                    }, 3000);
                }
                
                hintButton.disabled = true;
            }

            // --- EVENT LISTENERS DEL JUEGO ---
            hintButton.addEventListener('click', useHint);

            musicControlBtn.addEventListener('click', () => {
                if (backgroundMusic.paused) {
                    backgroundMusic.play();
                    musicControlBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                } else {
                    backgroundMusic.pause();
                    musicControlBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                }
            });

            // --- INICIALIZACI√ìN ---
            initMissions(); initUserProfile(); initGameStats(); updateAllDisplays();
            startGame();
            console.log("Fase 5 del juego inicializada.");
        });
    </script>
</body>
</html>
